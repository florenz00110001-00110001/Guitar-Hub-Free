<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Guitar Hub Trainer - Ultimate Edition</title>
<style>
  :root{
    --bg:#111;
    --panel:#000;
    --accent:orange;
    --muted:#222;
    --text:#fff;
    --card:#1a1a1a;
    --white:#fff;
  }
  *{box-sizing:border-box}
  /* Prevent copying of main UI texts */
  .no-select { user-select: none; -webkit-user-select:none; -ms-user-select:none; -moz-user-select:none; }

  body{
    margin:0;
    font-family:Arial, sans-serif;
    background:var(--bg);
    color:var(--text);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    text-align:center;
    transition:background 0.25s,color 0.25s;
  }
  header{
    width:100%;
    background:var(--panel);
    padding:10px 18px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    position:fixed;
    top:0; left:0;
    z-index:1000;
    box-shadow:0 2px 8px rgba(0,0,0,0.6);
  }
  .logo{display:flex;align-items:center;font-weight:700;font-size:1.25rem;color:var(--white)}
  .logo .guitar{color:var(--white)}
  .logo .hub{color:black;background:orange;padding:4px 8px;border-radius:6px;margin-left:8px}
  .controls{display:flex;gap:8px;align-items:center}
  main{padding:110px 14px 40px; max-width:1100px;margin:0 auto;}
  button{padding:10px 16px;border-radius:8px;border:none;background:var(--accent);color:#000;font-weight:600;cursor:pointer;transition:all 0.2s}
  button:hover{opacity:0.95}
  .back-btn{background:#444;color:#fff}
  .ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:8px}
  .card{background:var(--muted);padding:14px;border-radius:10px;margin:12px 0;box-shadow:0 6px 16px rgba(0,0,0,0.6);transition:all 0.3s ease}
  .hidden{display:none;opacity:0;transition:opacity 0.3s ease}
  .visible{display:block;opacity:1;transition:opacity 0.3s ease}
  .chord-grid{display:flex;flex-wrap:wrap;gap:14px;justify-content:center;padding:8px}
  .chord-card{width:120px;background:#222;padding:10px;border-radius:10px;box-shadow:0 6px 14px rgba(0,0,0,0.6);text-align:center;transition:transform 0.2s}
  .chord-card:hover{transform:scale(1.05)}
  .chord-card img{width:100px;height:auto;display:block;margin:8px auto;object-fit:contain}
  .timer{font-weight:700;color:gold;font-size:1.2rem;margin:8px}
  #quiz-options button{display:block;width:100%;margin:8px 0;background:#333;color:#fff;padding:10px;border-radius:8px}
  input[type="text"],input[type="email"],input[type="password"],textarea,select{
    width:100%;padding:10px;border-radius:8px;border:none;background:#1b1b1b;color:#fff;margin-bottom:10px;font-size:1rem;
  }
  .row{display:flex;gap:8px;align-items:center}
  .row .small{width:48px;padding:8px}
  .song{padding:10px;border-radius:8px;background:#171717;margin:8px 0;text-align:left;color:var(--white)}
  .song .title{font-weight:700}
  .song .meta{font-size:0.9rem;color:#ddd;margin-top:6px}
  #burger{font-size:1.4rem;background:none;border:none;color:#fff;cursor:pointer;padding:6px 8px}
  #account-panel{position:fixed;top:58px;right:12px;width:320px;background:#141414;padding:12px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,0.6);display:none;z-index:1100;color:var(--white)}
  #account-panel h4{margin:0 0 8px 0}
  #strum-highlight{font-size:1.5rem;margin:12px 0;letter-spacing:6px;color:var(--white)}
  .no-wrap { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .metronome-ball { width:16px; height:16px; border-radius:50%; background:orange; display:inline-block; vertical-align:middle; margin-left:10px; transform-origin:center; transition:transform 0.05s linear; }
  .badge { display:inline-block; padding:6px 8px; border-radius:8px; background:#333; color:#fff; margin-right:6px; font-weight:700; font-size:0.9rem; }
  .admin-badge { background:gold; color:#000; }

  @media (max-width:900px){
    main{padding:120px 10px 40px}
  }
  @media (max-width:600px){
    .logo{font-size:1.05rem}
    main{padding:120px 10px}
    .chord-card{width:96px}
  }
  /* Force specific UI text remain white regardless of mode */
  .force-white { color: var(--white) !important; }

  /* Light-mode tweaks but keep selected UI white */
  .light-mode{background:#fff;color:#000}
  .light-mode .logo .hub{background:orange;color:black}
  .light-mode button{color:#000}
  .light-mode .force-white { color: var(--white) !important; }

  /* disable copy for core UI */
  .no-copy { user-select:none; -webkit-user-select:none; -ms-user-select:none; -moz-user-select:none; }
</style>
</head>
<body>

<header class="no-copy">
  <div class="logo no-select">
    <span class="guitar">Guitar</span><span class="hub">Hub-Ultimate</span>
  </div>
  <div class="controls">
    <button id="dark-toggle" title="Toggle theme">üåó</button>
    <button id="burger" aria-label="Open account menu">‚ò∞</button>
  </div>
</header>

<div id="account-panel" aria-hidden="true" class="no-copy">
  <h4>Account</h4>
  <p id="account-email">Not signed in</p>
  <div style="display:flex;gap:8px;margin-top:8px;">
    <button id="show-dashboard" class="ghost">Dashboard</button>
    <button id="signout-btn" class="ghost">Sign out</button>
  </div>
  <hr style="margin:10px 0;border-color:#222">
  <button id="change-pass" class="ghost" style="width:100%;margin-bottom:8px">Change password</button>
  <button id="delete-account" class="ghost" style="width:100%;color:#ff6666">Delete account</button>
  <div style="margin-top:10px">
    <div id="badges-container"></div>
  </div>
</div>

<main>
  <!-- LOGIN -->
  <div id="login-screen" class="card">
    <h1 style="margin:0 0 8px 0;color:var(--white)" class="force-white no-copy">Login</h1>
    <input id="email" type="email" placeholder="Email" autocomplete="username">
    <div class="row" style="align-items:center">
      <input id="password" type="password" placeholder="Password" autocomplete="current-password" style="flex:1">
      <button id="toggle-pass" class="ghost small" title="Show/Hide">üëÅÔ∏è</button>
    </div>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:8px">
      <button id="login-btn">Login</button>
      <button id="signup-btn" class="ghost">Sign up</button>
    </div>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:10px">
      <button id="continue-btn" class="ghost">Continue without account</button>
    </div>
    <p style="margin:12px 0 0 0"><a href="#" id="forgot-link" style="color:#ddd">Forgot password?</a></p>
    <p id="auth-msg" style="color:#f88;margin-top:8px"></p>
  </div>

  <!-- MAIN MENU -->
  <div id="main-menu" class="card hidden no-copy">
    <h2 style="margin-top:0;color:var(--white)" class="force-white">Main Menu</h2>
    <div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center">
      <button id="btn-chords">View Chords</button>
      <button id="btn-practice">Practice Chords</button>
      <button id="btn-strum">Practice Strum</button>
      <button id="btn-quiz">Chord Recognition Quiz</button>
      <button id="btn-learn-songs" class="ghost">Learn Songs</button>
      <button id="btn-tune" class="ghost">Tune with GuitarTuna</button>
      <button id="btn-metronome" class="ghost">Metronome</button>
      <button id="btn-leaderboard" class="ghost">Leaderboard</button>
      <button id="btn-admin" class="ghost">Admin Panel</button>
    </div>
  </div>

  <!-- CHORDS -->
  <div id="chords" class="card hidden">
    <h2 style="margin-top:0;color:var(--white)" class="force-white">Basic Chords</h2>
    <div class="chord-grid" id="chord-grid"></div>
    <button class="back-btn" id="back-chords">‚¨Ö Back</button>
  </div>

  <!-- PRACTICE -->
  <div id="practice" class="card hidden">
    <h2 style="margin-top:0;color:var(--white)" class="force-white">Practice Chords (Random)</h2>
    <div id="practice-chord-display" style="font-size:2rem;margin:16px;color:var(--white)"></div>
    <div style="display:flex;gap:8px;justify-content:center">
      <button id="next-chord">Next Chord</button>
      <button id="play-chord" class="ghost">Play Chord</button>
    </div>
    <p id="practice-feedback" style="margin-top:10px;color:var(--white)"></p>
    <button class="back-btn" id="back-practice">‚¨Ö Back</button>
  </div>

  <!-- STRUM -->
  <div id="strum" class="card hidden">
    <h2 style="margin-top:0;color:var(--white)" class="force-white">Practice Strum</h2>
    <input id="song-search" type="text" placeholder="Search songs..." style="margin-bottom:12px;color:var(--white);background:#222"/>
    <div id="song-list" style="max-height:360px;overflow:auto;padding-right:6px"></div>
    <div style="margin-top:12px">
      <p id="song-pattern" style="font-weight:700;color:var(--white)" class="force-white">Pattern: ‚Äî</p>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center;margin-bottom:8px">
        <button id="start-mic" class="ghost">Start Mic Test</button>
        <button id="start-strum-practice" class="ghost">Start Strum Practice</button>
        <button id="stop-mic" class="ghost">Stop Mic</button>
        <span id="metronome-display" style="margin-left:8px" class="force-white">Metronome:</span>
        <div id="metronome-ball" class="metronome-ball" aria-hidden="true"></div>
      </div>
      <p id="strum-feedback" style="margin-top:8px;color:var(--white)" class="force-white"></p>
      <div id="strum-highlight" class="force-white"></div>
    </div>
    <button class="back-btn" id="back-strum">‚¨Ö Back</button>
  </div>

  <!-- QUIZ -->
  <div id="quiz" class="card hidden">
    <h2 style="margin-top:0;color:var(--white)" class="force-white">Chord Recognition Quiz</h2>
    <div style="margin-bottom:12px">
      <button id="start-quiz">Start Quiz</button>
      <button id="reset-quiz" class="ghost" style="display:none">Reset</button>
    </div>
    <div id="quiz-area" class="hidden" style="text-align:center">
      <div class="timer" id="timer">5</div>
      <div id="quiz-image" style="margin:8px"></div>
      <div id="quiz-options" style="max-width:420px;margin:0 auto;text-align:center"></div>
      <p id="quiz-progress" style="margin-top:8px"></p>
    </div>
    <div id="quiz-result" class="hidden" style="margin-top:12px;font-weight:700"></div>
    <button class="back-btn" id="back-quiz">‚¨Ö Back</button>
  </div>

  <!-- LEADERBOARD -->
  <div id="leaderboard" class="card hidden">
    <h2 style="margin-top:0;color:var(--white)" class="force-white">Leaderboard</h2>
    <div id="leaderboard-list"></div>
    <button class="back-btn" id="back-leaderboard">‚¨Ö Back</button>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard" class="card hidden">
    <h2 style="margin-top:0;color:var(--white)" class="force-white">Dashboard</h2>
    <p>Strum Accuracy: <span id="dash-strum">0%</span></p>
    <p>Quiz Score History: <span id="dash-quiz">N/A</span></p>
    <p>Streak: <span id="dash-streak">0</span></p>
    <div id="user-badges"></div>
    <button class="back-btn" id="back-dashboard">‚¨Ö Back</button>
  </div>

  <!-- ADMIN -->
  <div id="admin-panel" class="card hidden" style="margin-top:20px;">
    <h2>Admin Controls</h2>

    <h3>Add / Edit Song</h3>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <input id="admin-song-name" placeholder="Song name">
      <input id="admin-song-author" placeholder="Author">
      <input id="admin-song-capo" placeholder="Capo (e.g. 4 or empty)">
      <input id="admin-song-chords" placeholder="Chords (space-separated)">
      <input id="admin-song-pattern" placeholder="Pattern (eg. ‚Üì ‚Üì ‚Üë ‚Üë)">
    </div>
    <div style="display:flex;gap:8px;margin-top:8px;">
      <button id="admin-add-song">Add Song</button>
      <button id="admin-save-edit" class="ghost">Save Edit</button>
      <button id="admin-bulk-add" class="ghost">Bulk Add (JSON)</button>
      <button id="admin-refresh-songs" class="ghost">Refresh Songs</button>
    </div>

    <h3 style="margin-top:12px">Song List (Admin)</h3>
    <div id="admin-song-list" style="max-height:240px;overflow:auto"></div>

    <h3 style="margin-top:12px">Manual User Override</h3>
    <input id="override-user" type="text" placeholder="Enter user email">
    <input id="override-username" type="text" placeholder="Set username">
    <input id="override-streak" type="number" placeholder="Set streak">
    <input id="override-level" type="text" placeholder="Set level">
    <input id="override-highscore" type="number" placeholder="Set high score">
    <div style="display:flex;gap:8px;margin-top:8px;">
      <button id="apply-override">Apply Changes</button>
      <button id="admin-grant-admin" class="ghost">Grant Admin Badge</button>
    </div>
  </div>

  <!-- HIDDEN: Templates / debug info -->
  <div id="debug" class="card hidden" style="display:none"></div>
</main>

<!-- Firebase, Web Audio, and App Logic -->
<script type="module">
  // --- Firebase SDK (CDN) ---
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail, onAuthStateChanged, updatePassword } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
  import { getFirestore, collection, getDocs, doc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

  // --- Firebase config (your project) ---
  const firebaseConfig = {
    apiKey: "AIzaSyDkMmF78dFu2dmuzka6xuwpLRD5NRCCJtY",
    authDomain: "guitar-hub-25dfa.firebaseapp.com",
    projectId: "guitar-hub-25dfa",
    storageBucket: "guitar-hub-25dfa.firebasestorage.app",
    messagingSenderId: "36479296604",
    appId: "1:36479296604:web:5dbcfb2aec3912f8ba7299",
    measurementId: "G-N4HZW695LF"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // --- Cached DOM ---
  const loginScreen = document.getElementById("login-screen");
  const mainMenu = document.getElementById("main-menu");
  const chordsPanel = document.getElementById("chords");
  const practicePanel = document.getElementById("practice");
  const strumPanel = document.getElementById("strum");
  const quizPanel = document.getElementById("quiz");
  const dashboardPanel = document.getElementById("dashboard");
  const leaderboardPanel = document.getElementById("leaderboard");
  const adminPanel = document.getElementById("admin-panel");
  const accountPanel = document.getElementById("account-panel");

  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");
  const authMsg = document.getElementById("auth-msg");
  const burgerBtn = document.getElementById("burger");
  const accountEmail = document.getElementById("account-email");
  const badgesContainer = document.getElementById("badges-container");
  const userBadgesDiv = document.getElementById("user-badges");

  const STARTING_CHORDS = ["C","D","E","F","G","A","B","Am","Dm","Em","F#m","Bm","Cmaj7","C#m","G#m","F#","Fsharpm","fsharp","fsharpm"];

  // Hardcoded admin email (only this account gets admin panel access)
  const HARDCODED_ADMIN_EMAIL = "florenzjed12@gmail.com";

  // Utility: element show/hide with fade
  function showPanel(el){ el.classList.remove("hidden"); el.classList.add("visible"); }
  function hidePanel(el){ el.classList.remove("visible"); el.classList.add("hidden"); }

  // Basic navigation: ensure back buttons and main menu buttons work robustly
  function goToMain(){ hidePanel(loginScreen); hidePanel(chordsPanel); hidePanel(practicePanel); hidePanel(strumPanel); hidePanel(quizPanel); hidePanel(dashboardPanel); hidePanel(leaderboardPanel); hidePanel(adminPanel); showPanel(mainMenu); accountPanel.style.display='none'; }
  function goBack(){ goToMain(); }

  // attach main menu buttons
  document.getElementById("btn-chords").addEventListener("click", ()=>{ hidePanel(loginScreen); hidePanel(mainMenu); showPanel(chordsPanel); });
  document.getElementById("btn-practice").addEventListener("click", ()=>{ hidePanel(loginScreen); hidePanel(mainMenu); showPanel(practicePanel); });
  document.getElementById("btn-strum").addEventListener("click", ()=>{ hidePanel(loginScreen); hidePanel(mainMenu); showPanel(strumPanel); });
  document.getElementById("btn-quiz").addEventListener("click", ()=>{ hidePanel(loginScreen); hidePanel(mainMenu); showPanel(quizPanel); });
  document.getElementById("btn-learn-songs").addEventListener("click", ()=>{ alert("Learn songs coming soon!"); });
  document.getElementById("btn-tune").addEventListener("click", ()=>{ window.open('https://www.guitartuna.com/','_blank'); });
  document.getElementById("btn-metronome").addEventListener("click", ()=>{ hidePanel(mainMenu); showPanel(strumPanel); });
  document.getElementById("btn-leaderboard").addEventListener("click", ()=>{ hidePanel(mainMenu); loadLeaderboard(); showPanel(leaderboardPanel); });
  document.getElementById("btn-admin").addEventListener("click", ()=>{ hidePanel(mainMenu); showPanel(adminPanel); loadAdminSongs(); });

  // back buttons
  document.getElementById("back-chords").addEventListener("click", goBack);
  document.getElementById("back-practice").addEventListener("click", goBack);
  document.getElementById("back-strum").addEventListener("click", goBack);
  document.getElementById("back-quiz").addEventListener("click", goBack);
  document.getElementById("back-dashboard").addEventListener("click", goBack);
  document.getElementById("back-leaderboard").addEventListener("click", goBack);

  // burger / account
  burgerBtn.addEventListener("click", ()=>{ accountPanel.style.display = accountPanel.style.display === "block" ? "none" : "block"; });

  // toggle password visibility
  document.getElementById("toggle-pass").addEventListener("click", ()=> {
    passwordInput.type = passwordInput.type === "password" ? "text" : "password";
  });

  // Continue without account
  document.getElementById("continue-btn").addEventListener("click", ()=>{
    hidePanel(loginScreen);
    showPanel(mainMenu);
    accountEmail.textContent = "Guest";
  });

  // Auth: sign up, login, signout
  document.getElementById("signup-btn").addEventListener("click", async ()=>{
    const email = emailInput.value.trim();
    const pw = passwordInput.value;
    if(!email || !pw){ authMsg.textContent = "Provide email & password to sign up."; return; }
    try{
      await createUserWithEmailAndPassword(auth, email, pw);
      authMsg.style.color = "#8f8"; authMsg.textContent = "Account created, signed in.";
    }catch(e){ authMsg.style.color="#f88"; authMsg.textContent = e.message; }
  });

  document.getElementById("login-btn").addEventListener("click", async ()=>{
    const email = emailInput.value.trim();
    const pw = passwordInput.value;
    if(!email || !pw){ authMsg.textContent = "Enter email & password to sign in."; authMsg.style.color="#f88"; return; }
    try{
      await signInWithEmailAndPassword(auth, email, pw);
      authMsg.style.color="#8f8"; authMsg.textContent = "Signed in.";
    }catch(e){ authMsg.style.color="#f88"; authMsg.textContent = e.message; }
  });

  document.getElementById("signout-btn").addEventListener("click", async ()=>{
    try{ await signOut(auth); loginScreen.classList.remove("hidden"); showPanel(loginScreen); hidePanel(mainMenu); accountPanel.style.display='none'; accountEmail.textContent='Not signed in'; authMsg.textContent=''; }
    catch(e){ console.error(e); }
  });

  document.getElementById("forgot-link").addEventListener("click", async (ev)=>{
    ev.preventDefault();
    const email = emailInput.value.trim();
    if(!email){ authMsg.style.color="#f88"; authMsg.textContent = "Enter your email then click Reset."; return; }
    try{
      await sendPasswordResetEmail(auth, email);
      authMsg.style.color="#8f8"; authMsg.textContent = "Reset email sent (check inbox).";
    }catch(e){ authMsg.style.color="#f88"; authMsg.textContent = e.message; }
  });

  document.getElementById("change-pass").addEventListener("click", async ()=>{
    const newPass = prompt("Enter new password (min 6 chars):");
    if(!newPass) return;
    if(!auth.currentUser){ alert("Sign in required to change password."); return; }
    try{
      await updatePassword(auth.currentUser, newPass);
      alert("Password updated.");
    }catch(e){ alert(e.message); }
  });

  // On auth state change: show/hide admin panel based on hardcoded admin email
  onAuthStateChanged(auth, (user)=>{
    if(user){
      accountEmail.textContent = user.email || "User";
      hidePanel(loginScreen);
      showPanel(mainMenu);
      authMsg.textContent = "";
      // show admin if matches HARDCODED_ADMIN_EMAIL
      if(user.email === HARDCODED_ADMIN_EMAIL) {
        document.getElementById("btn-admin").style.display = "inline-block";
        // show admin badge in account
        setTimeout(()=>renderBadges([{id:'admin',name:'Admin',cls:'admin-badge'}]),0);
      } else {
        document.getElementById("btn-admin").style.display = "none";
      }
      ensureUserInLeaderboard(user);
      loadUserDashboard(user);
    } else {
      accountEmail.textContent = "Not signed in";
      // hide admin btn
      document.getElementById("btn-admin").style.display = "none";
      showPanel(loginScreen);
      hidePanel(mainMenu);
    }
  });

  // --- Chords / Images ---
  // Map chord names to file names in image/ folder. The user requested single-folder 'image' (no 's').
  function chordToFilename(chord){
    // normalize (C# => csharp, F#m => fsharpm, etc.)
    const lower = chord.toLowerCase().replace(/\+/g,'plus').replace(/#/g,'sharp').replace(/\s+/g,'').replace(/m$/,'m');
    // attempt various naming conventions
    const attempts = [
      lower + ".png",
      lower + "m.png",
      lower.replace('minor','m') + ".png",
    ];
    return attempts[0]; // prefer first; image onerror falls back to placeholder
  }

  // populate chord grid
  const chordGrid = document.getElementById("chord-grid");
  function populateChordGrid(){
    chordGrid.innerHTML = "";
    const chords = STARTING_CHORDS;
    chords.forEach(chord=>{
      const card = document.createElement("div");
      card.className = "chord-card no-select";
      const fname = chordToFilename(chord);
      card.innerHTML = `<div style="font-weight:700;color:var(--white)">${chord}</div>
        <img src="image/${fname}" alt="${chord} chord" onerror="this.onerror=null;this.src='image/placeholder.png'">`;
      chordGrid.appendChild(card);
    });
  }
  populateChordGrid();

  // --- Practice ---
  const practiceChords = ["C","D","E","F","G","A","B","Am","Dm","Em","F#m","Bm","Cmaj7","C#m","G#m"];
  let currentPracticeChord = null;
  document.getElementById("next-chord").addEventListener("click", ()=>{
    currentPracticeChord = practiceChords[Math.floor(Math.random()*practiceChords.length)];
    document.getElementById("practice-chord-display").textContent = currentPracticeChord;
    // show image if exists
    const imgName = chordToFilename(currentPracticeChord);
    const feedback = document.getElementById("practice-feedback");
    feedback.innerHTML = `<img src="image/${imgName}" style="width:180px" onerror="this.onerror=null;this.style.display='none'">`;
  });

  // play chord placeholder (you can integrate WebAudio samples)
  document.getElementById("play-chord").addEventListener("click", ()=>{
    const chord = currentPracticeChord || practiceChords[0];
    const fb = document.getElementById("practice-feedback");
    fb.textContent = `Playing ${chord} (placeholder audio).`;
    // TODO: integrate WebAudio/samples
  });

  // --- Songs storage & UI ---
  // Songs will be stored in Firestore collection "songs". We'll also keep a local cache for UI.
  let songsCache = [];

  async function loadSongs(){
    // Fetch songs collection
    try{
      const snap = await getDocs(collection(db,"songs"));
      songsCache = [];
      snap.forEach(d=>songsCache.push({id:d.id, ...d.data()}));
      renderSongs();
      renderAdminSongList();
    }catch(e){
      console.error("Load songs error", e);
    }
  }

  function renderSongs(filter=""){
    const songList = document.getElementById("song-list");
    songList.innerHTML = "";
    const q = (filter||"").trim().toLowerCase();
    songsCache.forEach(s=>{
      if(q && !s.name.toLowerCase().includes(q) && !s.author.toLowerCase().includes(q)) return;
      const div = document.createElement("div");
      div.className = "song";
      const capoText = s.capo ? `(Capo ${s.capo})` : "";
      div.innerHTML = `<div class="title no-select">${s.name} ${capoText}</div>
        <div class="meta">Author: ${s.author} <br> Chords: ${s.chords} <br> Pattern: ${s.pattern}</div>
        <div style="margin-top:8px">
          <button class="ghost select-song-btn" data-id="${s.id}">Select</button>
        </div>`;
      songList.appendChild(div);
    });
    // attach select handlers
    Array.from(document.getElementsByClassName("select-song-btn")).forEach(btn=>{
      btn.addEventListener("click", (ev)=>{
        const id = btn.getAttribute("data-id");
        selectSongById(id);
      });
    });
  }

  function renderAdminSongList(){
    const list = document.getElementById("admin-song-list");
    list.innerHTML = "";
    songsCache.forEach(s=>{
      const d = document.createElement("div");
      d.style.borderBottom="1px solid #222";
      d.style.padding="8px";
      d.innerHTML = `<strong>${s.name}</strong> - ${s.author} <div style="margin-top:6px">
        <button class="ghost edit-song" data-id="${s.id}">Edit</button>
        <button class="ghost delete-song" data-id="${s.id}">Delete</button>
      </div>`;
      list.appendChild(d);
    });
    Array.from(list.getElementsByClassName("edit-song")).forEach(b=>{
      b.addEventListener("click", ()=> adminEditSong(b.getAttribute("data-id")));
    });
    Array.from(list.getElementsByClassName("delete-song")).forEach(b=>{
      b.addEventListener("click", async ()=>{
        const id = b.getAttribute("data-id");
        if(!confirm("Delete song?")) return;
        try{ await deleteDoc(doc(db,"songs",id)); await loadSongs(); alert("Deleted"); } catch(e){ alert("Delete failed: "+e.message); }
      });
    });
  }

  // select song flow
  function selectSongById(id){
    const s = songsCache.find(x=>x.id===id);
    if(!s) return;
    document.getElementById("song-pattern").textContent = `Pattern: ${s.pattern} ‚Äî Chords: ${s.chords}`;
    document.getElementById("strum-feedback").textContent = "";
    currentPattern = (s.pattern && s.pattern.split(/\s+/)) || ["‚Üì","‚Üì","‚Üë","‚Üì"];
    currentStrumIndex = 0;
    highlightStrum();
    alert(`Selected ${s.name}`);
  }

  // song search
  const songSearch = document.getElementById("song-search");
  songSearch && songSearch.addEventListener("input", ()=> renderSongs(songSearch.value));

  // Admin: Add song
  document.getElementById("admin-add-song").addEventListener("click", async ()=>{
    const name = document.getElementById("admin-song-name").value.trim();
    const author = document.getElementById("admin-song-author").value.trim() || "Unknown";
    const capo = document.getElementById("admin-song-capo").value.trim();
    const chords = document.getElementById("admin-song-chords").value.trim();
    const pattern = document.getElementById("admin-song-pattern").value.trim() || "‚Üì ‚Üì ‚Üë ‚Üë";
    if(!name){ alert("Name required"); return; }
    try{
      const docRef = await addDoc(collection(db,"songs"),{ name, author, capo, chords, pattern });
      await loadSongs();
      alert("Song added");
    }catch(e){ alert("Add failed: "+e.message); }
  });

  // Admin: Edit song - populate fields
  let currentlyEditingSongId = null;
  function adminEditSong(id){
    const s = songsCache.find(x=>x.id===id);
    if(!s) return;
    currentlyEditingSongId = id;
    document.getElementById("admin-song-name").value = s.name;
    document.getElementById("admin-song-author").value = s.author;
    document.getElementById("admin-song-capo").value = s.capo || "";
    document.getElementById("admin-song-chords").value = s.chords || "";
    document.getElementById("admin-song-pattern").value = s.pattern || "";
    // scroll to admin panel
    adminPanel.scrollIntoView({behavior:"smooth"});
  }

  document.getElementById("admin-save-edit").addEventListener("click", async ()=>{
    if(!currentlyEditingSongId){ alert("No song selected to edit"); return; }
    const id = currentlyEditingSongId;
    const name = document.getElementById("admin-song-name").value.trim();
    const author = document.getElementById("admin-song-author").value.trim();
    const capo = document.getElementById("admin-song-capo").value.trim();
    const chords = document.getElementById("admin-song-chords").value.trim();
    const pattern = document.getElementById("admin-song-pattern").value.trim();
    try{
      await updateDoc(doc(db,"songs",id),{ name, author, capo, chords, pattern });
      await loadSongs();
      alert("Saved");
      currentlyEditingSongId = null;
    }catch(e){ alert("Save failed: "+e.message); }
  });

  // Admin: bulk add (prompt JSON)
  document.getElementById("admin-bulk-add").addEventListener("click", async ()=>{
    const json = prompt("Paste JSON array of songs ([{name,author,capo,chords,pattern},...])");
    if(!json) return;
    try{
      const arr = JSON.parse(json);
      if(!Array.isArray(arr)) throw new Error("Not array");
      for(const s of arr){
        await addDoc(collection(db,"songs"), { name:s.name||"Untitled", author:s.author||"Unknown", capo:s.capo||"", chords:s.chords||"", pattern:s.pattern||"‚Üì ‚Üì ‚Üë ‚Üë" });
      }
      await loadSongs();
      alert("Bulk add completed");
    }catch(e){ alert("Bulk add error: "+e.message); }
  });

  document.getElementById("admin-refresh-songs").addEventListener("click", ()=> loadSongs());

  // --- Leaderboard & dashboard ---
  async function ensureUserInLeaderboard(user){
    if(!user) return;
    // check if user already exists by email as displayName. We'll store doc keyed by uid
    const q = query(collection(db,"leaderboard"));
    const snap = await getDocs(q);
    let docId = null;
    snap.forEach(d=>{ if(d.data().uid === user.uid) docId = d.id; });
    if(!docId){
      // create
      await addDoc(collection(db,"leaderboard"), { uid:user.uid, displayName:user.email.split('@')[0], highScore:0, lastPlayed: Date.now(), level:"Beginner", streak:0, username: user.email.split('@')[0] });
    }
  }

  async function loadLeaderboard(){
    const container = document.getElementById("leaderboard-list");
    container.innerHTML = "Loading...";
    try{
      const q = query(collection(db,"leaderboard"), orderBy("highScore","desc"), limit(50));
      const snap = await getDocs(q);
      container.innerHTML = "";
      snap.forEach(d=>{
        const data = d.data();
        const el = document.createElement("div");
        el.className = "song";
        el.innerHTML = `<div style="display:flex;justify-content:space-between"><div><strong>${data.username||data.displayName||'anon'}</strong> <small style="color:#ccc">(${data.level||'‚Äî'})</small></div><div>${data.highScore||0}</div></div>`;
       container.appendChild(el);
      });
    }catch(e){ container.innerHTML = "Load failed: "+e.message; }
  }

  async function loadUserDashboard(user){
    if(!user) return;
    // fetch leaderboard entry for uid
    const snap = await getDocs(collection(db,"leaderboard"));
    let entry = null; let entryId=null;
    snap.forEach(d=>{ if(d.data().uid === user.uid){ entry = d.data(); entryId = d.id; }});
    if(entry){
      document.getElementById("dash-strum").textContent = (entry.strumAccuracy||0) + "%";
      document.getElementById("dash-quiz").textContent = (entry.quizHistory ? entry.quizHistory.join(", ") : "N/A");
      document.getElementById("dash-streak").textContent = entry.streak || 0;
      renderUserBadges(entry);
    }
  }

  function renderUserBadges(entry){
    userBadgesDiv.innerHTML = "";
    const badges = entry && entry.badges ? entry.badges : [];
    badges.forEach(b=>{
      const el = document.createElement("span");
      el.className = "badge";
      if(b === "Admin") el.classList.add("admin-badge");
      el.textContent = b;
      userBadgesDiv.appendChild(el);
    });
  }

  // Admin override functions
  document.getElementById("apply-override").addEventListener("click", async ()=>{
    const email = document.getElementById("override-user").value.trim();
    const username = document.getElementById("override-username").value.trim() || email.split('@')[0];
    const streak = parseInt(document.getElementById("override-streak").value)||0;
    const level = document.getElementById("override-level").value || "Beginner";
    const highScore = parseInt(document.getElementById("override-highscore").value)||0;
    if(!email){ alert("Enter email"); return; }
    try{
      // find by email (username)
      const snap = await getDocs(collection(db,"leaderboard"));
      let foundId = null;
      snap.forEach(d=>{ if(d.data().username === username || d.data().displayName === email.split('@')[0]) foundId = d.id; });
      if(foundId){
        await updateDoc(doc(db,"leaderboard",foundId), { streak, level, highScore, lastPlayed: Date.now(), username });
        alert("User updated");
      } else {
        await setDoc(doc(db,"leaderboard",username), { uid:null, username, displayName: username, streak, level, highScore, lastPlayed: Date.now() });
        alert("User created");
      }
    }catch(e){ alert("Override failed: "+e.message); }
  });

  document.getElementById("admin-grant-admin").addEventListener("click", async ()=>{
    const email = document.getElementById("override-user").value.trim();
    if(!email) { alert("Enter user email"); return; }
    // Find leaderboard entry and update badges
    const snap = await getDocs(collection(db,"leaderboard"));
    let foundId=null;
    snap.forEach(d=>{ if(d.data().username===email.split('@')[0] || d.data().displayName===email.split('@')[0]) foundId=d.id; });
    if(foundId){
      const ref = doc(db,"leaderboard",foundId);
      await updateDoc(ref, { badges: ["Admin"] });
      alert("Admin badge assigned");
    } else {
      alert("User not found in leaderboard; create them first");
    }
  });

  // --- Quiz logic ---
  const quizChords = ["C","D","E","F","G","A","B","Am","Dm","Em","F#m","Bm","Cmaj7","C#m","G#m"];
  let quizScore = 0;
  let quizCount = 0;
  const quizTotal = 10;
  const quizArea = document.getElementById("quiz-area");
  const quizResult = document.getElementById("quiz-result");
  const quizImage = document.getElementById("quiz-image");
  const quizOptions = document.getElementById("quiz-options");
  const timerEl = document.getElementById("timer");
  let quizTimer;
  let currentQuizChord;

  document.getElementById("start-quiz").addEventListener("click", ()=>{
    quizScore = 0; quizCount = 0;
    quizResult.classList.add("hidden");
    quizArea.classList.remove("hidden");
    nextQuizChord();
  });

  function nextQuizChord(){
    if(quizCount >= quizTotal){
      quizArea.classList.add("hidden");
      quizResult.classList.remove("hidden");
      quizResult.textContent = `Quiz Completed! Score: ${quizScore}/${quizTotal}`;
      // record to leaderboard
      recordQuizResult(quizScore);
      return;
    }
    currentQuizChord = quizChords[Math.floor(Math.random()*quizChords.length)];
    // show image if present
    const fname = chordToFilename(currentQuizChord);
    quizImage.innerHTML = `<img src="image/${fname}" alt="${currentQuizChord}" style="width:160px" onerror="this.onerror=null;this.style.display='none';quizImage.textContent='${currentQuizChord}'">`;
    quizOptions.innerHTML = "";
    const choices = shuffleArray([...quizChords]).slice(0,4);
    if(!choices.includes(currentQuizChord)) choices[Math.floor(Math.random()*4)] = currentQuizChord;
    choices.forEach(c=>{
      const btn = document.createElement("button");
      btn.textContent = c;
      btn.addEventListener("click", ()=>{
        if(c===currentQuizChord) quizScore++;
        quizCount++;
        clearInterval(quizTimer);
        nextQuizChord();
      });
      quizOptions.appendChild(btn);
    });
    startQuizTimer();
  }

  function startQuizTimer(){
    let time = 7; // default timer (edit here)
    timerEl.textContent = time;
    clearInterval(quizTimer);
    quizTimer = setInterval(()=>{
      time--;
      timerEl.textContent = time;
      if(time<=0){
        clearInterval(quizTimer);
        quizCount++;
        nextQuizChord();
      }
    },1000);
  }

  function shuffleArray(array){ return array.sort(()=>Math.random()-0.5); }

  // record quiz result to leaderboard (append)
  async function recordQuizResult(score){
    const user = auth.currentUser;
    if(!user) return;
    try{
      // find leaderboard doc for uid
      const snap = await getDocs(collection(db,"leaderboard"));
      let foundId=null, data=null;
      snap.forEach(d=>{ if(d.data().uid === user.uid){ foundId=d.id; data=d.data(); }});
      if(foundId){
        const ref = doc(db,"leaderboard",foundId);
        // append quiz history
        const history = data.quizHistory ? [...data.quizHistory] : [];
        history.push(score);
        const newHigh = Math.max(data.highScore||0, score);
        await updateDoc(ref, { quizHistory: history.slice(-10), highScore: newHigh, lastPlayed: Date.now() });
      }
    }catch(e){ console.error("Record quiz failed", e); }
  }

  // --- Strum detection (prototype) ---
  let audioContext, analyser, dataArray, source;
  let currentPattern = ["‚Üì","‚Üì","‚Üë","‚Üì"]; // default
  let currentStrumIndex = 0;
  let hits = 0;
  let totalStrums = 0;
  let strumActive = false;
  const strumFeedback = document.getElementById("strum-feedback");
  const startMicBtn = document.getElementById("start-mic");
  const startStrumPracticeBtn = document.getElementById("start-strum-practice");
  const stopMicBtn = document.getElementById("stop-mic");

  // simple loudness-based strum direction detection using envelope change
  function detectDirectionFromWave(data){
    // crude estimate: compute difference between beginning and end energies
    // if attack is strong then classify "down", otherwise "up"
    let mid = Math.floor(data.length/2);
    let leftAvg = 0, rightAvg=0;
    for(let i=0;i<mid;i++) leftAvg += Math.abs(data[i]-128);
    for(let i=mid;i<data.length;i++) rightAvg += Math.abs(data[i]-128);
    leftAvg /= mid;
    rightAvg /= (data.length-mid);
    // if right side larger -> likely downstroke (attack at end), else upstroke
    return (rightAvg - leftAvg) > 8 ? "‚Üì" : "‚Üë";
  }

  async function startMic(){
    try{
      if(!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const stream = await navigator.mediaDevices.getUserMedia({audio:true});
      source = audioContext.createMediaStreamSource(stream);
      analyser = audioContext.createAnalyser();
      source.connect(analyser);
      analyser.fftSize = 2048;
      const bufferLength = analyser.frequencyBinCount;
      dataArray = new Uint8Array(bufferLength);

      currentStrumIndex = 0;
      hits = 0;
      totalStrums = 0;
      strumActive = true;
      highlightStrum();
      strumFeedback.textContent = "Mic active ‚Äî strum the pattern!";
      requestAnimationFrame(checkStrum);
    }catch(e){
      strumFeedback.textContent = "Mic access denied or not supported.";
    }
  }

  function stopMic(){
    try{
      if(source && source.mediaStream) {
        source.mediaStream.getTracks().forEach(t=>t.stop());
      }
    }catch(e){}
    strumActive = false;
    strumFeedback.textContent = "Mic stopped.";
  }

  function checkStrum(){
    if(!strumActive || !analyser) return;
    analyser.getByteTimeDomainData(dataArray);
    // compute avg amplitude
    const avg = dataArray.reduce((a,v)=>a+Math.abs(v-128),0)/dataArray.length;
    // detect a transient (strum) threshold
    if(avg > 10){
      // short window capture to determine direction
      const dir = detectDirectionFromWave(dataArray);
      totalStrums++;
      if(dir === currentPattern[currentStrumIndex]){
        hits++;
        currentStrumIndex++;
        strumFeedback.textContent = `Good: ${dir}`;
        highlightStrum();
        // green flash
        flashElement(strumFeedback, '#1a8f3a');
      } else {
        strumFeedback.textContent = `Wrong: ${dir} (expected ${currentPattern[currentStrumIndex]})`;
        flashElement(strumFeedback, '#b22a2a');
      }
      const accuracy = totalStrums > 0 ? Math.round((hits/totalStrums)*100) : 0;
      // update dashboard stat for currently logged in user
      updateStrumAccuracy(accuracy);
      if(currentStrumIndex >= currentPattern.length){
        strumFeedback.textContent = "Pattern completed!";
        strumActive = false;
      }
    }
    requestAnimationFrame(checkStrum);
  }

  function flashElement(el, color){
    const prev = el.style.background;
    el.style.background = color;
    setTimeout(()=> el.style.background = prev, 250);
  }

  function highlightStrum(){
    const highlight = document.getElementById("strum-highlight");
    highlight.innerHTML = "";
    currentPattern.forEach((s,i)=>{
      const span = document.createElement("span");
      span.textContent = s + (i < currentPattern.length-1 ? " " : "");
      if(i===currentStrumIndex) span.style.background = "rgba(255,165,0,0.9)";
      highlight.appendChild(span);
    });
  }

  async function updateStrumAccuracy(accuracy){
    const user = auth.currentUser;
    if(!user) return;
    try{
      const snap = await getDocs(collection(db,"leaderboard"));
      let foundId=null, data=null;
      snap.forEach(d=>{ if(d.data().uid === user.uid){ foundId=d.id; data=d.data(); }});
      if(foundId){
        await updateDoc(doc(db,"leaderboard",foundId), { strumAccuracy: accuracy, lastPlayed: Date.now() });
        document.getElementById("dash-strum").textContent = accuracy + "%";
      }
    }catch(e){ console.error("update strum", e); }
  }

  startMicBtn.addEventListener("click", startMic);
  stopMicBtn.addEventListener("click", stopMic);

  // Start strum practice: set pattern from selected song (currentPattern)
  startStrumPracticeBtn.addEventListener("click", ()=>{
    if(!currentPattern || currentPattern.length===0){
      currentPattern = ["‚Üì","‚Üì","‚Üë","‚Üì"];
    }
    currentStrumIndex = 0;
    hits = 0; totalStrums = 0;
    strumActive = true;
    highlightStrum();
    strumFeedback.textContent = "Strum practice started: follow the highlighted pattern.";
    if(!audioContext) startMic(); // start mic if not started
  });

  // --- Metronome (audio + bouncing ball) ---
  let metroInterval = null;
  let metroBpm = 80;
  let metroAudioCtx = null;
  function startMetronome(bpm=80){
    stopMetronome();
    metroBpm = bpm;
    if(!metroAudioCtx) metroAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const period = 60000 / metroBpm;
    const ball = document.getElementById("metronome-ball");
    metroInterval = setInterval(()=>{
      // play beep
      const o = metroAudioCtx.createOscillator();
      const g = metroAudioCtx.createGain();
      o.type = "sine";
      o.frequency.value = 880;
      g.gain.value = 0.1;
      o.connect(g); g.connect(metroAudioCtx.destination);
      o.start();
      setTimeout(()=>{ o.stop(); }, 80);
      // animate ball
      ball.style.transform = "translateY(-10px) scale(1.2)";
      setTimeout(()=> ball.style.transform = "translateY(0) scale(1)", period/4);
    }, period);
  }
  function stopMetronome(){ if(metroInterval) clearInterval(metroInterval); metroInterval = null; }

  // minimal UI to control metronome when visiting strum panel
  // start/stop using start-mic/start-strum-practice? But create separate controls if desired.
  // For now, when strumPanel visible, user can start metronome via prompt:
  document.getElementById("metronome-ball").addEventListener("click", ()=>{
    if(metroInterval) { stopMetronome(); alert("Metronome stopped"); }
    else {
      const bpm = parseInt(prompt("Enter BPM (e.g. 80):", "80")) || 80;
      startMetronome(bpm);
      alert("Metronome started at "+bpm+" BPM. Click the orange ball to stop.");
    }
  });

  // --- Leaderboard inclusion rules (auto-add if meet thresholds) ---
  async function evaluateLeaderboardInclusion(user){
    if(!user) return;
    // thresholds: streak >= 10 OR level !== Beginner OR highScore >= 1000
    try{
      const snap = await getDocs(collection(db,"leaderboard"));
      let foundId=null, data=null;
      snap.forEach(d=>{ if(d.data().uid === user.uid){ foundId=d.id; data=d.data(); }});
      if(foundId && data){
        const include = (data.streak >= 10) || (data.level && data.level !== "Beginner") || (data.highScore >= 1000);
        // set a field 'visible' for filtering in leaderboard queries
        await updateDoc(doc(db,"leaderboard",foundId), { visible: include });
      }
    }catch(e){ console.error("evaluate inclusion", e); }
  }

  // --- Song & app initialization ---
  await loadSongs(); // initial load

  // --- Admin: load songs list on open ---
  function loadAdminSongs(){ renderAdminSongList(); }

  // --- Utility: shuffle (already defined) ---

  // --- Extra: provide ability to add chords to chord list (admin) ---
  // Not yet exposed in UI, but admin can add chords by adding to songs or editing STARTING_CHORDS constant.

  // --- Simple UI: show badges when burger clicked ---
  function renderBadges(badges){
    badgesContainer.innerHTML = "";
    (badges||[]).forEach(b=>{
      const el = document.createElement("span");
      el.className = "badge";
      if(b==="Admin") el.classList.add("admin-badge");
      el.textContent = b;
      badgesContainer.appendChild(el);
    });
  }

  // --- Playlist / sample songs (if Firestore empty, add defaults) ---
  async function seedSongsIfEmpty(){
    const snap = await getDocs(collection(db,"songs"));
    if(snap.size === 0){
      const seeds = [
        {name:"Wonderwall - Oasis", author:"Oasis", capo:"2", chords:"Em7 G Dsus4 A7sus4", pattern:"‚Üì ‚Üì ‚Üë ‚Üë ‚Üì ‚Üë"},
        {name:"Knockin' on Heaven's Door - Bob Dylan", author:"Bob Dylan", capo:"", chords:"G D Am C", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë"},
        {name:"Let It Be - The Beatles", author:"The Beatles", capo:"", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üì ‚Üë ‚Üì ‚Üì ‚Üë"},
        {name:"Beautiful in White - Westlife", author:"Westlife", capo:"", chords:"G D Em C", pattern:"‚Üì ‚Üì ‚Üë ‚Üë ‚Üì ‚Üë"}
      ];
      for(const s of seeds) await addDoc(collection(db,"songs"), s);
      await loadSongs();
    }
  }
  await seedSongsIfEmpty();

  // --- Dashboard update from actions (quiz, strum handled) ---
  // Helper when user finishes actions to update leaderboard doc
  async function updateLeaderboardForUser(delta = {}){
    const user = auth.currentUser;
    if(!user) return;
    try{
      const snap = await getDocs(collection(db,"leaderboard"));
      let foundId=null, data=null;
      snap.forEach(d=>{ if(d.data().uid === user.uid){ foundId=d.id; data=d.data(); }});
      if(foundId){
        const ref = doc(db,"leaderboard",foundId);
        await updateDoc(ref, { ...delta, lastPlayed: Date.now() });
      }
    }catch(e){ console.error("update leaderboard user", e); }
  }

  // --- Ensure UI texts that must remain white are set accordingly ---
  // We added force-white class to those; ensure light-mode doesn't override them via CSS.

  // --- Final: make sure the main menu appears if not signed in after small delay ---
  setTimeout(()=>{
    if(!auth.currentUser){
      hidePanel(mainMenu);
      showPanel(loginScreen);
    }
  },400);

  // --- Some helpful debugging hooks (expose to console) ---
  window._app = {
    db,
    auth,
    loadSongs,
    loadLeaderboard,
    startMic,
    stopMic,
    startMetronome,
    stopMetronome
  };

  // Listen realtime changes to leaderboard to refresh when necessary
  const lbq = query(collection(db,"leaderboard"), orderBy("highScore","desc"));
  onSnapshot(lbq, ()=> {
    // If leaderboardPanel open, refresh
    if(!leaderboardPanel.classList.contains("hidden")) loadLeaderboard();
  });

  // Load songs when changes happen
  onSnapshot(collection(db,"songs"), ()=> loadSongs());

</script>
</body>
</html>

