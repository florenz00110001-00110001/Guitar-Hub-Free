<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Guitar Hub Trainer</title>
<style>
  :root{
    --bg:#111;
    --panel:#000;
    --accent:orange;
    --muted:#222;
    --text:#fff;
    --card:#1a1a1a;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:Arial, sans-serif;
    background:var(--bg);
    color:var(--text);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    text-align:center;
    transition:background 0.25s,color 0.25s;
  }
  header{
    width:100%;
    background:var(--panel);
    padding:10px 18px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    position:fixed;
    top:0; left:0;
    z-index:1000;
    box-shadow:0 2px 8px rgba(0,0,0,0.6);
  }
  .logo{display:flex;align-items:center;font-weight:700;font-size:1.25rem}
  .logo .guitar{color:#fff}
  .logo .hub{color:black;background:orange;padding:4px 8px;border-radius:6px;margin-left:8px} /* hub bg changed to orange */
  .controls{display:flex;gap:8px;align-items:center}
  main{padding:92px 14px 40px; max-width:980px;margin:0 auto;}
  button{padding:10px 16px;border-radius:8px;border:none;background:var(--accent);color:#000;font-weight:600;cursor:pointer;transition:all 0.2s}
  button:hover{opacity:0.9}
  .back-btn{background:#444;color:#fff}
  .ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:8px}
  .card{background:var(--muted);padding:14px;border-radius:10px;margin:12px 0;box-shadow:0 6px 16px rgba(0,0,0,0.6);transition:all 0.3s ease}
  .hidden{display:none;opacity:0;transition:opacity 0.25s ease}
  .visible{display:block;opacity:1;transition:opacity 0.25s ease}
  .chord-grid{display:flex;flex-wrap:wrap;gap:14px;justify-content:center;padding:8px}
  .chord-card{width:120px;background:#222;padding:10px;border-radius:10px;box-shadow:0 6px 14px rgba(0,0,0,0.6);text-align:center;transition:transform 0.2s}
  .chord-card:hover{transform:scale(1.05)}
  .chord-card img{width:100px;height:auto;display:block;margin:8px auto}
  .timer{font-weight:700;color:gold;font-size:1.2rem;margin:8px}
  #quiz-options button{display:block;width:100%;margin:8px 0;background:#333;color:#fff;padding:10px;border-radius:8px}
  input[type="text"],input[type="email"],input[type="password"],select{
    width:100%;padding:10px;border-radius:8px;border:none;background:#1b1b1b;color:#fff;margin-bottom:10px;font-size:1rem;
  }
  .row{display:flex;gap:8px;align-items:center}
  .row .small{width:48px;padding:8px}
  .song{padding:10px;border-radius:8px;background:#171717;margin:8px 0;text-align:left}
  .song .title{font-weight:700;color:#fff}
  .song .meta{font-size:0.9rem;color:#ddd;margin-top:6px}
  #burger{font-size:1.4rem;background:none;border:none;color:#fff;cursor:pointer;padding:6px 8px}
  #account-panel{position:fixed;top:58px;right:12px;width:320px;background:#141414;padding:12px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,0.6);display:none;z-index:1100}
  #account-panel h4{margin:0 0 8px 0}
  #strum-highlight{font-size:1.5rem;margin:12px 0;letter-spacing:6px;color:#fff}
  .stat-small{font-size:0.95rem;color:#ddd}
  .metronome-controls{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:8px}
  @media (max-width:600px){
    .logo{font-size:1.05rem}
    main{padding:96px 12px}
    .chord-card{width:96px}
  }
  /* Light mode tweaks: keep important UI text white as requested */
  .light-mode{background:#fff;color:#fff}
  .light-mode .logo .hub{background:orange;color:black}
  /* keep many texts white even in light mode */
  .light-mode .card, .light-mode input, .light-mode .ghost { color: #fff; background: #222; }
  .light-mode button{color:#000}
</style>
</head>
<body>

<header>
  <div class="logo">
    <span class="guitar">Guitar</span><span class="hub">Hub</span>
  </div>
  <div class="controls">
    <button id="dark-toggle" title="Toggle theme">üåó</button>
    <button id="burger" aria-label="Open account menu">‚ò∞</button>
  </div>
</header>

<div id="account-panel" aria-hidden="true">
  <h4>Account</h4>
  <p id="account-email">Not signed in</p>
  <div style="display:flex;gap:8px;margin-top:8px;">
    <button id="show-dashboard" class="ghost">Dashboard</button>
    <button id="signout-btn" class="ghost">Sign out</button>
  </div>
  <hr style="margin:10px 0;border-color:#222">
  <button id="change-pass" class="ghost" style="width:100%;margin-bottom:8px">Change password</button>
  <button id="delete-account" class="ghost" style="width:100%;color:#ff6666">Delete account</button>
</div>

<main>
  <div id="login-screen" class="card">
    <h1 style="margin:0 0 8px 0;color:#fff">Login</h1>
    <input id="email" type="email" placeholder="Email" autocomplete="username">
    <div class="row" style="align-items:center">
      <input id="password" type="password" placeholder="Password" autocomplete="current-password" style="flex:1">
      <button id="toggle-pass" class="ghost small" title="Show/Hide">üëÅÔ∏è</button>
    </div>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:8px">
      <button id="login-btn">Login</button>
      <button id="signup-btn" class="ghost">Sign up</button>
    </div>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:10px">
      <button id="continue-btn" class="ghost">Continue without account</button>
    </div>
    <p style="margin:12px 0 0 0"><a href="#" id="forgot-link" style="color:#ddd">Forgot password?</a></p>
    <p id="auth-msg" style="color:#f88;margin-top:8px"></p>
  </div>

  <div id="main-menu" class="card hidden">
    <h2 style="margin-top:0;color:#fff">Main Menu</h2>
    <div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center">
      <button id="btn-chords">View Chords</button>
      <button id="btn-practice">Practice Chords</button>
      <button id="btn-strum">Practice Strum</button>
      <button id="btn-quiz">Chord Recognition Quiz</button>
      <button id="btn-learn-songs" class="ghost">Learn Songs</button>
      <button id="btn-tune" class="ghost">Tune with GuitarTuna</button>
    </div>
  </div>

  <div id="chords" class="card hidden">
    <h2 style="margin-top:0;color:#fff">Basic Chords</h2>
    <div class="chord-grid" id="chord-grid" aria-live="polite"></div>
    <button class="back-btn" onclick="goBack()">‚¨Ö Back</button>
  </div>

  <div id="practice" class="card hidden">
    <h2 style="margin-top:0;color:#fff">Practice Chords (Random)</h2>
    <div id="practice-chord-display" style="font-size:2rem;margin:16px;color:#fff"></div>
    <div style="display:flex;gap:8px;justify-content:center">
      <button id="next-chord">Next Chord</button>
      <button id="play-chord" class="ghost">Play (placeholder)</button>
    </div>
    <div class="metronome-controls" style="margin-top:12px">
      <label style="color:#fff">Metronome BPM</label>
      <input id="metronome-bpm" type="number" min="40" max="220" value="90" style="width:110px">
      <button id="metronome-toggle" class="ghost">Start Metronome</button>
      <button id="metronome-stop" class="ghost">Stop</button>
    </div>
    <p id="practice-feedback" style="margin-top:10px;color:#fff"></p>
    <button class="back-btn" onclick="goBack()">‚¨Ö Back</button>
  </div>

  <div id="strum" class="card hidden">
    <h2 style="margin-top:0;color:#fff">Practice Strum</h2>
    <input id="song-search" type="text" placeholder="Search songs..." style="margin-bottom:12px" />
    <div id="song-list" style="max-height:360px;overflow:auto;padding-right:6px"></div>
    <div style="margin-top:12px">
      <p id="song-pattern" style="font-weight:700;color:#fff">Pattern: ‚Äî</p>
      <button id="start-mic" class="ghost">Start Mic Test</button>
      <button id="stop-mic" class="ghost" style="display:none">Stop Mic</button>
      <p id="strum-feedback" style="margin-top:8px;color:#fff"></p>
      <div id="strum-highlight"></div>
    </div>
    <button class="back-btn" onclick="goBack()">‚¨Ö Back</button>
  </div>

  <div id="quiz" class="card hidden">
    <h2 style="margin-top:0;color:#fff">Chord Recognition Quiz</h2>
    <div style="margin-bottom:12px">
      <button id="start-quiz">Start Quiz</button>
      <button id="reset-quiz" class="ghost" style="display:none">Reset</button>
    </div>
    <div id="quiz-area" class="hidden" style="text-align:center">
      <div class="timer" id="timer">5</div>
      <div id="quiz-image" style="margin:8px"></div>
      <div id="quiz-options" style="max-width:420px;margin:0 auto;text-align:center"></div>
      <p id="quiz-progress" style="margin-top:8px;color:#fff"></p>
    </div>
    <div id="quiz-result" class="hidden" style="margin-top:12px;font-weight:700;color:#fff"></div>
    <button class="back-btn" onclick="goBack()">‚¨Ö Back</button>
  </div>

  <div id="dashboard" class="card hidden">
    <h2 style="margin-top:0;color:#fff">Dashboard</h2>
    <p class="stat-small">Strum Accuracy: <span id="dash-strum">0%</span></p>
    <p class="stat-small">Quiz Score History: <span id="dash-quiz">N/A</span></p>
    <p class="stat-small">Total Practice Sessions: <span id="dash-practice-count">0</span></p>
    <button class="back-btn" onclick="goBack()">‚¨Ö Back</button>
  </div>
</main>

<!-- Scripts -->
<script type="module">
  // Firebase (app + auth + firestore). Optional: Firestore writes if enabled in your project.
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail, onAuthStateChanged, updatePassword, deleteUser } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, setDoc, doc, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

  // --- Your firebase config (kept from earlier messages) ---
  const firebaseConfig = {
    apiKey: "AIzaSyDkMmF78dFu2dmuzka6xuwpLRD5NRCCJtY",
    authDomain: "guitar-hub-25dfa.firebaseapp.com",
    projectId: "guitar-hub-25dfa",
    storageBucket: "guitar-hub-25dfa.appspot.com",
    messagingSenderId: "36479296604",
    appId: "1:36479296604:web:5dbcfb2aec3912f8ba7299",
    measurementId: "G-N4HZW695LF"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  let db;
  try{ db = getFirestore(app); }catch(e){ console.warn("Firestore not available in environment", e); }

  // --- UI elements ---
  const loginScreen = document.getElementById("login-screen");
  const mainMenu = document.getElementById("main-menu");
  const chordsPanel = document.getElementById("chords");
  const practicePanel = document.getElementById("practice");
  const strumPanel = document.getElementById("strum");
  const quizPanel = document.getElementById("quiz");
  const dashboardPanel = document.getElementById("dashboard");
  const accountPanel = document.getElementById("account-panel");

  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");
  const authMsg = document.getElementById("auth-msg");
  const burgerBtn = document.getElementById("burger");
  const accountEmail = document.getElementById("account-email");

  // Keep text white in many places even in light-mode as requested:
  function enforceTextWhite(){
    // elements that must remain white
    const whites = [
      document.querySelector('#main-menu h2'),
      document.querySelector('#login-screen h1'),
      document.querySelector('#login-screen a'),
      document.querySelector('#practice h2'),
      document.querySelector('#strum h2'),
      document.querySelector('#song-pattern'),
      document.querySelector('#start-mic'),
      document.querySelector('#metronome-toggle'),
      document.querySelector('#metronome-stop'),
    ];
    whites.forEach(el => { if(el) el.style.color = '#fff'; });
  }
  enforceTextWhite();

  // Dark Mode toggle (but keep certain texts white)
  document.getElementById("dark-toggle").addEventListener("click", ()=> {
    document.body.classList.toggle("light-mode");
    enforceTextWhite();
  });

  burgerBtn.addEventListener("click", ()=>{
    accountPanel.style.display = accountPanel.style.display === "block" ? "none" : "block";
  });

  document.getElementById("toggle-pass").addEventListener("click", ()=>{
    passwordInput.type = passwordInput.type === "password" ? "text" : "password";
  });

  // --- Auth buttons ---
  document.getElementById("signup-btn").addEventListener("click", async ()=>{
    const email = emailInput.value.trim();
    const pw = passwordInput.value;
    if(!email || !pw){ authMsg.textContent = "Provide email & password to sign up."; return; }
    try{
      await createUserWithEmailAndPassword(auth, email, pw);
      authMsg.style.color = "#8f8"; authMsg.textContent = "Account created, signed in.";
    }catch(e){ authMsg.style.color="#f88"; authMsg.textContent = e.message; }
  });

  document.getElementById("login-btn").addEventListener("click", async ()=>{
    const email = emailInput.value.trim();
    const pw = passwordInput.value;
    if(!email || !pw){ authMsg.textContent = "Enter email & password to sign in."; authMsg.style.color="#f88"; return; }
    try{
      await signInWithEmailAndPassword(auth, email, pw);
      authMsg.style.color="#8f8"; authMsg.textContent = "Signed in.";
    }catch(e){ authMsg.style.color="#f88"; authMsg.textContent = e.message; }
  });

  document.getElementById("continue-btn").addEventListener("click", ()=>{
    loginScreen.classList.add("hidden");
    mainMenu.classList.remove("hidden");
    accountEmail.textContent = "Guest";
  });

  document.getElementById("forgot-link").addEventListener("click", async (ev)=>{
    ev.preventDefault();
    const email = emailInput.value.trim();
    if(!email){ authMsg.style.color="#f88"; authMsg.textContent = "Enter your email then click Reset."; return; }
    try{
      await sendPasswordResetEmail(auth, email);
      authMsg.style.color="#8f8"; authMsg.textContent = "Reset email sent (check inbox).";
    }catch(e){ authMsg.style.color="#f88"; authMsg.textContent = e.message; }
  });

  document.getElementById("signout-btn").addEventListener("click", async ()=>{
    try{ await signOut(auth); loginScreen.classList.remove("hidden"); mainMenu.classList.add("hidden"); accountPanel.style.display='none'; accountEmail.textContent='Not signed in'; authMsg.textContent=''; }
    catch(e){ console.error(e); }
  });

  document.getElementById("change-pass").addEventListener("click", async ()=>{
    const newPass = prompt("Enter new password (min 6 chars):");
    if(!newPass) return;
    if(!auth.currentUser){ alert("Sign in required to change password."); return; }
    try{
      await updatePassword(auth.currentUser, newPass);
      alert("Password updated.");
    }catch(e){ alert(e.message); }
  });

  document.getElementById("delete-account").addEventListener("click", async ()=>{
    if(!auth.currentUser){ alert("Not signed in."); return; }
    if(!confirm("Delete your account permanently?")) return;
    try{
      await deleteUser(auth.currentUser);
      alert("Account deleted.");
      loginScreen.classList.remove("hidden"); mainMenu.classList.add("hidden");
    }catch(e){
      alert("Delete failed: "+e.message);
    }
  });

  onAuthStateChanged(auth, (user)=>{
    if(user){
      accountEmail.textContent = user.email || "User";
      loginScreen.classList.add("hidden");
      mainMenu.classList.remove("hidden");
      authMsg.textContent = "";
    }
  });

  // --- Main Menu Buttons (wired) ---
  document.getElementById("btn-chords").addEventListener("click", ()=>{
    loginScreen.classList.add("hidden"); mainMenu.classList.add("hidden");
    chordsPanel.classList.remove("hidden");
    populateChordGrid();
  });
  document.getElementById("btn-practice").addEventListener("click", ()=>{
    loginScreen.classList.add("hidden"); mainMenu.classList.add("hidden"); practicePanel.classList.remove("hidden");
  });
  document.getElementById("btn-strum").addEventListener("click", ()=>{
    loginScreen.classList.add("hidden"); mainMenu.classList.add("hidden"); strumPanel.classList.remove("hidden");
    renderSongs();
  });
  document.getElementById("btn-quiz").addEventListener("click", ()=>{
    loginScreen.classList.add("hidden"); mainMenu.classList.add("hidden"); quizPanel.classList.remove("hidden");
  });
  document.getElementById("btn-learn-songs").addEventListener("click", ()=>{ alert("Learn Songs module forthcoming!"); });
  document.getElementById("btn-tune").addEventListener("click", ()=>{ window.open('https://www.guitartuna.com/','_blank'); });

  document.getElementById("show-dashboard").addEventListener("click", ()=>{
    loginScreen.classList.add("hidden");
    mainMenu.classList.add("hidden");
    chordsPanel.classList.add("hidden");
    practicePanel.classList.add("hidden");
    strumPanel.classList.add("hidden");
    quizPanel.classList.add("hidden");
    dashboardPanel.classList.remove("hidden");
    accountPanel.style.display = 'none';
    loadDashboard();
  });

  function goBack(){
    chordsPanel.classList.add("hidden");
    practicePanel.classList.add("hidden");
    strumPanel.classList.add("hidden");
    quizPanel.classList.add("hidden");
    dashboardPanel.classList.add("hidden");
    mainMenu.classList.remove("hidden");
  }

  // --- Chords grid & local image mapping ---
  // IMPORTANT: images are expected in local folder `image/` with names matching mapping below.
  const chordImageMap = {
    "C":"c.png",
    "D":"d.png",
    "E":"e.png",
    "F":"f.png",
    "G":"g.png",
    "A":"a.png",
    "B":"b.png",
    "Am":"am.png",
    "Dm":"dm.png",
    "Em":"em.png",
    "F#":"fsharp.png",
    "F#m":"fsharpm.png",
    "Bm":"bm.png",
    "Cmaj7":"cmaj7.png",
    "C#":"csharp.png",
    "C#m":"csharpm.png",
    "G#":"gsharp.png",
    "G#m":"gsharpm.png"
    // add your own mappings as needed
  };

  const availableChords = Object.keys(chordImageMap);

  function populateChordGrid(){
    const chordGrid = document.getElementById("chord-grid");
    chordGrid.innerHTML = "";
    availableChords.forEach(chord=>{
      const card = document.createElement("div");
      card.className = "chord-card";
      // choose file name or fallback
      const fname = chordImageMap[chord] || (chord.toLowerCase().replace("#","sharp").replace("+","plus") + ".png");
      // center image and show fallback alt text if missing
      card.innerHTML = `<div style="font-weight:700;color:#fff">${chord}</div>
        <img src="image/${fname}" alt="${chord} chord" onerror="this.onerror=null;this.style.opacity=0.35;this.style.filter='grayscale(1)';">`;
      chordGrid.appendChild(card);
    });
  }

  // --- Practice Chords ---
  const practiceChords = availableChords.slice(); // same as chords list
  let currentPracticeChord = null;
  document.getElementById("next-chord").addEventListener("click", ()=>{
    currentPracticeChord = practiceChords[Math.floor(Math.random()*practiceChords.length)];
    document.getElementById("practice-chord-display").textContent = currentPracticeChord;
    document.getElementById("practice-feedback").textContent = "";
  });

  // Play chord placeholder: synthesize short chord-ish sound
  document.getElementById("play-chord").addEventListener("click", ()=>{
    if(!currentPracticeChord){ document.getElementById("practice-feedback").textContent = "Press Next to get a chord."; return; }
    playChordTone(currentPracticeChord);
  });

  function playChordTone(chord){
    // simple triad-ish tone using WebAudio for placeholder
    try{
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const baseFreq = 220; // A3 baseline
      const osc1 = ctx.createOscillator();
      const osc2 = ctx.createOscillator();
      const gain = ctx.createGain();
      osc1.type = "sine"; osc2.type="sine";
      osc1.frequency.value = baseFreq;
      osc2.frequency.value = baseFreq * 1.5;
      gain.gain.value = 0.001;
      osc1.connect(gain); osc2.connect(gain); gain.connect(ctx.destination);
      const now = ctx.currentTime;
      gain.gain.setValueAtTime(0.001, now);
      gain.gain.linearRampToValueAtTime(0.05, now+0.02);
      gain.gain.exponentialRampToValueAtTime(0.0001, now+1.2);
      osc1.start(now); osc2.start(now);
      osc1.stop(now+1.2); osc2.stop(now+1.2);
    }catch(e){ console.warn("Audio not supported", e); }
  }

  // Metronome
  let metronomeInterval = null;
  const metronomeToggle = document.getElementById("metronome-toggle");
  const metronomeStop = document.getElementById("metronome-stop");
  metronomeToggle.addEventListener("click", ()=> {
    const bpm = parseInt(document.getElementById("metronome-bpm").value || 90,10);
    startMetronome(bpm);
    metronomeToggle.style.display = "none";
    metronomeStop.style.display = "inline-block";
  });
  metronomeStop.addEventListener("click", ()=> {
    stopMetronome();
    metronomeToggle.style.display = "inline-block";
    metronomeStop.style.display = "none";
  });

  function startMetronome(bpm){
    stopMetronome();
    const interval = 60000 / bpm;
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    metronomeInterval = setInterval(()=> {
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = "square";
      o.frequency.value = 1000;
      g.gain.value = 0.05;
      o.connect(g); g.connect(ctx.destination);
      o.start();
      setTimeout(()=>{ o.stop(); }, 80);
    }, interval);
  }
  function stopMetronome(){
    if(metronomeInterval) clearInterval(metronomeInterval);
    metronomeInterval = null;
  }

  // --- Songs list for strum practice ---
  // Add your songs here. Format: {name, chords, pattern}
  const songs = [
    {name:"Wonderwall - Oasis", chords:"Em7 G Dsus4 A7sus4", pattern:"‚Üì ‚Üì ‚Üë ‚Üë ‚Üì ‚Üë"},
    {name:"Knockin' on Heaven's Door - Bob Dylan", chords:"G D Am G D C", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë"},
    {name:"Zombie - The Cranberries", chords:"Em C G D", pattern:"‚Üì ‚Üë ‚Üì ‚Üë"},
    {name:"Let It Be - The Beatles", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üì ‚Üë ‚Üì ‚Üì ‚Üë"},
    {name:"Beautiful in White - Westlife", chords:"G D Em C", pattern:"‚Üì ‚Üì ‚Üë ‚Üë ‚Üì ‚Üë"} // user requested addition
    // add more songs here or later programmatically
  ];

  const songList = document.getElementById("song-list");
  const songSearch = document.getElementById("song-search");

  function renderSongs(filter=""){
    songList.innerHTML = "";
    const q = (filter || "").trim().toLowerCase();
    songs.forEach(s=>{
      if(q && !s.name.toLowerCase().includes(q)) return;
      const div = document.createElement("div");
      div.className = "song";
      div.innerHTML = `<div class="title">${s.name}</div>
        <div class="meta">Chords: ${s.chords}<br>Strum: ${s.pattern}
          <div style="margin-top:8px">
            <button class="ghost select-song-btn">Select</button>
          </div>
        </div>`;
      // attach listener
      div.querySelector('.select-song-btn').addEventListener('click', ()=>{
        selectSong(s);
      });
      songList.appendChild(div);
    });
  }

  songSearch && songSearch.addEventListener("input", ()=> renderSongs(songSearch.value));
  function renderSongsIfVisible(){ if(document.getElementById('song-list')) renderSongs(); }
  renderSongs();

  function selectSong(song){
    document.getElementById("song-pattern").textContent = `Pattern: ${song.pattern}`;
    document.getElementById("strum-feedback").textContent = "";
    currentPattern = song.pattern.split(/\s*/).filter(ch => ch.trim()); // array of symbols including arrows
    currentStrumIndex = 0;
    highlightStrum();
  }

  // --- Strum detection (improved) ---
  let audioContext, analyser, dataArray, sourceNode;
  let currentPattern = ["‚Üì","‚Üì","‚Üë","‚Üì"]; // default, overwritten by selectSong
  let currentStrumIndex = 0;
  let hits = 0;
  let totalStrums = 0;
  let strumActive = false;
  let micStream = null;
  const strumFeedback = document.getElementById("strum-feedback");
  const startMicBtn = document.getElementById("start-mic");
  const stopMicBtn = document.getElementById("stop-mic");

  startMicBtn.addEventListener("click", startMic);
  stopMicBtn.addEventListener("click", stopMic);

  async function startMic(){
    if(strumActive) return;
    try{
      audioContext = audioContext || new (window.AudioContext || window.webkitAudioContext)();
      micStream = await navigator.mediaDevices.getUserMedia({audio:true});
      sourceNode = audioContext.createMediaStreamSource(micStream);
      analyser = audioContext.createAnalyser();
      analyser.fftSize = 2048;
      sourceNode.connect(analyser);
      dataArray = new Uint8Array(analyser.frequencyBinCount);
      // reset counters
      currentStrumIndex = 0; hits = 0; totalStrums = 0; strumActive = true;
      highlightStrum();
      strumFeedback.textContent = "Mic active ‚Äî strum the pattern";
      startMicBtn.style.display = 'none';
      stopMicBtn.style.display = 'inline-block';
      requestAnimationFrame(checkStrum);
    }catch(e){
      strumFeedback.textContent = "Mic access denied or not available.";
      console.error(e);
    }
  }

  function stopMic(){
    strumActive = false;
    if(micStream){
      micStream.getTracks().forEach(t=>t.stop());
      micStream = null;
    }
    if(sourceNode){ try{ sourceNode.disconnect(); }catch(e){} }
    startMicBtn.style.display = 'inline-block';
    stopMicBtn.style.display = 'none';
    strumFeedback.textContent = "Mic stopped.";
    saveStrumAccuracy();
  }

  function checkStrum(){
    if(!strumActive) return;
    analyser.getByteFrequencyData(dataArray); // freq domain
    // compute energy (loudness)
    let sum = 0;
    let weighted = 0;
    for(let i=0;i<dataArray.length;i++){
      const v = dataArray[i];
      sum += v;
      weighted += v*i;
    }
    const avg = sum / dataArray.length;
    const centroid = sum ? (weighted / sum) : 0;
    // heuristic: centroid < threshold -> "down" (low freq content); centroid > threshold -> "up"
    const centroidThreshold = dataArray.length * 0.12; // tuned threshold
    // detect a strum by checking sudden increase in avg (simple envelope approach)
    // We'll compute time-domain amplitude too for better spike detection
    const timeData = new Uint8Array(analyser.fftSize);
    analyser.getByteTimeDomainData(timeData);
    let amp = 0;
    for(let i=0;i<timeData.length;i++){
      amp += Math.abs(timeData[i]-128);
    }
    amp = amp / timeData.length;
    // thresholds
    const ampThreshold = 10; // tuned, may need adjustment per mic
    let detected = null;
    if(amp > ampThreshold){
      // determine direction
      detected = centroid > centroidThreshold ? "‚Üë" : "‚Üì";
      handleDetectedStrum(detected);
      // small pause to avoid double-detecting same strum
      // We'll skip detection for ~250ms by using setTimeout to set a lock
      strumActive = false;
      setTimeout(()=>{ strumActive = true; requestAnimationFrame(checkStrum); }, 220);
      return;
    }
    requestAnimationFrame(checkStrum);
  }

  function handleDetectedStrum(detected){
    totalStrums++;
    const expected = currentPattern[currentStrumIndex] || currentPattern[currentStrumIndex%currentPattern.length];
    const highlightIdx = currentStrumIndex;
    if(detected === expected){
      hits++;
      showStrumResult(true, detected);
      currentStrumIndex++;
    } else {
      showStrumResult(false, detected);
    }
    highlightStrum();
    // update dashboard accuracy live
    const accuracy = totalStrums > 0 ? Math.round((hits/totalStrums)*100) : 0;
    document.getElementById("dash-strum").textContent = accuracy + "%";
    // complete check
    if(currentStrumIndex >= currentPattern.length){
      strumFeedback.textContent = "Pattern completed!";
      saveStrumAccuracy();
      // stop listening automatically
      stopMic();
    }
  }

  function showStrumResult(ok, detected){
    const fb = document.getElementById("strum-feedback");
    if(ok){
      fb.textContent = `Good ‚Äî detected ${detected}`;
      fb.style.color = '#8f8';
    } else {
      fb.textContent = `Wrong ‚Äî detected ${detected}`;
      fb.style.color = '#f88';
    }
  }

  function highlightStrum(){
    const el = document.getElementById("strum-highlight");
    if(!el) return;
    el.innerHTML = "";
    for(let i=0;i<currentPattern.length;i++){
      const s = currentPattern[i];
      const span = document.createElement("span");
      span.style.padding = "0 6px";
      span.style.fontWeight = "700";
      span.style.color = (i < currentStrumIndex) ? "#8f8" : (i === currentStrumIndex ? "#ff0" : "#fff");
      if(i === currentStrumIndex) span.style.textDecoration = "underline";
      span.textContent = s;
      el.appendChild(span);
    }
  }

  function saveStrumAccuracy(){
    const accuracy = totalStrums > 0 ? Math.round((hits/totalStrums)*100) : 0;
    // localStorage record
    const history = JSON.parse(localStorage.getItem('guitarhub_strum_history')||'[]');
    history.push({when:Date.now(), accuracy, hits, totalStrums});
    localStorage.setItem('guitarhub_strum_history', JSON.stringify(history));
    // update dashboard
    document.getElementById("dash-strum").textContent = accuracy + "%";
    document.getElementById("dash-practice-count").textContent = (history.length || 0);
    // attempt to write to Firestore leaderboard if logged in
    const user = auth.currentUser;
    if(user && db){
      try{
        const col = collection(db, "leaderboard");
        addDoc(col, { uid:user.uid, email:user.email, type:"strum", accuracy, when: Date.now() });
      }catch(e){ console.warn("Failed to write leaderboard", e); }
    }
  }

  // --- Quiz logic (images correctly loaded) ---
  const quizChords = availableChords.slice(); // include all chords
  let quizScore = 0;
  let quizCount = 0;
  const quizTotal = 10;
  const quizArea = document.getElementById("quiz-area");
  const quizResult = document.getElementById("quiz-result");
  const quizImage = document.getElementById("quiz-image");
  const quizOptions = document.getElementById("quiz-options");
  const timerEl = document.getElementById("timer");
  let quizTimer;
  let currentQuizChord;

  function shuffleArray(array){
    return array.slice().sort(()=>Math.random()-0.5);
  }

  document.getElementById("start-quiz").addEventListener("click", ()=>{
    quizScore = 0; quizCount = 0;
    quizResult.classList.add("hidden");
    quizArea.classList.remove("hidden");
    document.getElementById("start-quiz").style.display = "none";
    document.getElementById("reset-quiz").style.display = "inline-block";
    nextQuizChord();
  });

  document.getElementById("reset-quiz").addEventListener("click", ()=>{
    clearInterval(quizTimer);
    quizScore = 0; quizCount = 0;
    quizArea.classList.add("hidden");
    quizResult.classList.add("hidden");
    document.getElementById("start-quiz").style.display = "inline-block";
    document.getElementById("reset-quiz").style.display = "none";
  });

  function nextQuizChord(){
    if(quizCount >= quizTotal){
      quizArea.classList.add("hidden");
      quizResult.classList.remove("hidden");
      quizResult.textContent = `Quiz Completed! Score: ${quizScore}/${quizTotal}`;
      // save to local storage and firestore
      saveQuizScore(quizScore);
      return;
    }
    currentQuizChord = quizChords[Math.floor(Math.random()*quizChords.length)];
    // display image if available
    const fname = chordImageMap[currentQuizChord] || (currentQuizChord.toLowerCase().replace("#","sharp").replace("+","plus") + ".png");
    quizImage.innerHTML = `<div style="font-weight:700;color:#fff;margin-bottom:8px">${currentQuizChord}</div>
      <img src="image/${fname}" alt="${currentQuizChord}" style="width:160px" onerror="this.onerror=null;this.style.opacity=0.5;this.style.filter='grayscale(1)';">`;
    quizOptions.innerHTML = "";
    const choices = shuffleArray(quizChords).slice(0,4);
    if(!choices.includes(currentQuizChord)) choices[Math.floor(Math.random()*4)] = currentQuizChord;
    choices.forEach(c=>{
      const btn = document.createElement("button");
      btn.textContent = c;
      btn.addEventListener("click", ()=>{
        if(c===currentQuizChord) quizScore++;
        quizCount++;
        clearInterval(quizTimer);
        nextQuizChord();
      });
      quizOptions.appendChild(btn);
    });
    startQuizTimer();
    document.getElementById("quiz-progress").textContent = `Question ${quizCount+1} / ${quizTotal}`;
  }

  function startQuizTimer(){
    let time = 6; // slightly more time to pick (tune as needed)
    timerEl.textContent = time;
    clearInterval(quizTimer);
    quizTimer = setInterval(()=>{
      time--;
      timerEl.textContent = time;
      if(time<=0){
        clearInterval(quizTimer);
        quizCount++;
        nextQuizChord();
      }
    },1000);
  }

  function saveQuizScore(score){
    // local history
    const qh = JSON.parse(localStorage.getItem('guitarhub_quiz_history')||'[]');
    qh.push({when:Date.now(), score});
    localStorage.setItem('guitarhub_quiz_history', JSON.stringify(qh));
    document.getElementById("dash-quiz").textContent = qh.map(x=>x.score).join(", ");
    // try Firestore
    const user = auth.currentUser;
    if(user && db){
      try{
        const col = collection(db, "leaderboard");
        addDoc(col, { uid:user.uid, email:user.email, type:"quiz", score, when: Date.now() });
      }catch(e){ console.warn("Failed to write leaderboard", e); }
    }
  }

  // --- Dashboard load ---
  function loadDashboard(){
    // strum history
    const sh = JSON.parse(localStorage.getItem('guitarhub_strum_history')||'[]');
    const qh = JSON.parse(localStorage.getItem('guitarhub_quiz_history')||'[]');
    const practiceCount = sh.length || 0;
    const lastAccuracy = sh.length ? sh[sh.length-1].accuracy : 0;
    document.getElementById("dash-strum").textContent = (lastAccuracy || 0) + "%";
    document.getElementById("dash-quiz").textContent = qh.length ? qh.map(x=>x.score).join(", ") : "N/A";
    document.getElementById("dash-practice-count").textContent = practiceCount;
  }

  // --- Utilities & init ---
  function renderSongs(){
    renderSongsIfVisible();
  }

  // initial populate chord grid for performance
  populateChordGrid();

  // ensure dashboard values displayed on load if user navigates there
  loadDashboard();

  // expose goBack globally for inline onclick
  window.goBack = goBack;

  // small helper for later: allow adding chords or songs externally if needed
  window.__guitarhub = {
    addSong: (songObj) => { songs.push(songObj); renderSongs(); },
    addChordImage: (name, fname) => { chordImageMap[name] = fname; populateChordGrid(); }
  };

  // NOTE: To enable full Firestore leaderboard features, ensure Firestore is enabled in your Firebase console and rules are permissive for testing, or configure proper auth rules.
</script>

</body>
</html>
