<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Guitar Hub Trainer</title>
<style>
  :root{
    --bg:#111;√†ww
    --panel:#000;
    --accent:orange;
    --muted:#222;t
    --text:#fff;
    --card:#1a1a1a;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:Arial, sans-serif;
    background:var(--bg);
    color:var(--text); to be 
  y  -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    text-align:center;
    transition:background 0.25s,color 0.25s;
  }
  header{
    width:100%;
    background:var(--panel);
    padding:10px 18px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    position:fixed;
    top:0; left:0;
    z-index:1000;
    box-shadow:0 2px 8px rgba(0,0,0,0.6);
  }
  .logo{display:flex;align-items:center;font-weight:700;font-size:1.25rem}
  .logo .guitar{color:#fff}
  .logo .hub{color:black;background:orange;padding:4px 8px;border-radius:6px;margin-left:8px} /* hub bg set to orange as requested */
  .controls{display:flex;gap:8px;align-items:center}
  main{padding:92px 14px 40px; max-width:980px;margin:0 auto;}
  button{padding:10px 16px;border-radius:8px;border:none;background:var(--accent);color:#111;font-weight:600;cursor:pointer;transition:all 0.2s}
  button:hover{opacity:0.9}
  .back-btn{background:#444;color:#fff}
  .ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:8px}
  .card{background:var(--muted);padding:14px;border-radius:10px;margin:12px 0;box-shadow:0 6px 16px rgba(0,0,0,0.6);transition:all 0.3s ease}
  .hidden{display:none;opacity:0;transition:opacity 0.3s ease}
  .visible{display:block;opacity:1;transition:opacity 0.3s ease}
  .chord-grid{display:flex;flex-wrap:wrap;gap:14px;justify-content:center;padding:8px}
  .chord-card{width:120px;background:#222;padding:10px;border-radius:10px;box-shadow:0 6px 14px rgba(0,0,0,0.6);text-align:center;transition:transform 0.2s;display:flex;flex-direction:column;align-items:center;justify-content:center}
  .chord-card:hover{transform:scale(1.05)}
  .chord-card img{width:80px;height:80px;object-fit:contain;display:block;margin:8px auto}
  .timer{font-weight:700;color:gold;font-size:1.2rem;margin:8px}
  #quiz-options button{display:block;width:100%;margin:8px 0;background:#333;color:#fff;padding:10px;border-radius:8px}
  input[type="text"],input[type="email"],input[type="password"]{
    width:100%;padding:10px;border-radius:8px;border:none;background:#1b1b1b;color:#fff;margin-bottom:10px;font-size:1rem;
  }
  .row{display:flex;gap:8px;align-items:center}
  .row .small{width:48px;padding:8px}
  .song{padding:10px;border-radius:8px;background:#171717;margin:8px 0;text-align:left}
  .song .title{font-weight:700}
  .song .meta{font-size:0.9rem;color:#ddd;margin-top:6px}
  #burger{font-size:1.4rem;background:none;border:none;color:#fff;cursor:pointer;padding:6px 8px}
  #account-panel{position:fixed;top:58px;right:12px;width:300px;background:#141414;padding:12px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,0.6);display:none;z-index:1100}
  #account-panel h4{margin:0 0 8px 0}
  #strum-highlight{font-size:1.5rem;margin:12px 0;letter-spacing:6px}
  #strum-highlight .step{padding:4px 6px;border-radius:4px;margin:0 4px;display:inline-block}
  #strum-highlight .current{outline:2px solid #fff}
  #chord-preview{margin-top:12px}
  #chord-preview img{width:120px;height:120px;object-fit:contain;display:block;margin:8px auto}
  @media (max-width:600px){
    .logo{font-size:1.05rem}
    main{padding:96px 12px}
    .chord-card{width:96px}
  }
  .light-mode{background:#fff;color:#fff}
  .light-mode .logo .hub{background:orange;color:black}
  .light-mode button{color:#000}
</style>
</head>
<body>

<header>
  <div class="logo">
    <span class="guitar">Guitar</span><span class="hub">Hub</span>
  </div>
  <div class="controls">
    <button id="dark-toggle" title="Toggle theme">üåó</button>
    <button id="burger" aria-label="Open account menu">‚ò∞</button>
  </div>
</header>

<div id="account-panel" aria-hidden="true">
  <h4>Account</h4>
  <p id="account-email">Not signed in</p>
  <div style="display:flex;gap:8px;margin-top:8px;">
    <button id="show-dashboard" class="ghost">Dashboard</button>
    <button id="signout-btn" class="ghost">Sign out</button>
  </div>
  <hr style="margin:10px 0;border-color:#222">
  <button id="change-pass" class="ghost" style="width:100%;margin-bottom:8px">Change password</button>
  <button id="delete-account" class="ghost" style="width:100%;color:#ff6666">Delete account</button>
</div>

<main>
  <div id="login-screen" class="card">
    <h1 style="margin:0 0 8px 0">Login</h1>
    <input id="email" type="email" placeholder="Email" autocomplete="username">
    <div class="row" style="align-items:center">
      <input id="password" type="password" placeholder="Password" autocomplete="current-password" style="flex:1">
      <button id="toggle-pass" class="ghost small" title="Show/Hide">üëÅÔ∏è</button>
    </div>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:8px">
      <button id="login-btn">Login</button>
      <button id="signup-btn" class="ghost">Sign up</button>
    </div>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:10px">
      <button id="continue-btn" class="ghost">Continue without account</button>
    </div>
    <p style="margin:12px 0 0 0"><a href="#" id="forgot-link" style="color:#ddd">Forgot password?</a></p>
    <p id="auth-msg" style="color:#f88;margin-top:8px"></p>
  </div>

  <div id="main-menu" class="card hidden">
    <h2 style="margin-top:0">Main Menu</h2>
    <div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center">
      <button id="btn-chords">View Chords</button>
      <button id="btn-practice">Practice Chords</button>
      <button id="btn-strum">Practice Strum</button>
      <button id="btn-quiz">Chord Recognition Quiz</button>
      <button id="btn-learn-songs" class="ghost">Learn Songs</button>
      <button id="btn-tune" class="ghost">Tune with GuitarTuna</button>
    </div>
  </div>

  <div id="chords" class="card hidden">
    <h2 style="margin-top:0">Basic Chords</h2>
    <div class="chord-grid" id="chord-grid"></div>
    <button class="back-btn" onclick="goBack()">‚¨Ö Back</button>
  </div>

  <div id="practice" class="card hidden">
    <h2 style="margin-top:0">Practice Chords (Random)</h2>
    <div id="practice-chord-display" style="font-size:2rem;margin:16px"></div>
    <div style="display:flex;gap:8px;justify-content:center">
      <button id="next-chord">Next Chord</button>
      <button id="play-chord" class="ghost">Play (placeholder)</button>
    </div>
    <p id="practice-feedback" style="margin-top:10px"></p>
    <button class="back-btn" onclick="goBack()">‚¨Ö Back</button>
  </div>

  <div id="strum" class="card hidden">
    <h2 style="margin-top:0">Practice Strum</h2>
    <input id="song-search" type="text" placeholder="Search songs..." style="margin-bottom:12px" />
    <div id="song-list" style="max-height:360px;overflow:auto;padding-right:6px"></div>
    <div style="margin-top:12px">
      <p id="song-pattern" style="font-weight:700">Pattern: ‚Äî</p>
      <div style="display:flex;gap:8px;justify-content:center;margin-top:8px">
        <button id="start-mic" class="ghost">Start Mic Test</button>
        <button id="start-strum-chord" class="ghost">Start Strum Practice (Chords)</button>
        <button id="stop-mic" class="ghost">Stop Mic</button>
      </div>
      <p id="strum-feedback" style="margin-top:8px"></p>
      <div id="strum-highlight" aria-hidden="false"></div>
      <div id="chord-preview"></div>
    </div>
    <button class="back-btn" onclick="goBack()">‚¨Ö Back</button>
  </div>

  <div id="quiz" class="card hidden">
    <h2 style="margin-top:0">Chord Recognition Quiz</h2>
    <div style="margin-bottom:12px">
      <button id="start-quiz">Start Quiz</button>
      <button id="reset-quiz" class="ghost" style="display:none">Reset</button>
    </div>
    <div id="quiz-area" class="hidden" style="text-align:center">
      <div class="timer" id="timer">5</div>
      <div id="quiz-image" style="margin:8px"></div>
      <div id="quiz-options" style="max-width:420px;margin:0 auto;text-align:center"></div>
      <p id="quiz-progress" style="margin-top:8px"></p>
    </div>
    <div id="quiz-result" class="hidden" style="margin-top:12px;font-weight:700"></div>
    <button class="back-btn" onclick="goBack()">‚¨Ö Back</button>
  </div>

  <div id="dashboard" class="card hidden">
    <h2 style="margin-top:0">Dashboard</h2>
    <p>Strum Accuracy: <span id="dash-strum">0%</span></p>
    <p>Quiz Score History: <span id="dash-quiz">N/A</span></p>
    <button class="back-btn" onclick="goBack()">‚¨Ö Back</button>
  </div>
</main>

<script type="module">
  // Firebase imports (kept; working login previously)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail, onAuthStateChanged, updatePassword, deleteUser } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDkMmF78dFu2dmuzka6xuwpLRD5NRCCJtY",
    authDomain: "guitar-hub-25dfa.firebaseapp.com",
    projectId: "guitar-hub-25dfa",
    storageBucket: "guitar-hub-25dfa.appspot.com",
    messagingSenderId: "36479296604",
    appId: "1:36479296604:web:5dbcfb2aec3912f8ba7299",
    measurementId: "G-N4HZW695LF"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  // Panels
  const loginScreen = document.getElementById("login-screen");
  const mainMenu = document.getElementById("main-menu");
  const chordsPanel = document.getElementById("chords");
  const practicePanel = document.getElementById("practice");
  const strumPanel = document.getElementById("strum");
  const quizPanel = document.getElementById("quiz");
  const dashboardPanel = document.getElementById("dashboard");
  const accountPanel = document.getElementById("account-panel");

  // Inputs / buttons
  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");
  const authMsg = document.getElementById("auth-msg");
  const burgerBtn = document.getElementById("burger");
  const accountEmail = document.getElementById("account-email");

  // Basic chord list (expanded later)
  const allChords = ["C","Cm","D","Dm","E","Em","F","Fm","G","Gm","A","Am","B","Bm","F#","F#m","C#","C#m","G#","G#m","D#","D#m","A#","A#m","Cmaj7","D7","E7","A7"];
  // map chord names to image filenames in /image folder: c.png, fsharp.png, fsharpm.png etc.
  function chordToFilename(chord){
    // e.g. "F#" -> "fsharp.png"; "F#m" -> "fsharpm.png"; "C" -> "c.png"; "Cmaj7" -> "cmaj7.png"
    let name = chord.replace(/#/g, "sharp").replace(/\+/g, "plus").replace(/\s+/g,"").toLowerCase();
    // remove characters illegal in filenames if any
    name = name.replace(/[^a-z0-9-_]/g, '');
    return `image/${name}.png`;
  }

  // Dark Mode toggle - keep text white in light mode as requested (so we intentionally don't invert all text)
  document.getElementById("dark-toggle").addEventListener("click", ()=> {
    document.body.classList.toggle("light-mode");
  });

  burgerBtn.addEventListener("click", ()=>{
    accountPanel.style.display = accountPanel.style.display === "block" ? "none" : "block";
  });

  document.getElementById("toggle-pass").addEventListener("click", ()=>{
    passwordInput.type = passwordInput.type === "password" ? "text" : "password";
  });

  document.getElementById("signup-btn").addEventListener("click", async ()=>{
    const email = emailInput.value.trim();
    const pw = passwordInput.value;
    if(!email || !pw){ authMsg.textContent = "Provide email & password to sign up."; return; }
    try{
      await createUserWithEmailAndPassword(auth, email, pw);
      authMsg.style.color = "#8f8"; authMsg.textContent = "Account created, signed in.";
    }catch(e){ authMsg.style.color="#f88"; authMsg.textContent = e.message; }
  });

  document.getElementById("login-btn").addEventListener("click", async ()=>{
    const email = emailInput.value.trim();
    const pw = passwordInput.value;
    if(!email || !pw){ authMsg.textContent = "Enter email & password to sign in."; authMsg.style.color="#f88"; return; }
    try{
      await signInWithEmailAndPassword(auth, email, pw);
      authMsg.style.color="#8f8"; authMsg.textContent = "Signed in.";
    }catch(e){ authMsg.style.color="#f88"; authMsg.textContent = e.message; }
  });

  document.getElementById("continue-btn").addEventListener("click", ()=>{
    loginScreen.classList.add("hidden");
    mainMenu.classList.remove("hidden");
    accountEmail.textContent = "Guest";
  });

  document.getElementById("forgot-link").addEventListener("click", async (ev)=>{
    ev.preventDefault();
    const email = emailInput.value.trim();
    if(!email){ authMsg.style.color="#f88"; authMsg.textContent = "Enter your email then click Reset."; return; }
    try{
      await sendPasswordResetEmail(auth, email);
      authMsg.style.color="#8f8"; authMsg.textContent = "Reset email sent (check inbox).";
    }catch(e){ authMsg.style.color="#f88"; authMsg.textContent = e.message; }
  });

  document.getElementById("signout-btn").addEventListener("click", async ()=>{
    try{ await signOut(auth); loginScreen.classList.remove("hidden"); mainMenu.classList.add("hidden"); accountPanel.style.display='none'; accountEmail.textContent='Not signed in'; authMsg.textContent=''; }
    catch(e){ console.error(e); }
  });

  document.getElementById("change-pass").addEventListener("click", async ()=>{
    const newPass = prompt("Enter new password (min 6 chars):");
    if(!newPass) return;
    if(!auth.currentUser){ alert("Sign in required to change password."); return; }
    try{
      await updatePassword(auth.currentUser, newPass);
      alert("Password updated.");
    }catch(e){ alert(e.message); }
  });

  document.getElementById("delete-account").addEventListener("click", async ()=>{
    if(!auth.currentUser){ alert("Not signed in."); return; }
    if(!confirm("Delete your account permanently?")) return;
    try{
      await deleteUser(auth.currentUser);
      alert("Account deleted.");
      loginScreen.classList.remove("hidden"); mainMenu.classList.add("hidden");
    }catch(e){
      alert("Delete failed: "+e.message);
    }
  });

  onAuthStateChanged(auth, (user)=>{
    if(user){
      accountEmail.textContent = user.email || "User";
      loginScreen.classList.add("hidden");
      mainMenu.classList.remove("hidden");
      authMsg.textContent = "";
    }
  });

  // --- Main Menu Buttons ---
  document.getElementById("btn-chords").addEventListener("click", ()=>{
    loginScreen.classList.add("hidden"); mainMenu.classList.add("hidden"); chordsPanel.classList.remove("hidden");
  });
  document.getElementById("btn-practice").addEventListener("click", ()=>{
    loginScreen.classList.add("hidden"); mainMenu.classList.add("hidden"); practicePanel.classList.remove("hidden");
    // ensure initial chord displayed on entering practice
    showNextPracticeChord();
  });
  document.getElementById("btn-strum").addEventListener("click", ()=>{
    loginScreen.classList.add("hidden"); mainMenu.classList.add("hidden"); strumPanel.classList.remove("hidden");
    // render songs and reset strum UI
    renderSongs();
    updateStrumUI();
  });
  document.getElementById("btn-quiz").addEventListener("click", ()=>{
    loginScreen.classList.add("hidden"); mainMenu.classList.add("hidden"); quizPanel.classList.remove("hidden");
  });
  document.getElementById("btn-learn-songs").addEventListener("click", ()=>{ alert("Learn Songs: coming soon."); });
  document.getElementById("btn-tune").addEventListener("click", ()=>{ window.open('https://www.guitartuna.com/', '_blank'); });

  document.getElementById("show-dashboard").addEventListener("click", ()=>{
    loginScreen.classList.add("hidden");
    mainMenu.classList.add("hidden");
    chordsPanel.classList.add("hidden");
    practicePanel.classList.add("hidden");
    strumPanel.classList.add("hidden");
    quizPanel.classList.add("hidden");
    dashboardPanel.classList.remove("hidden");
    accountPanel.style.display = 'none';
    loadDashboardDataToUI();
  });

  function goBack(){
    chordsPanel.classList.add("hidden");
    practicePanel.classList.add("hidden");
    strumPanel.classList.add("hidden");
    quizPanel.classList.add("hidden");
    dashboardPanel.classList.add("hidden");
    mainMenu.classList.remove("hidden");
    // stop microphone if active
    stopMicIfActive();
  }

  // --- Chords Grid ---
  const chordGrid = document.getElementById("chord-grid");
  function populateChordGrid(){
    chordGrid.innerHTML = "";
    // show allChords in grid
    allChords.forEach(chord=>{
      const card = document.createElement("div");
      card.className = "chord-card";
      const fname = chordToFilename(chord);
      card.innerHTML = `<div style="font-weight:700">${chord}</div>
        <img src="${fname}" alt="${chord} chord" onerror="this.onerror=null;this.src='image/placeholder.png'">`;
      chordGrid.appendChild(card);
    });
  }
  populateChordGrid();

  // --- Practice Chords Logic (fixed: initial chord and next) ---
  const practiceChords = allChords.slice(); // use full list
  let currentPracticeChord = null;
  function showNextPracticeChord(){
    currentPracticeChord = practiceChords[Math.floor(Math.random()*practiceChords.length)];
    document.getElementById("practice-chord-display").textContent = currentPracticeChord;
    // show image in feedback area
    const imgPath = chordToFilename(currentPracticeChord);
    document.getElementById("practice-feedback").innerHTML = `<img src="${imgPath}" alt="${currentPracticeChord}" style="width:150px" onerror="this.onerror=null;this.style.display='none'">`;
  }
  document.getElementById("next-chord").addEventListener("click", showNextPracticeChord);

  // dummy play button placeholder (could be replaced with audio samples)
  document.getElementById("play-chord").addEventListener("click", ()=>{
    const chord = currentPracticeChord || practiceChords[0];
    alert(`(Placeholder) Would play audio for ${chord}`);
  });

  // --- Song List & Strum (fixed songs array and select) ---
  const songs = [
    {name:"Wonderwall - Oasis", chords:"Em7 G Dsus4 A7sus4", pattern:["‚Üì","‚Üì","‚Üë","‚Üë","‚Üì","‚Üë"]},
    {name:"Knockin' on Heaven's Door - Bob Dylan", chords:"G D Am G D C", pattern:["‚Üì","‚Üì","‚Üë","‚Üì","‚Üë"]},
    {name:"Zombie - The Cranberries", chords:"Em C G D", pattern:["‚Üì","‚Üë","‚Üì","‚Üë"]},
    {name:"Let It Be - The Beatles", chords:"C G Am F", pattern:["‚Üì","‚Üì","‚Üë","‚Üì","‚Üì","‚Üë","‚Üì","‚Üì","‚Üë"]},
    {name:"Perfect - Ed Sheeran", chords:"G Em C D", pattern:["‚Üì","‚Üì","pauline palad","‚Üë","‚Üì","‚Üë"]},
    {name:"Chasing Cars - Snow Patrol", chords:"A E D", pattern:["‚Üì","‚Üë","‚Üì","‚Üë"]},
    {name:"Love Yourself - Justin Bieber", chords:"C G Am F", pattern:["‚Üì","‚Üë","‚Üì","‚Üë"]},
    {name:"All of Me - John Legend", chords:"Em C G D Am", pattern:["‚Üì","‚Üì","‚Üë","‚Üë","‚Üì","‚Üë"]}
  ];

  const songList = document.getElementById("song-list");
  const songSearch = document.getElementById("song-search");
  function renderSongs(filter=""){
    songList.innerHTML = "";
    const q = filter.trim().toLowerCase();
    songs.forEach(s=>{
      if(q && !s.name.toLowerCase().includes(q)) return;
      const div = document.createElement("div");
      div.className = "song";
      div.innerHTML = `<div class="title">${s.name}</div>
        <div class="meta">Chords: ${s.chords}<br>Strum: ${s.pattern.join(' ')}</div>
        <div style="margin-top:8px"><button class="ghost select-song">Select</button></div>`;
      const btn = div.querySelector(".select-song");
      btn.addEventListener("click", ()=> selectSong(s));
      songList.appendChild(div);
    });
  }

  function selectSong(song){
    document.getElementById("song-pattern").textContent = `Pattern: ${song.pattern.join(' ')} ‚Äî Chords: ${song.chords}`;
    // store selected pattern for strum detection
    currentPattern = song.pattern.slice();
    currentStrumIndex = 0;
    updateStrumUI();
    document.getElementById("strum-feedback").textContent = '';
  }

  songSearch && songSearch.addEventListener("input", ()=> renderSongs(songSearch.value));
  renderSongs();

  // --- Quiz (use full chord list; images loaded from folder) ---
  const quizChords = allChords.slice(); // include all chords
  let quizScore = 0;
  let quizCount = 0;
  const quizTotal = 10;
  const quizArea = document.getElementById("quiz-area");
  const quizResult = document.getElementById("quiz-result");
  const quizImage = document.getElementById("quiz-image");
  const quizOptions = document.getElementById("quiz-options");
  const timerEl = document.getElementById("timer");
  let quizTimer;
  let currentQuizChord;

  function startQuiz(){
    quizScore = 0;
    quizCount = 0;
    quizResult.classList.add("hidden");
    quizArea.classList.remove("hidden");
    nextQuizChord();
  }

  document.getElementById("start-quiz").addEventListener("click", ()=>{
    startQuiz();
    document.getElementById("start-quiz").style.display = "none";
    document.getElementById("reset-quiz").style.display = "inline-block";
  });

  document.getElementById("reset-quiz").addEventListener("click", ()=>{
    document.getElementById("start-quiz").style.display = "inline-block";
    document.getElementById("reset-quiz").style.display = "none";
    quizArea.classList.add("hidden");
    quizResult.classList.add("hidden");
  });

  function nextQuizChord(){
    clearInterval(quizTimer);
    if(quizCount >= quizTotal){
      quizArea.classList.add("hidden");
      quizResult.classList.remove("hidden");
      quizResult.textContent = `Quiz Completed! Score: ${quizScore}/${quizTotal}`;
      // record to dashboard history
      saveQuizScore(quizScore);
      loadDashboardDataToUI();
      document.getElementById("start-quiz").style.display = "inline-block";
      document.getElementById("reset-quiz").style.display = "none";
      return;
    }
    currentQuizChord = quizChords[Math.floor(Math.random()*quizChords.length)];
    // show image (attempting to load image)
    const img = document.createElement("img");
    img.src = chordToFilename(currentQuizChord);
    img.alt = currentQuizChord;
    img.style.width = "160px";
    img.onerror = function(){ this.onerror=null; this.style.display='none'; quizImage.textContent = currentQuizChord; };
    quizImage.innerHTML = "";
    quizImage.appendChild(img);

    quizOptions.innerHTML = "";
    const choices = randomChoices(quizChords, currentQuizChord, 4);
    choices.forEach(c=>{
      const btn = document.createElement("button");
      btn.textContent = c;
      btn.addEventListener("click", ()=>{
        if(c===currentQuizChord) quizScore++;
        quizCount++;
        nextQuizChord();
      });
      quizOptions.appendChild(btn);
    });
    startQuizTimer();
  }

  function startQuizTimer(){
    let time = 10;
    timerEl.textContent = time;
    clearInterval(quizTimer);
    quizTimer = setInterval(()=>{
      time--;
      timerEl.textContent = time;
      if(time<=0){
        clearInterval(quizTimer);
        quizCount++;
        nextQuizChord();
      }
    },1000);
  }

  function randomChoices(list, answer, n){
    // create a shuffled copy; ensure answer included
    const copy = list.slice().sort(()=>Math.random()-0.5);
    let choices = copy.slice(0, n);
    if(!choices.includes(answer)){
      choices[Math.floor(Math.random()*n)] = answer;
    }
    return choices;
  }

  // --- Dashboard storage & UI ---
  function saveQuizScore(score){
    const hist = JSON.parse(localStorage.getItem("quizHistory")||"[]");
    hist.push({score, at: Date.now()});
    // keep last 20
    if(hist.length>20) hist.splice(0, hist.length-20);
    localStorage.setItem("quizHistory", JSON.stringify(hist));
  }

  function saveStrumAccuracy(accuracy){
    // store averaged or last; for simplicity save last
    localStorage.setItem("lastStrumAccuracy", String(accuracy));
  }

  function loadDashboardDataToUI(){
    const qh = JSON.parse(localStorage.getItem("quizHistory")||"[]");
    const dashQuiz = document.getElementById("dash-quiz");
    dashQuiz.textContent = qh.length ? qh.map(h=>h.score).join(", ") : "N/A";
    const sa = localStorage.getItem("lastStrumAccuracy") || "0";
    document.getElementById("dash-strum").textContent = sa + "%";
  }

  function updateStrumDashboard(accuracy){
    document.getElementById("dash-strum").textContent = accuracy + "%";
    saveStrumAccuracy(accuracy);
  }

  // --- STRUM DETECTION & PRACTICE (improved) ---
  let audioContext, analyser, dataArray, source;
  let currentPattern = ["‚Üì","‚Üì","‚Üë","‚Üì"]; // default/example
  let currentStrumIndex = 0;
  let hits = 0;
  let totalStrums = 0;
  let strumActive = false;
  const strumFeedbackEl = document.getElementById("strum-feedback");
  const startMicBtn = document.getElementById("start-mic");
  const stopMicBtn = document.getElementById("stop-mic");
  const startStrumChordBtn = document.getElementById("start-strum-chord");
  let micStream = null;
  let lastRms = 0;
  let lastTime = 0;
  let chordPracticeActive = false;
  let chordPracticeSequence = []; // e.g. chords to practice
  let chordPracticeIndex = 0;

  function avgAbs(arr){
    let sum = 0;
    for(let i=0;i<arr.length;i++) sum += Math.abs(arr[i]-128);
    return sum/arr.length;
  }

  async function startMic(){
    try{
      if(!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
      micStream = await navigator.mediaDevices.getUserMedia({audio:true});
      source = audioContext.createMediaStreamSource(micStream);
      analyser = audioContext.createAnalyser();
      analyser.fftSize = 2048;
      source.connect(analyser);
      dataArray = new Uint8Array(analyser.frequencyBinCount);

      currentStrumIndex = 0;
      hits = 0;
      totalStrums = 0;
      strumActive = true;
      chordPracticeActive = false;
      lastRms = 0;
      lastTime = performance.now();
      updateStrumUI();
      strumFeedbackEl.textContent = "Mic active ‚Äî strum now!";
      requestAnimationFrame(checkStrum);
    }catch(e){
      strumFeedbackEl.textContent = "Mic error: " + e.message;
    }
  }

  function stopMicIfActive(){
    try{
      if(micStream){
        micStream.getTracks().forEach(t=>t.stop());
        micStream = null;
      }
      if(source){ source.disconnect(); source=null; }
      if(analyser){ analyser.disconnect(); analyser=null; }
      strumActive = false;
      chordPracticeActive = false;
      strumFeedbackEl.textContent = "Mic stopped.";
    }catch(e){}
  }

  stopMicBtn.addEventListener("click", stopMicIfActive);
  startMicBtn.addEventListener("click", startMic);

  // Start a chord strum practice sequence (random chords)
  startStrumChordBtn.addEventListener("click", ()=>{
    // create a sequence of 4 random chords
    chordPracticeSequence = [];
    for(let i=0;i<4;i++) chordPracticeSequence.push(allChords[Math.floor(Math.random()*allChords.length)]);
    chordPracticeIndex = 0;
    chordPracticeActive = true;
    currentPattern = ["‚Üì","‚Üì","‚Üë","‚Üì"]; // example pattern for each chord
    currentStrumIndex = 0;
    hits = 0;
    totalStrums = 0;
    strumActive = true;
    updateChordPreview();
    updateStrumUI();
    strumFeedbackEl.textContent = "Strum practice started for chords sequence.";
    // ensure mic running
    if(!micStream) startMic();
  });

  function updateChordPreview(){
    const preview = document.getElementById("chord-preview");
    preview.innerHTML = "";
    if(chordPracticeActive){
      const chord = chordPracticeSequence[chordPracticeIndex];
      const img = document.createElement("img");
      img.src = chordToFilename(chord);
      img.alt = chord;
      img.onerror = function(){ this.onerror=null; this.style.display='none'; preview.textContent = chord; };
      preview.appendChild(img);
    }
  }

  function updateStrumUI(){
    const highlight = document.getElementById("strum-highlight");
    highlight.innerHTML = "";
    (currentPattern || []).forEach((s,i)=>{
      const span = document.createElement("span");
      span.className = "step";
      if(i===currentStrumIndex) span.classList.add("current");
      span.textContent = s;
      highlight.appendChild(span);
    });
  }

  function determineDirectionFromWave(arr){
    // Heuristic: estimate whether the initial average slope of signal is "down" or "up".
    // We'll compute tiny window RMS and compare leading vs trailing average to guess direction.
    // This is a simple heuristic and will not be perfect in all environments.
    const n = arr.length;
    let first = 0, last = 0, half = Math.floor(n/2);
    for(let i=0;i<half;i++) first += arr[i];
    for(let i=half;i<n;i++) last += arr[i];
    first /= half; last /= (n-half);
    // if overall waveform tends to go up in the buffer, call it "‚Üë" else "‚Üì"
    return last > first ? "‚Üë" : "‚Üì";
  }

  function checkStrum(){
    if(!strumActive || !analyser) return;
    analyser.getByteTimeDomainData(dataArray);
    const rms = avgAbs(dataArray);
    const now = performance.now();
    // detect a transient spike compared to lastRms
    if(rms > 12 && rms > lastRms * 1.6){ // transient detected
      // decide direction heuristically
      const dir = determineDirectionFromWave(dataArray);
      processDetectedStrum(dir);
    }
    lastRms = (lastRms*0.9) + (rms*0.1);
    lastTime = now;
    requestAnimationFrame(checkStrum);
  }

  function processDetectedStrum(detected){
    totalStrums++;
    const expected = currentPattern[currentStrumIndex];
    const highlight = document.getElementById("strum-highlight");
    // mark current step temporarily
    const steps = highlight.querySelectorAll(".step");
    if(detected === expected){
      hits++;
      // flash green
      if(steps[currentStrumIndex]) steps[currentStrumIndex].style.background = "#2b8";
      strumFeedbackEl.textContent = `Good ‚Äî detected ${detected}`;
      currentStrumIndex++;
    } else {
      // flash red
      if(steps[currentStrumIndex]) steps[currentStrumIndex].style.background = "#d66";
      strumFeedbackEl.textContent = `Wrong ‚Äî detected ${detected} (expected ${expected})`;
    }
    // small timeout to reset color of previous step (so next highlight is visible)
    setTimeout(()=> {
      if(steps[currentStrumIndex-1]) steps[currentStrumIndex-1].style.background = "transparent";
    }, 400);

    const accuracy = totalStrums > 0 ? Math.round((hits/totalStrums)*100) : 0;
    updateStrumDashboard(accuracy);

    // if chord practice active, when pattern completed advance chords
    if(chordPracticeActive && currentStrumIndex >= currentPattern.length){
      // completed pattern for current chord
      strumFeedbackEl.textContent = `Pattern completed for ${chordPracticeSequence[chordPracticeIndex]}`;
      currentStrumIndex = 0;
      chordPracticeIndex++;
      if(chordPracticeIndex >= chordPracticeSequence.length){
        chordPracticeActive = false;
        strumActive = false;
        strumFeedbackEl.textContent = "Chord strum practice complete!";
        updateChordPreview();
        return;
      } else {
        updateChordPreview();
        updateStrumUI();
      }
    } else {
      updateStrumUI();
    }
  }

  // --- Helper utilities & init values ---
  function updateStrumUIImmediately(){
    // called on entering strum panel
    updateStrumUI();
    document.getElementById("chord-preview").innerHTML = "";
  }
  updateStrumUIImmediately();

  function renderInitialState(){
    // show an initial practice chord so user doesn't see an empty screen
    showNextPracticeChord();
    loadDashboardDataToUI();
  }
  renderInitialState();

  // Stop mic when unloading
  window.addEventListener("beforeunload", stopMicIfActive);

  // Expose some functions for debugging in console (optional)
  window.__gh = {
    showNextPracticeChord,
    startMic,
    stopMicIfActive,
    updateStrumUI,
    populateChordGrid
  };

</script>
</body>
</html>

