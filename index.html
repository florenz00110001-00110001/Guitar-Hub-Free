<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Guitar Hub Trainer - Ultimate Edition</title>
<style>
  :root{
    --bg:#111;
    --panel:#000;
    --accent:orange;
    --muted:#222;
    --text:#fff;
    --card:#1a1a1a;
    --white:#fff;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:Arial, sans-serif;
    background:var(--bg);
    color:var(--text);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    text-align:center;
    transition:background 0.25s,color 0.25s;
    -webkit-user-select:none; user-select:none; /* make most text non-selectable */
  }
  header{
    width:100%;
    background:var(--panel);
    padding:10px 18px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    position:fixed;
    top:0; left:0;
    z-index:1000;
    box-shadow:0 2px 8px rgba(0,0,0,0.6);
  }
  .logo{display:flex;align-items:center;font-weight:700;font-size:1.25rem;color:var(--white)}
  .logo .guitar{color:var(--white)}
  .logo .hub{color:black;background:orange;padding:4px 8px;border-radius:6px;margin-left:8px}
  .controls{display:flex;gap:8px;align-items:center}
  main{padding:92px 14px 40px; max-width:980px;margin:0 auto;transition:all 0.25s}
  button{padding:10px 16px;border-radius:8px;border:none;background:var(--accent);color:#000;font-weight:600;cursor:pointer;transition:all 0.2s}
  button.ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:8px}
  button:hover{opacity:0.92}
  .back-btn{background:#444;color:#fff}
  .card{background:var(--muted);padding:14px;border-radius:10px;margin:12px 0;box-shadow:0 6px 16px rgba(0,0,0,0.6);transition:all 0.3s ease}
  .hidden{display:none;opacity:0;transition:opacity 0.3s ease}
  .visible{display:block;opacity:1;transition:opacity 0.3s ease}
  .chord-grid{display:flex;flex-wrap:wrap;gap:14px;justify-content:center;padding:8px}
  .chord-card{width:120px;background:#222;padding:10px;border-radius:10px;box-shadow:0 6px 14px rgba(0,0,0,0.6);text-align:center;transition:transform 0.2s}
  .chord-card:hover{transform:scale(1.05)}
  .chord-card img{width:100px;height:auto;display:block;margin:8px auto}
  .timer{font-weight:700;color:gold;font-size:1.2rem;margin:8px}
  #quiz-options button{display:block;width:100%;margin:8px 0;background:#333;color:#fff;padding:10px;border-radius:8px}
  input[type="text"],input[type="email"],input[type="password"],textarea,select{
    width:100%;padding:10px;border-radius:8px;border:none;background:#1b1b1b;color:#fff;margin-bottom:10px;font-size:1rem;
  }
  .row{display:flex;gap:8px;align-items:center}
  .row .small{width:48px;padding:8px}
  .song{padding:10px;border-radius:8px;background:#171717;margin:8px 0;text-align:left;color:var(--white)}
  .song .title{font-weight:700}
  .song .meta{font-size:0.9rem;color:#ddd;margin-top:6px}
  #burger{font-size:1.4rem;background:none;border:none;color:#fff;cursor:pointer;padding:6px 8px}
  #account-panel{position:fixed;top:58px;right:12px;width:320px;background:#141414;padding:12px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,0.6);display:none;z-index:1100;color:var(--white)}
  #account-panel h4{margin:0 0 8px 0}
  #strum-highlight{font-size:1.5rem;margin:12px 0;letter-spacing:6px;color:var(--white)}
  .no-select{user-select:none;-webkit-user-select:none}
  .admin-badge{background:gold;color:black;padding:4px 8px;border-radius:6px;margin-left:8px;font-weight:700}
  .metronome-visual{height:40px;position:relative;margin:12px 0;}
  .metronome-ball{width:14px;height:14px;border-radius:50%;background:var(--accent);position:absolute;left:50%;transform:translateX(-50%)}
  .metronome-line{height:4px;background:#444;border-radius:2px;margin-top:18px}
  .badge-list button{margin:4px}
  .hidden-input{display:none}
  .editable-field{background:#111;padding:8px;border-radius:6px;color:var(--white)}
  @media (max-width:600px){
    .logo{font-size:1.05rem}
    main{padding:96px 12px}
    .chord-card{width:96px}
  }
  .light-mode{background:#fff;color:#000}
  .light-mode .logo .hub{background:orange;color:black}
  .light-mode button{color:#000}
  /* make certain texts always white even in light mode */
  .force-white{color:var(--white) !important}
</style>
</head>
<body>

<header>
  <div class="logo">
    <span class="guitar">Guitar</span><span class="hub">Hub-Ultimate</span>
  </div>
  <div class="controls">
    <button id="dark-toggle" title="Toggle theme">üåó</button>
    <button id="burger" aria-label="Open account menu">‚ò∞</button>
  </div>
</header>

<!-- Account / small menu -->
<div id="account-panel" aria-hidden="true">
  <h4>Account <span id="account-badge" class=""></span></h4>
  <p id="account-email">Not signed in</p>
  <div style="display:flex;gap:8px;margin-top:8px;">
    <button id="show-dashboard" class="ghost">Dashboard</button>
    <button id="signout-btn" class="ghost">Sign out</button>
  </div>
  <hr style="margin:10px 0;border-color:#222">
  <button id="change-pass" class="ghost" style="width:100%;margin-bottom:8px">Change password</button>
  <button id="delete-account" class="ghost" style="width:100%;color:#ff6666">Delete account</button>
</div>

<main>
  <!-- LOGIN -->
  <div id="login-screen" class="card">
    <h1 style="margin:0 0 8px 0" class="force-white">Login</h1>
    <input id="email" type="email" placeholder="Email" autocomplete="username">
    <div class="row" style="align-items:center">
      <input id="password" type="password" placeholder="Password" autocomplete="current-password" style="flex:1">
      <button id="toggle-pass" class="ghost small" title="Show/Hide">üëÅÔ∏è</button>
    </div>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:8px">
      <button id="login-btn">Login</button>
      <button id="signup-btn" class="ghost">Sign up</button>
    </div>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:10px">
      <button id="continue-btn" class="ghost">Continue without account</button>
    </div>
    <p style="margin:12px 0 0 0"><a href="#" id="forgot-link" style="color:#ddd">Forgot password?</a></p>
    <p id="auth-msg" style="color:#f88;margin-top:8px"></p>
  </div>

  <!-- MAIN MENU -->
  <div id="main-menu" class="card hidden">
    <h2 style="margin-top:0" class="force-white">Main Menu</h2>
    <div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center">
      <button id="btn-chords">View Chords</button>
      <button id="btn-practice">Practice Chords</button>
      <button id="btn-strum">Practice Strum</button>
      <button id="btn-quiz">Chord Recognition Quiz</button>
      <button id="btn-learn-songs" class="ghost">Learn Songs</button>
      <button id="btn-tune" class="ghost">Tune with GuitarTuna</button>
      <button id="btn-metronome" class="ghost">Metronome</button>
      <button id="btn-leaderboard" class="ghost">Leaderboard</button>
    </div>
  </div>

  <!-- CHORDS -->
  <div id="chords" class="card hidden">
    <h2 style="margin-top:0" class="force-white">Basic Chords</h2>
    <div class="chord-grid" id="chord-grid"></div>
    <button class="back-btn" id="back-from-chords">‚¨Ö Back</button>
  </div>

  <!-- PRACTICE -->
  <div id="practice" class="card hidden">
    <h2 style="margin-top:0" class="force-white">Practice Chords (Random)</h2>
    <div id="practice-chord-display" style="font-size:2rem;margin:16px;color:var(--white)"></div>
    <div style="display:flex;gap:8px;justify-content:center">
      <button id="next-chord">Next Chord</button>
      <button id="play-chord" class="ghost">Play Chord</button>
    </div>
    <p id="practice-feedback" style="margin-top:10px;color:var(--white)"></p>
    <button class="back-btn" id="back-from-practice">‚¨Ö Back</button>
  </div>

  <!-- STRUM -->
  <div id="strum" class="card hidden">
    <h2 style="margin-top:0" class="force-white">Practice Strum</h2>
    <input id="song-search" type="text" placeholder="Search songs..." style="margin-bottom:12px;color:var(--white);background:#222"/>
    <div id="song-list" style="max-height:360px;overflow:auto;padding-right:6px"></div>
    <div style="margin-top:12px">
      <p id="song-pattern" style="font-weight:700;color:var(--white)">Pattern: ‚Äî</p>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
        <button id="start-mic" class="ghost">Start Mic Test</button>
        <button id="start-strum-practice" class="ghost">Start Strum Practice</button>
        <button id="stop-mic" class="ghost">Stop Mic</button>
      </div>
      <p id="strum-feedback" style="margin-top:8px;color:var(--white)"></p>
      <div id="strum-highlight" class="no-select"></div>
    </div>
    <button class="back-btn" id="back-from-strum">‚¨Ö Back</button>
  </div>

  <!-- QUIZ -->
  <div id="quiz" class="card hidden">
    <h2 style="margin-top:0" class="force-white">Chord Recognition Quiz</h2>
    <div style="margin-bottom:12px">
      <button id="start-quiz">Start Quiz</button>
      <button id="reset-quiz" class="ghost" style="display:none">Reset</button>
    </div>
    <div id="quiz-area" class="hidden" style="text-align:center">
      <div class="timer" id="timer">5</div>
      <div id="quiz-image" style="margin:8px"></div>
      <div id="quiz-options" style="max-width:420px;margin:0 auto;text-align:center"></div>
      <p id="quiz-progress" style="margin-top:8px"></p>
    </div>
    <div id="quiz-result" class="hidden" style="margin-top:12px;font-weight:700"></div>
    <button class="back-btn" id="back-from-quiz">‚¨Ö Back</button>
  </div>

  <!-- METRONOME -->
  <div id="metronome" class="card hidden">
    <h2 style="margin-top:0" class="force-white">Metronome</h2>
    <div>
      <label class="force-white">BPM: <span id="bpm-display">100</span></label>
      <input id="bpm" type="range" min="40" max="240" value="100" />
    </div>
    <div class="metronome-visual">
      <div class="metronome-ball" id="metronome-ball"></div>
      <div class="metronome-line"></div>
    </div>
    <div style="display:flex;gap:8px;justify-content:center">
      <button id="start-metronome">Start</button>
      <button id="stop-metronome" class="ghost">Stop</button>
    </div>
    <button class="back-btn" id="back-from-metronome">‚¨Ö Back</button>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard" class="card hidden">
    <h2 style="margin-top:0" class="force-white">Dashboard</h2>
    <p>Strum Accuracy: <span id="dash-strum">0%</span></p>
    <p>Quiz Score History: <span id="dash-quiz">N/A</span></p>
    <div id="dashboard-details"></div>
    <button class="back-btn" id="back-from-dashboard">‚¨Ö Back</button>
  </div>

  <!-- LEADERBOARD -->
  <div id="leaderboard" class="card hidden">
    <h2 style="margin-top:0" class="force-white">Leaderboard</h2>
    <div id="leaderboard-list"></div>
    <button class="back-btn" id="back-from-leaderboard">‚¨Ö Back</button>
  </div>

  <!-- ADMIN -->
  <div id="admin-panel" class="card hidden" style="margin-top:20px;">
    <h2 class="force-white">Admin Controls</h2>

    <h3 class="force-white">Add / Edit Song</h3>
    <div style="display:flex;gap:8px;">
      <input id="admin-song-name" placeholder="Song name">
      <input id="admin-song-author" placeholder="Author">
    </div>
    <div style="display:flex;gap:8px;">
      <input id="admin-song-chords" placeholder="Chords (space separated)">
      <input id="admin-song-capo" placeholder="Capo (leave empty if none)">
    </div>
    <input id="admin-song-pattern" placeholder="Strum pattern e.g. ‚Üì ‚Üì ‚Üë ‚Üë ‚Üì ‚Üë">
    <div style="display:flex;gap:8px;">
      <button id="admin-add-song">Add Song</button>
      <button id="admin-save-song" class="ghost">Save Edit</button>
      <button id="admin-bulk-toggle" class="ghost">Show Bulk Add</button>
    </div>

    <div id="admin-bulk" class="hidden" style="margin-top:10px;">
      <label class="force-white">Bulk add songs (paste one JSON-per-line or CSV "name|author|chords|capo|pattern")</label>
      <textarea id="admin-bulk-text" rows="6" placeholder='{"name":"Beautiful in White - Westlife","author":"Westlife","chords":"G D Em C","capo":"","pattern":"‚Üì ‚Üì ‚Üë ‚Üë ‚Üì ‚Üë"}'></textarea>
      <button id="admin-bulk-add">Bulk Add</button>
    </div>

    <h3 class="force-white">Admin Song List</h3>
    <div id="admin-song-list"></div>

    <h3 class="force-white">Manual User Override</h3>
    <input id="override-user" type="text" placeholder="Enter user email">
    <div style="display:flex;gap:6px;">
      <input id="override-streak" type="number" placeholder="Set streak">
      <input id="override-level" type="text" placeholder="Set level">
      <input id="override-highscore" type="number" placeholder="Set high score">
    </div>
    <button id="apply-override">Apply Changes</button>

    <h3 class="force-white">Badge Controls</h3>
    <div class="badge-list">
      <button class="ghost badge-btn" data-badge="Beginner">Beginner</button>
      <button class="ghost badge-btn" data-badge="Intermediate">Intermediate</button>
      <button class="ghost badge-btn" data-badge="Advance">Advance</button>
      <button class="ghost badge-btn" data-badge="Legend">Legend</button>
      <button class="ghost badge-btn" data-badge="Admin">Admin</button>
      <button class="ghost" id="custom-badge-btn">Custom Badge</button>
    </div>

    <button class="back-btn" id="back-from-admin">‚¨Ö Back</button>
  </div>

</main>

<!-- Firebase & App Logic -->
<script type="module">
/*
  FULL APP SCRIPT
  - Many handlers are implemented below
  - Where to edit:
     * FIREBASE config (if you want different project)
     * ADMIN_EMAIL constant (who gets admin panel)
     * Local image folder name ./image/ is used
     * Quiz timer change: QUIZ_TIMER_SECONDS
*/

  // --------- CONFIG ----------
  const IMAGE_FOLDER = "image"; // local folder for chord images (no trailing slash)
  const ADMIN_EMAIL = "flo***@gmail.com"; // set your admin email here (replace with actual) OR use the "admin" badge mapping
  const QUIZ_TIMER_SECONDS = 5;

  // Replace with your real Firebase config (I used your provided keys earlier)
  const firebaseConfig = {
    apiKey: "AIzaSyDkMmF78dFu2dmuzka6xuwpLRD5NRCCJtY",
    authDomain: "guitar-hub-25dfa.firebaseapp.com",
    projectId: "guitar-hub-25dfa",
    storageBucket: "guitar-hub-25dfa.firebasestorage.app",
    messagingSenderId: "36479296604",
    appId: "1:36479296604:web:5dbcfb2aec3912f8ba7299",
    measurementId: "G-N4HZW695LF"
  };

  // --------- FIREBASE INIT (CDN) ----------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail, onAuthStateChanged, updatePassword, deleteUser } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, getDocs, setDoc, doc, updateDoc, deleteDoc, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // --------- ELEMENTS ----------
  const loginScreen = document.getElementById("login-screen");
  const mainMenu = document.getElementById("main-menu");
  const chordsPanel = document.getElementById("chords");
  const practicePanel = document.getElementById("practice");
  const strumPanel = document.getElementById("strum");
  const quizPanel = document.getElementById("quiz");
  const metronomePanel = document.getElementById("metronome");
  const dashboardPanel = document.getElementById("dashboard");
  const adminPanel = document.getElementById("admin-panel");
  const leaderboardPanel = document.getElementById("leaderboard");

  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");
  const authMsg = document.getElementById("auth-msg");
  const burgerBtn = document.getElementById("burger");
  const accountPanel = document.getElementById("account-panel");
  const accountEmail = document.getElementById("account-email");
  const accountBadge = document.getElementById("account-badge");

  // --------- SOME STATE ----------
  let currentUser = null;
  let localStats = JSON.parse(localStorage.getItem("ghub_stats") || "{}");
  if(!localStats.quizHistory) localStats.quizHistory = [];
  if(!localStats.strum) localStats.strum = {hits:0,total:0,accuracy:0};
  localStorage.setItem("ghub_stats", JSON.stringify(localStats));

  // --------- UTILITIES ----------
  function show(panel){
    // hide all main panels and show the requested one
    [loginScreen, mainMenu, chordsPanel, practicePanel, strumPanel, quizPanel, metronomePanel, dashboardPanel, adminPanel, leaderboardPanel].forEach(p=>{
      if(p) { p.classList.add("hidden"); p.classList.remove("visible"); }
    });
    if(panel) { panel.classList.remove("hidden"); panel.classList.add("visible"); }
    // auto close account
    accountPanel.style.display='none';
  }

  function normalizeChordFileName(chord){
    // convert chord names to image filenames
    // examples: F# -> fsharp.png, F#m -> fsharpm.png, Am -> am.png
    let s = chord.trim();
    s = s.replace(/\+/g,"plus");
    s = s.replace(/#/g,"sharp");
    s = s.replace(/\s+/g,"");
    s = s.toLowerCase();
    return `${s}.png`;
  }

  function escapeHtmlJS(str){
    if(!str) return "";
    return str.replace(/'/g,"\\'").replace(/"/g,'\\"');
  }

  // --------- INITIAL UI HOOKS ----------
  document.getElementById("dark-toggle").addEventListener("click", ()=> {
    document.body.classList.toggle("light-mode");
    // keep texts white for items that must remain white
    document.querySelectorAll(".force-white").forEach(el=> el.style.color = "var(--white)");
  });

  burgerBtn.addEventListener("click", ()=>{
    accountPanel.style.display = accountPanel.style.display === "block" ? "none" : "block";
  });

  document.getElementById("toggle-pass").addEventListener("click", ()=>{
    passwordInput.type = passwordInput.type === "password" ? "text" : "password";
  });

  // --------- AUTH HANDLERS ----------
  document.getElementById("signup-btn").addEventListener("click", async ()=>{
    const email = emailInput.value.trim();
    const pw = passwordInput.value;
    if(!email || !pw){ authMsg.style.color="#f88"; authMsg.textContent = "Provide email & password to sign up."; return; }
    try{
      await createUserWithEmailAndPassword(auth, email, pw);
      authMsg.style.color = "#8f8"; authMsg.textContent = "Account created, signed in.";
    }catch(e){ authMsg.style.color="#f88"; authMsg.textContent = e.message; }
  });

  document.getElementById("login-btn").addEventListener("click", async ()=>{
    const email = emailInput.value.trim();
    const pw = passwordInput.value;
    if(!email || !pw){ authMsg.textContent = "Enter email & password to sign in."; authMsg.style.color="#f88"; return; }
    try{
      await signInWithEmailAndPassword(auth, email, pw);
      authMsg.style.color="#8f8"; authMsg.textContent = "Signed in.";
    }catch(e){ authMsg.style.color="#f88"; authMsg.textContent = e.message; }
  });

  document.getElementById("continue-btn").addEventListener("click", ()=>{
    loginScreen.classList.add("hidden");
    mainMenu.classList.remove("hidden");
    accountEmail.textContent = "Guest";
    currentUser = null;
    updateAccountUI();
  });

  document.getElementById("forgot-link").addEventListener("click", async (ev)=>{
    ev.preventDefault();
    const email = emailInput.value.trim();
    if(!email){ authMsg.style.color="#f88"; authMsg.textContent = "Enter your email then click Reset."; return; }
    try{
      await sendPasswordResetEmail(auth, email);
      authMsg.style.color="#8f8"; authMsg.textContent = "Reset email sent (check inbox).";
    }catch(e){ authMsg.style.color="#f88"; authMsg.textContent = e.message; }
  });

  document.getElementById("signout-btn").addEventListener("click", async ()=>{
    try{ await signOut(auth); currentUser=null; show(mainMenu); accountPanel.style.display='none'; accountEmail.textContent='Not signed in'; authMsg.textContent=''; updateAccountUI(); }
    catch(e){ console.error(e); }
  });

  document.getElementById("change-pass").addEventListener("click", async ()=>{
    const newPass = prompt("Enter new password (min 6 chars):");
    if(!newPass) return;
    if(!auth.currentUser){ alert("Sign in required to change password."); return; }
    try{
      await updatePassword(auth.currentUser, newPass);
      alert("Password updated.");
    }catch(e){ alert(e.message); }
  });

  document.getElementById("delete-account").addEventListener("click", async ()=>{
    if(!auth.currentUser){ alert("Not signed in."); return; }
    if(!confirm("Delete your account permanently?")) return;
    try{
      await deleteUser(auth.currentUser);
      alert("Account deleted.");
      show(loginScreen);
    }catch(e){
      alert("Delete failed: "+e.message);
    }
  });

  onAuthStateChanged(auth, (user)=>{
    if(user){
      currentUser = user;
      accountEmail.textContent = user.email || "User";
      // try to read displayName
      if(user.displayName) accountEmail.textContent = user.displayName;
      loginScreen.classList.add("hidden");
      mainMenu.classList.remove("hidden");
      authMsg.textContent = "";
      assignInitialLeaderboardEntry(user);
    } else {
      // not signed in
      currentUser = null;
    }
    updateAccountUI();
  });

  function updateAccountUI(){
    if(currentUser){
      accountEmail.textContent = currentUser.email || currentUser.displayName || "User";
      // show admin panel if currentUser email matches admin or admin badge
      if((currentUser.email && currentUser.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) || userHasBadge(currentUser, "Admin")){
        accountBadge.className = "admin-badge";
        accountBadge.textContent = "ADMIN";
        document.getElementById("admin-panel").classList.remove("hidden");
      } else {
        accountBadge.className = "";
        accountBadge.textContent = "";
        document.getElementById("admin-panel").classList.add("hidden");
      }
    } else {
      // guest
      accountEmail.textContent = "Guest";
      accountBadge.className = "";
      accountBadge.textContent = "";
      document.getElementById("admin-panel").classList.add("hidden");
    }
  }

  // very simple badge check in Firestore placeholder (could be expanded)
  async function userHasBadge(user, badgeName){
    // placeholder: if user's email equals ADMIN_EMAIL we return true
    if(!user) return false;
    if(user.email && user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) return true;
    // otherwise check leaderboard doc if exists and has 'badge'
    try{
      const q = query(collection(db,"leaderboard")); // small read ‚Äî could be optimized
      const snap = await getDocs(q);
      let found=false;
      snap.forEach(d=>{
        const data = d.data();
        if(data.displayName === user.email && data.badge === badgeName) found=true;
      });
      return found;
    }catch(e){ return false; }
  }

  async function assignInitialLeaderboardEntry(user){
    // ensure every signed-in user has a leaderboard doc (but only certain goals push into top view)
    if(!user) return;
    try{
      const snap = await getDocs(collection(db,"leaderboard"));
      let exists=false;
      snap.forEach(d=>{
        if(d.data().displayName === user.email) exists=true;
      });
      if(!exists){
        await addDoc(collection(db,"leaderboard"),{
          displayName: user.email,
          highScore: 0,
          lastPlayed: Date.now(),
          level: "Beginner",
          streak: 0,
          badge: "Beginner"
        });
      }
    }catch(e){ console.warn("Leaderboard assign failed", e); }
  }

  // ---------- MAIN MENU BUTTONS ----------
  document.getElementById("btn-chords").addEventListener("click", ()=>{
    show(chordsPanel);
    populateChordGrid();
  });
  document.getElementById("btn-practice").addEventListener("click", ()=>{
    show(practicePanel);
  });
  document.getElementById("btn-strum").addEventListener("click", ()=>{
    show(strumPanel);
    renderSongs();
  });
  document.getElementById("btn-quiz").addEventListener("click", ()=>{
    show(quizPanel);
  });
  document.getElementById("btn-metronome").addEventListener("click", ()=>{
    show(metronomePanel);
  });
  document.getElementById("btn-leaderboard").addEventListener("click", ()=>{
    show(leaderboardPanel);
    renderLeaderboard();
  });

  // Back buttons
  document.getElementById("back-from-chords").addEventListener("click", ()=> show(mainMenu));
  document.getElementById("back-from-practice").addEventListener("click", ()=> show(mainMenu));
  document.getElementById("back-from-strum").addEventListener("click", ()=> show(mainMenu));
  document.getElementById("back-from-quiz").addEventListener("click", ()=> show(mainMenu));
  document.getElementById("back-from-metronome").addEventListener("click", ()=> show(mainMenu));
  document.getElementById("back-from-dashboard").addEventListener("click", ()=> show(mainMenu));
  document.getElementById("back-from-admin").addEventListener("click", ()=> show(mainMenu));
  document.getElementById("back-from-leaderboard").addEventListener("click", ()=> show(mainMenu));

  // dashboard open from account panel
  document.getElementById("show-dashboard").addEventListener("click", ()=>{
    show(dashboardPanel);
    accountPanel.style.display='none';
    refreshDashboardUI();
  });

  // --------- SONGS DATA (local default, editable via admin) ----------
  // initial set of songs (user asked to keep many songs ‚Äî this is a starter; admin can bulk add)
  let songs = [
    {name:"Wonderwall - Oasis", author:"Oasis", chords:"Em7 G Dsus4 A7sus4 C", capo:"", pattern:"‚Üì ‚Üì ‚Üë ‚Üë ‚Üì ‚Üë"},
    {name:"Knockin' on Heaven's Door - Bob Dylan", author:"Bob Dylan", chords:"G D Am C", capo:"", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë"},
    {name:"Zombie - The Cranberries", author:"The Cranberries", chords:"Em C G D", capo:"", pattern:"‚Üì ‚Üë ‚Üì ‚Üë"},
    {name:"Let It Be - The Beatles", author:"The Beatles", chords:"C G Am F", capo:"", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üì ‚Üë"},
    {name:"Perfect - Ed Sheeran", author:"Ed Sheeran", chords:"G Em C D", capo:"", pattern:"‚Üì ‚Üì ‚Üë ‚Üë ‚Üì ‚Üë"},
    // you can bulk add more via admin panel
  ];

  // render songs in strum panel
  const songListEl = document.getElementById("song-list");
  function renderSongs(filter=""){
    songListEl.innerHTML = "";
    const q = filter.trim().toLowerCase();
    songs.forEach((s, idx)=>{
      if(q && !s.name.toLowerCase().includes(q)) return;
      const div = document.createElement("div");
      div.className = "song";
      div.innerHTML = `<div class="title">${s.name}</div>
        <div class="meta">Author: ${s.author} ‚Ä¢ Chords: ${s.chords}${s.capo ? " ‚Ä¢ Capo: "+s.capo : ""}<br>Strumming: ${s.pattern}</div>
        <div style="margin-top:8px"><button class="ghost select-song" data-idx="${idx}">Select</button></div>`;
      songListEl.appendChild(div);
    });
    // attach select handlers
    document.querySelectorAll(".select-song").forEach(btn=>{
      btn.addEventListener("click", (e)=>{
        const idx = parseInt(e.currentTarget.dataset.idx);
        if(songs[idx]){
          selectSong(idx);
        }
      });
    });
  }

  document.getElementById("song-search").addEventListener("input", (e)=>{
    renderSongs(e.target.value);
  });

  function selectSong(idx){
    const song = songs[idx];
    if(!song) return;
    document.getElementById("song-pattern").textContent = `Pattern: ${song.pattern}`;
    strumCurrentPattern = song.pattern.split(/\s+/);
    currentStrumIndex = 0;
    highlightStrum();
    document.getElementById("strum-feedback").textContent = "";
  }

  // --------- Chords Grid population ----------
  const chordList = ["C","D","E","F","G","A","B","Am","Dm","Em","F#m","Bm","Cmaj7","C#m","G#m","F#","Fsharpm","G#","Gsharpm"];
  const chordGrid = document.getElementById("chord-grid");
  function populateChordGrid(){
    chordGrid.innerHTML = "";
    chordList.forEach(chord=>{
      const card = document.createElement("div");
      card.className = "chord-card";
      const fname = normalizeChordFileName(chord.replace(/\s+/g,""));
      // try multiple naming patterns
      const imgHtml = `<img src="${IMAGE_FOLDER}/${fname}" alt="${chord} chord" onerror="this.onerror=null;this.src='${IMAGE_FOLDER}/placeholder.png'">`;
      card.innerHTML = `<div style="font-weight:700;color:var(--white)">${chord}</div>${imgHtml}`;
      chordGrid.appendChild(card);
    });
  }

  // --------- Practice chords ----------
  const practiceChords = ["C","D","E","F","G","A","B","Am","Dm","Em","F#m","Bm"];
  let currentPracticeChord = null;
  document.getElementById("next-chord").addEventListener("click", ()=>{
    currentPracticeChord = practiceChords[Math.floor(Math.random()*practiceChords.length)];
    document.getElementById("practice-chord-display").textContent = currentPracticeChord;
    document.getElementById("practice-feedback").textContent = "";
  });

  // play-chord : Roughly synth a tone representing chord root (placeholder)
  document.getElementById("play-chord").addEventListener("click", ()=>{
    if(!currentPracticeChord) { document.getElementById("practice-feedback").textContent = "Press Next to pick a chord."; return; }
    playChordTone(currentPracticeChord);
  });

  function playTone(freq, duration=600){
    try{
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = "sine";
      o.frequency.value = freq;
      o.connect(g);
      g.connect(ctx.destination);
      g.gain.value = 0;
      g.gain.linearRampToValueAtTime(0.2, ctx.currentTime + 0.02);
      o.start();
      g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration/1000);
      setTimeout(()=>{ o.stop(); ctx.close(); }, duration+50);
    }catch(e){ console.warn("playTone failed", e); }
  }

  function chordToFreq(chord){
    // very rough mapping of root note to frequency (A4=440)
    const roots = {"c":261.63,"c#":277.18,"db":277.18,"d":293.66,"d#":311.13,"eb":311.13,"e":329.63,"f":349.23,"f#":369.99,"gb":369.99,"g":392.00,"g#":415.30,"ab":415.30,"a":440.00,"a#":466.16,"bb":466.16,"b":493.88};
    let r = chord.toLowerCase();
    r = r.replace("m","").replace("maj7","").replace("sus4","");
    r = r.replace(/\s+/g,"");
    // normalize sharps written differently
    r = r.replace("#","sharp"); // but we don't have mapping for 'sharp' here => adjust
    // convert fsharp to f#
    r = r.replace("sharp","#").replace("sharpm","#m"); // hack
    // now remove trailing m if any
    r = r.replace(/m$/,"");
    r = r.replace("m","");
    // final
    r = r.replace("fsharpm","f#").replace("gsharpm","g#").replace("csharpm","c#");
    r = r.replace("fsharp","f#").replace("gsharp","g#").replace("csharp","c#");
    if(roots[r]) return roots[r];
    return 261.63;
  }

  function playChordTone(chord){
    const freq = chordToFreq(chord);
    playTone(freq, 700);
  }

  // --------- QUIZ ----------
  const quizChords = ["C","D","E","F","G","A","B","Am","Dm","Em","F#m","Bm","Cmaj7","C#m","G#m"];
  let quizScore = 0, quizCount = 0, quizTotal = 10, quizTimer, currentQuizChord;
  const quizArea = document.getElementById("quiz-area");
  const quizResult = document.getElementById("quiz-result");
  const quizImage = document.getElementById("quiz-image");
  const quizOptions = document.getElementById("quiz-options");
  const timerEl = document.getElementById("timer");
  document.getElementById("start-quiz").addEventListener("click", ()=>{
    quizScore = 0; quizCount = 0; quizResult.classList.add("hidden"); quizArea.classList.remove("hidden");
    nextQuizChord();
  });

  document.getElementById("reset-quiz").addEventListener("click", ()=>{
    quizScore = 0; quizCount = 0; quizArea.classList.add("hidden"); quizResult.classList.add("hidden");
  });

  function nextQuizChord(){
    if(quizCount >= quizTotal){
      quizArea.classList.add("hidden");
      quizResult.classList.remove("hidden");
      quizResult.textContent = `Quiz Completed! Score: ${quizScore}/${quizTotal}`;
      // store in local stats & firestore
      localStats.quizHistory.unshift({score: quizScore, total: quizTotal, date: Date.now()});
      if(localStats.quizHistory.length>10) localStats.quizHistory.pop();
      localStorage.setItem("ghub_stats", JSON.stringify(localStats));
      updateUserLeaderboardWithQuiz(quizScore);
      return;
    }
    currentQuizChord = quizChords[Math.floor(Math.random()*quizChords.length)];
    // try to show image if present
    const file = normalizeChordFileName(currentQuizChord);
    quizImage.innerHTML = `<img src="${IMAGE_FOLDER}/${file}" alt="${currentQuizChord}" style="max-width:200px" onerror="this.onerror=null;this.style.display='none'"><div style="font-weight:700;margin-top:8px;color:var(--white)">${currentQuizChord}</div>`;
    quizOptions.innerHTML = "";
    // make options
    let choices = shuffleArray(quizChords).slice(0,3);
    if(!choices.includes(currentQuizChord)) choices[Math.floor(Math.random()*3)]=currentQuizChord;
    choices = shuffleArray(choices);
    choices.forEach(c=>{
      const btn = document.createElement("button");
      btn.textContent = c;
      btn.addEventListener("click", ()=>{
       if(c===currentQuizChord) quizScore++;
        quizCount++;
        clearInterval(quizTimer);
        nextQuizChord();
      });
      quizOptions.appendChild(btn);
    });
    quizCount++;
    startQuizTimer();
  }

  function startQuizTimer(){
    let time = QUIZ_TIMER_SECONDS;
    timerEl.textContent = time;
    clearInterval(quizTimer);
    quizTimer = setInterval(()=>{
      time--;
      timerEl.textContent = time;
      if(time<=0){
        clearInterval(quizTimer);
        // next chord: counted as wrong
        nextQuizChord();
      }
    },1000);
  }

  function shuffleArray(array){
    return array.sort(()=>Math.random()-0.5);
  }

  async function updateUserLeaderboardWithQuiz(score){
    // update leaderboard entry for currentUser
    if(!currentUser) return;
    try{
      const snap = await getDocs(collection(db,"leaderboard"));
      let userDoc=null, userId=null;
      snap.forEach(d=>{
        if(d.data().displayName === currentUser.email) { userDoc = d.data(); userId = d.id; }
      });
      if(userId){
        await updateDoc(doc(db,"leaderboard",userId), { highScore: Math.max(userDoc.highScore || 0, score), lastPlayed: Date.now() });
      }else{
        await addDoc(collection(db,"leaderboard"), { displayName: currentUser.email, highScore: score, lastPlayed: Date.now(), level:"Beginner", streak:0 });
      }
    }catch(e){
      console.warn("Leaderboard update failed", e);
    }
  }

  // -------- STRUM PRACTICE & MIC ----------
  // strum detection: amplitude + autocorrelation pitch detector
  let audioContext, analyser, dataArray, sourceNode, micStream;
  let strumActive=false, strumCurrentPattern = ["‚Üì","‚Üì","‚Üë","‚Üì"], currentStrumIndex=0, hits=0, totalStrums=0;
  const strumFeedbackEl = document.getElementById("strum-feedback");
  const startMicBtn = document.getElementById("start-mic");
  const stopMicBtn = document.getElementById("stop-mic");
  const startStrumPracticeBtn = document.getElementById("start-strum-practice");

  async function startMic(){
    if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
      strumFeedbackEl.textContent = "Mic not supported in this browser.";
      return;
    }
    if(!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
    try{
      micStream = await navigator.mediaDevices.getUserMedia({audio:true});
      sourceNode = audioContext.createMediaStreamSource(micStream);
      analyser = audioContext.createAnalyser();
      analyser.fftSize = 2048;
      sourceNode.connect(analyser);
      dataArray = new Uint8Array(analyser.fftSize);
      strumFeedbackEl.textContent = "Mic active. Ready.";
    }catch(e){
      strumFeedbackEl.textContent = "Mic access denied.";
      console.error(e);
    }
  }

  function stopMic(){
    try{
      if(micStream){
        micStream.getTracks().forEach(t => t.stop());
        micStream = null;
      }
      if(sourceNode) sourceNode.disconnect();
      if(analyser) analyser.disconnect();
      strumActive=false;
      strumFeedbackEl.textContent = "Mic stopped.";
    }catch(e){
      console.warn("stopMic", e);
    }
  }

  // basic autocorrelation function to estimate pitch
  function autoCorrelate(buf, sampleRate) {
    // From https://github.com/cwilso/PitchDetect
    var SIZE = buf.length;
    var MAX_SAMPLES = Math.floor(SIZE/2);
    var best_offset = -1;
    var best_correlation = 0;
    var rms = 0;
    for (var i=0;i<SIZE;i++) {
      var val = buf[i] - 128;
      rms += val*val;
    }
    rms = Math.sqrt(rms/SIZE);
    if (rms<8) // too quiet
      return -1;
    var last_correlation = 1;
    for (var offset = 0; offset < MAX_SAMPLES; offset++) {
      var correlation = 0;
      for (var i = 0; i < MAX_SAMPLES; i++) {
        correlation += Math.abs((buf[i]) - (buf[i+offset]));
      }
      correlation = 1 - (correlation/MAX_SAMPLES);
      if (correlation > 0.9 && correlation > last_correlation) {
        best_correlation = correlation;
        best_offset = offset;
      }
      last_correlation = correlation;
    }
    if (best_correlation > 0.01) {
      var fundamentalFreq = sampleRate/best_offset;
      return fundamentalFreq;
    }
    return -1;
  }

  function detectStrumFromAudio(){
    analyser.getByteTimeDomainData(dataArray);
    // amplitude
    let sum=0;
    for(let i=0;i<dataArray.length;i++){ sum += Math.abs(dataArray[i]-128); }
    const avg = sum/dataArray.length;
    // pitch
    const f = autoCorrelate(dataArray, audioContext.sampleRate);
    // classification heuristics:
    // If avg high => a strum happened; distinguish down/up by relative envelope shape (simple)
    // For now: if avg > threshold -> treat as "‚Üì"
    const THRESH = 10;
    if(avg > THRESH) return {strum:"‚Üì", confidence: avg, pitch:f};
    return null;
  }

  function highlightStrum(){
    const highlight = document.getElementById("strum-highlight");
    highlight.innerHTML = "";
    strumCurrentPattern.forEach((s,i)=>{
      const span = document.createElement("span");
      span.textContent = s + " ";
      if(i === currentStrumIndex) span.style.background = "rgba(255,165,0,0.8)";
      highlight.appendChild(span);
    });
  }

  async function startStrumPractice(){
    if(!analyser){
      await startMic();
    }
    if(!analyser){ strumFeedbackEl.textContent = "Mic unavailable."; return; }
    currentStrumIndex = 0; hits=0; totalStrums=0; strumActive=true; highlightStrum();
    strumFeedbackEl.textContent = "Strum the pattern now!";
    requestAnimationFrame(loopStrumDetect);
  }

  function loopStrumDetect(){
    if(!strumActive) return;
    const detection = detectStrumFromAudio();
    if(detection){
      totalStrums++;
      const expected = strumCurrentPattern[currentStrumIndex] || null;
      if(detection.strum === expected){
        hits++;
        currentStrumIndex++;
        strumFeedbackEl.textContent = "Good!";
        highlightStrum();
      } else {
        strumFeedbackEl.textContent = "Wrong strum!";
      }
      // update dashboard stat
      localStats.strum.hits += (detection.strum === expected ? 1 : 0);
      localStats.strum.total += 1;
      localStats.strum.accuracy = Math.round((localStats.strum.hits / localStats.strum.total)*100);
      localStorage.setItem("ghub_stats", JSON.stringify(localStats));
      document.getElementById("dash-strum").textContent = localStats.strum.accuracy + "%";

      if(currentStrumIndex >= strumCurrentPattern.length){
        strumFeedbackEl.textContent = "Pattern completed!";
        strumActive = false;
      }
    }
    requestAnimationFrame(loopStrumDetect);
  }

  startMicBtn.addEventListener("click", startMic);
  stopMicBtn.addEventListener("click", stopMic);
  startStrumPracticeBtn.addEventListener("click", startStrumPractice);

  // -------- METRONOME ----------
  const bpmEl = document.getElementById("bpm");
  const bpmDisplay = document.getElementById("bpm-display");
  const ball = document.getElementById("metronome-ball");
  let metronomeInterval = null;
  let metronomeAudioCtx = null;
  function startMetronome(){
    stopMetronome();
    const bpm = parseInt(bpmEl.value);
    bpmDisplay.textContent = bpm;
    const interval = 60000 / bpm;
    let dir = 1;
    // audio tick
    if(!metronomeAudioCtx) metronomeAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
    metronomeInterval = setInterval(()=>{
      // bounce animation: briefly move ball up
      ball.style.transition = "transform 0.09s ease";
      ball.style.transform = "translate(-50%, -18px)";
      setTimeout(()=>{ ball.style.transform = "translate(-50%, 0)"; }, 120);
      // tick sound
      const o = metronomeAudioCtx.createOscillator();
      const g = metronomeAudioCtx.createGain();
      o.type = "square";
      o.frequency.value = 880;
      o.connect(g); g.connect(metronomeAudioCtx.destination);
      g.gain.value = 0.001;
      g.gain.linearRampToValueAtTime(0.2, metronomeAudioCtx.currentTime + 0.001);
      g.gain.exponentialRampToValueAtTime(0.001, metronomeAudioCtx.currentTime + 0.06);
      o.start();
      setTimeout(()=>{ o.stop(); }, 80);
    }, interval);
  }
  function stopMetronome(){
    if(metronomeInterval) clearInterval(metronomeInterval);
    metronomeInterval = null;
  }
  document.getElementById("start-metronome").addEventListener("click", startMetronome);
  document.getElementById("stop-metronome").addEventListener("click", stopMetronome);
  bpmEl.addEventListener("input", ()=> bpmDisplay.textContent = bpmEl.value);

  // --------- DASHBOARD UI REFRESH ----------
  function refreshDashboardUI(){
    document.getElementById("dash-strum").textContent = (localStats.strum.accuracy || 0) + "%";
    const hist = localStats.quizHistory.map(h=>`<div>Score: ${h.score}/${h.total} ‚Äî ${new Date(h.date).toLocaleString()}</div>`).join("");
    document.getElementById("dash-quiz").textContent = localStats.quizHistory.length ? `${localStats.quizHistory[0].score}/${localStats.quizHistory[0].total}` : "N/A";
    document.getElementById("dashboard-details").innerHTML = `<h4 class="force-white">Recent quizzes</h4>${hist || "<div>No quiz history</div>"}`;
  }

  // --------- ADMIN PANEL LOGIC ----------
  const adminSongListEl = document.getElementById("admin-song-list");
  let editingSongIndex = null;

  function renderAdminSongList(){
    adminSongListEl.innerHTML = "";
    songs.forEach((s, idx)=>{
      const div = document.createElement("div");
      div.style.borderBottom="1px solid #2a2a2a";
      div.style.padding="8px 0";
      div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:700;color:var(--white)">${s.name}</div>
          <div style="color:#ccc;font-size:0.9rem">${s.author} ‚Ä¢ ${s.chords} ${s.capo ? "‚Ä¢ capo "+s.capo : ""}</div>
        </div>
        <div>
          <button class="ghost admin-edit" data-idx="${idx}">Edit</button>
          <button class="ghost admin-delete" data-idx="${idx}">Delete</button>
        </div>
      </div>`;
      adminSongListEl.appendChild(div);
    });
    document.querySelectorAll(".admin-edit").forEach(btn=>{
      btn.addEventListener("click", (e)=>{
        editingSongIndex = parseInt(e.currentTarget.dataset.idx);
        const s = songs[editingSongIndex];
        document.getElementById("admin-song-name").value = s.name;
        document.getElementById("admin-song-author").value = s.author;
        document.getElementById("admin-song-chords").value = s.chords;
        document.getElementById("admin-song-capo").value = s.capo;
        document.getElementById("admin-song-pattern").value = s.pattern;
      });
    });
    document.querySelectorAll(".admin-delete").forEach(btn=>{
      btn.addEventListener("click", (e)=>{
        const idx = parseInt(e.currentTarget.dataset.idx);
        if(confirm("Delete song?")) { songs.splice(idx,1); renderAdminSongList(); renderSongs(); }
      });
    });
  }

  document.getElementById("admin-add-song").addEventListener("click", ()=>{
    const name = document.getElementById("admin-song-name").value.trim();
    if(!name){ alert("Name required"); return; }
    songs.push({
      name,
      author: document.getElementById("admin-song-author").value.trim(),
      chords: document.getElementById("admin-song-chords").value.trim(),
      capo: document.getElementById("admin-song-capo").value.trim(),
      pattern: document.getElementById("admin-song-pattern").value.trim() || "‚Üì ‚Üì ‚Üë ‚Üë ‚Üì ‚Üë"
    });
    renderAdminSongList();
    renderSongs();
    alert("Song added");
  });

  document.getElementById("admin-save-song").addEventListener("click", ()=>{
    if(editingSongIndex === null) { alert("No song is being edited"); return; }
    songs[editingSongIndex] = {
      name: document.getElementById("admin-song-name").value.trim(),
      author: document.getElementById("admin-song-author").value.trim(),
      chords: document.getElementById("admin-song-chords").value.trim(),
      capo: document.getElementById("admin-song-capo").value.trim(),
      pattern: document.getElementById("admin-song-pattern").value.trim()
    };
    editingSongIndex = null;
    renderAdminSongList();
    renderSongs();
    alert("Song saved");
  });

  document.getElementById("admin-bulk-toggle").addEventListener("click", ()=>{
    const bulk = document.getElementById("admin-bulk");
    bulk.classList.toggle("hidden");
  });

  document.getElementById("admin-bulk-add").addEventListener("click", ()=>{
    const text = document.getElementById("admin-bulk-text").value.trim();
    if(!text) { alert("Paste something"); return; }
    const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    let added=0;
    lines.forEach(l=>{
      try{
        if(l.startsWith("{")){
          const obj = JSON.parse(l);
          if(obj.name) { songs.push(obj); added++; }
        } else if(l.includes("|")){
          const parts = l.split("|");
          songs.push({ name: parts[0].trim(), author: parts[1]?.trim()||"", chords: parts[2]?.trim()||"", capo: parts[3]?.trim()||"", pattern: parts[4]?.trim()||"" });
          added++;
        }
      }catch(e){ /* ignore parse errors */ }
    });
    renderAdminSongList();
    renderSongs();
    alert(`${added} songs imported`);
  });

  document.getElementById("apply-override").addEventListener("click", async ()=>{
    const email = document.getElementById("override-user").value.trim();
    const streak = parseInt(document.getElementById("override-streak").value)||0;
    const level = document.getElementById("override-level").value || "Beginner";
    const highScore = parseInt(document.getElementById("override-highscore")?.value)||0;

    if(!email){ alert("email required"); return; }
    try{
      // find doc in leaderboard - naive approach
      const snap = await getDocs(collection(db,"leaderboard"));
      let docId=null; let docData=null;
      snap.forEach(d=>{
        if(d.data().displayName === email) { docId = d.id; docData = d.data(); }
      });
      if(docId){
        await updateDoc(doc(db,"leaderboard",docId), { streak, level, highScore, lastPlayed: Date.now() });
        alert("User updated successfully!");
      } else {
        await addDoc(collection(db,"leaderboard"), { displayName: email, streak, level, highScore, lastPlayed: Date.now() });
        alert("New user created and updated!");
      }
    }catch(e){ alert("Failed: "+e.message); console.error(e); }
  });

  // Badge buttons
  document.querySelectorAll(".badge-btn").forEach(b=>{
    b.addEventListener("click", async (e)=>{
      const badge = e.currentTarget.dataset.badge;
      if(!currentUser){ alert("Sign in to modify badges"); return; }
      try{
        // find or create leaderboard doc and set badge
        const snap = await getDocs(collection(db,"leaderboard"));
        let docId=null, data=null;
        snap.forEach(d=>{ if(d.data().displayName === currentUser.email){ docId=d.id; data=d.data(); } });
        if(docId){
          await updateDoc(doc(db,"leaderboard",docId), { badge });
        } else {
          await addDoc(collection(db,"leaderboard"), { displayName: currentUser.email, badge, highScore:0, lastPlayed:Date.now(), level:"Beginner", streak:0 });
        }
        alert("Badge set to "+badge);
        updateAccountUI();
      }catch(er){ alert("Badge update failed: "+er.message); console.error(er); }
    });
  });

  document.getElementById("custom-badge-btn").addEventListener("click", async ()=>{
    const custom = prompt("Enter custom badge name:");
    if(!custom) return;
    if(!currentUser){ alert("Sign in to set badge"); return; }
    // reuse same logic
    try{
      const snap = await getDocs(collection(db,"leaderboard"));
      let docId=null, data=null;
      snap.forEach(d=>{ if(d.data().displayName === currentUser.email){ docId=d.id; data=d.data(); } });
      if(docId){
        await updateDoc(doc(db,"leaderboard",docId), { badge: custom });
      } else {
        await addDoc(collection(db,"leaderboard"), { displayName: currentUser.email, badge: custom, highScore:0, lastPlayed:Date.now(), level:"Beginner", streak:0 });
      }
      alert("Custom badge set");
      updateAccountUI();
    }catch(er){ alert("Failed: "+er.message); }
  });

  // -------- LEADERBOARD RENDER ----------
  async function renderLeaderboard(){
    const el = document.getElementById("leaderboard-list");
    el.innerHTML = "<div>Loading...</div>";
    try{
      const q = query(collection(db,"leaderboard"), orderBy("highScore","desc"), limit(50));
      const snap = await getDocs(q);
      el.innerHTML = "";
      let rank=1;
      snap.forEach(d=>{
        const data = d.data();
        const row = document.createElement("div");
        row.style.padding="8px";
        row.innerHTML = `<div style="display:flex;justify-content:space-between">
          <div><strong>#${rank} ${data.displayName}</strong> <span style="color:#ccc">(${data.level||'N/A'})</span></div>
          <div><strong>${data.highScore||0}</strong></div>
        </div>`;
        el.appendChild(row);
        rank++;
      });
    }catch(e){ el.innerHTML = "<div>Failed to load leaderboard</div>"; console.error(e); }
  }

  // --------- PAGE INIT ----------
  // default view
  show(loginScreen);
  populateChordGrid();
  renderAdminSongList();
  renderSongs();

  // keep certain strings white always (as requested)
  document.querySelectorAll("#main-menu h2, #login-screen h1, #practice h2, #strum h2, #song-pattern, #start-mic, #start-strum-practice, #stop-mic").forEach(n=>{
    if(n) n.classList && n.classList.add("force-white");
  });

  // expose some functions to window for debugging if needed
  window.GuitarHub = {
    show, populateChordGrid, songs, renderSongs, startMic, stopMic, startStrumPractice
  };

  // End of module script
</script>
</body>
</html>

