<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Guitar Hub Trainer</title>
<style>
  :root{
    --bg:#111;
    --panel:#000;
    --accent:orange;
    --muted:#222;
    --text:#fff;
    --card:#1a1a1a;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:Arial, sans-serif;
    background:var(--bg);
    color:var(--text);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    text-align:center;
    transition:background 0.25s,color 0.25s;
  }
  header{
    width:100%;
    background:var(--panel);
    padding:10px 18px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    position:fixed;
    top:0; left:0;
    z-index:1000;
    box-shadow:0 2px 8px rgba(0,0,0,0.6);
  }
  .logo{display:flex;align-items:center;font-weight:700;font-size:1.25rem}
  .logo .guitar{color:#fff}
  .logo .hub{color:black;background:orange;padding:4px 8px;border-radius:6px;margin-left:8px} /* hub background set to orange */
  .controls{display:flex;gap:8px;align-items:center}
  main{padding:92px 14px 40px; max-width:980px;margin:0 auto;}
  button{padding:10px 16px;border-radius:8px;border:none;background:var(--accent);color:#000;font-weight:600;cursor:pointer;transition:all 0.2s}
  button:hover{opacity:0.9}
  .back-btn{background:#444;color:#fff}
  .ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:8px}
  .card{background:var(--muted);padding:14px;border-radius:10px;margin:12px 0;box-shadow:0 6px 16px rgba(0,0,0,0.6);transition:all 0.3s ease}
  /* smoother show/hide: use visible/hidden classes in JS to allow transitions */
  .hidden-panel{opacity:0;pointer-events:none;transform:translateY(8px);transition:opacity .25s, transform .25s}
  .visible-panel{opacity:1;pointer-events:auto;transform:none;transition:opacity .25s, transform .25s}
  .chord-grid{display:flex;flex-wrap:wrap;gap:14px;justify-content:center;padding:8px}
  .chord-card{width:120px;background:#222;padding:10px;border-radius:10px;box-shadow:0 6px 14px rgba(0,0,0,0.6);text-align:center;transition:transform 0.2s;display:flex;flex-direction:column;align-items:center;justify-content:center}
  .chord-card:hover{transform:scale(1.05)}
  .chord-card img{width:100px;height:auto;display:block;margin:8px auto;object-fit:contain}
  .chord-card .label{margin-top:6px;color:#fff;font-weight:700}
  .timer{font-weight:700;color:gold;font-size:1.2rem;margin:8px}
  #quiz-options button{display:block;width:100%;margin:8px 0;background:#333;color:#fff;padding:10px;border-radius:8px}
  input[type="text"],input[type="email"],input[type="password"]{
    width:100%;padding:10px;border-radius:8px;border:none;background:#1b1b1b;color:#fff;margin-bottom:10px;font-size:1rem;
  }
  .row{display:flex;gap:8px;align-items:center}
  .row .small{width:48px;padding:8px}
  .song{padding:10px;border-radius:8px;background:#171717;margin:8px 0;text-align:left}
  .song .title{font-weight:700;color:#fff}
  .song .meta{font-size:0.9rem;color:#ddd;margin-top:6px}
  #burger{font-size:1.4rem;background:none;border:none;color:#fff;cursor:pointer;padding:6px 8px}
  #account-panel{position:fixed;top:58px;right:12px;width:300px;background:#141414;padding:12px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,0.6);display:none;z-index:1100}
  #account-panel h4{margin:0 0 8px 0;color:#fff}
  #strum-highlight{font-size:1.5rem;margin:12px 0;letter-spacing:6px}
  .strum-char{display:inline-block;padding:6px 8px;border-radius:6px;margin:0 4px;background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.06)}
  .strum-current{background:rgba(255,255,255,0.12)}
  .strum-correct{background:rgba(0,180,0,0.18);color:#bff;border-color:rgba(0,180,0,0.3)}
  .strum-wrong{background:rgba(255,0,0,0.12);color:#ffdddd;border-color:rgba(255,0,0,0.28)}
  @media (max-width:600px){
    .logo{font-size:1.05rem}
    main{padding:96px 12px}
    .chord-card{width:96px}
  }
  /* Force requested text to remain white even in light-mode */
  header, #main-menu h2, #login-screen h1, #login-screen a, #login-screen button, #signup-btn, #continue-btn, #practice h2, #strum h2, #song-list .title, #song-pattern, #start-mic, #start-quiz {
    color:#fff !important;
  }
  /* light-mode tweaks */
  .light-mode{background:#fff;color:#000}
  .light-mode .logo .hub{background:orange;color:black}
  /* but keep targeted labels white in light-mode via the rule above */
</style>
</head>
<body>

<header>
  <div class="logo">
    <span class="guitar">Guitar</span><span class="hub">Hub</span>
  </div>
  <div class="controls">
    <button id="dark-toggle" title="Toggle theme">üåó</button>
    <button id="burger" aria-label="Open account menu">‚ò∞</button>
  </div>
</header>

<div id="account-panel" aria-hidden="true">
  <h4>Account</h4>
  <p id="account-email">Not signed in</p>
  <div style="display:flex;gap:8px;margin-top:8px;">
    <button id="show-dashboard" class="ghost">Dashboard</button>
    <button id="signout-btn" class="ghost">Sign out</button>
  </div>
  <hr style="margin:10px 0;border-color:#222">
  <button id="change-pass" class="ghost" style="width:100%;margin-bottom:8px">Change password</button>
  <button id="delete-account" class="ghost" style="width:100%;color:#ff6666">Delete account</button>
</div>

<main>
  <div id="login-screen" class="card visible-panel">
    <h1 style="margin:0 0 8px 0">Login</h1>
    <input id="email" type="email" placeholder="Email" autocomplete="username">
    <div class="row" style="align-items:center">
      <input id="password" type="password" placeholder="Password" autocomplete="current-password" style="flex:1">
      <button id="toggle-pass" class="ghost small" title="Show/Hide">üëÅÔ∏è</button>
    </div>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:8px">
      <button id="login-btn">Login</button>
      <button id="signup-btn" class="ghost">Sign up</button>
    </div>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:10px">
      <button id="continue-btn" class="ghost">Continue without account</button>
    </div>
    <p style="margin:12px 0 0 0"><a href="#" id="forgot-link" style="color:#ddd">Forgot password?</a></p>
    <p id="auth-msg" style="color:#f88;margin-top:8px"></p>
  </div>

  <div id="main-menu" class="card hidden-panel" style="display:none">
    <h2 style="margin-top:0">Main Menu</h2>
    <div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center">
      <button id="btn-chords">View Chords</button>
      <button id="btn-practice">Practice Chords</button>
      <button id="btn-strum">Practice Strum</button>
      <button id="btn-quiz">Chord Recognition Quiz</button>
      <button id="btn-learn-songs" class="ghost">Learn Songs</button>
      <button id="btn-tune" class="ghost">Tune with GuitarTuna</button>
    </div>
  </div>

  <div id="chords" class="card hidden-panel" style="display:none">
    <h2 style="margin-top:0">Basic Chords</h2>
    <div class="chord-grid" id="chord-grid"></div>
    <button class="back-btn" onclick="goBack()">‚¨Ö Back</button>
  </div>

  <div id="practice" class="card hidden-panel" style="display:none">
    <h2 style="margin-top:0">Practice Chords (Random)</h2>
    <div id="practice-chord-display" style="font-size:2rem;margin:16px;color:#fff"></div>
    <div style="display:flex;gap:8px;justify-content:center">
      <button id="next-chord">Next Chord</button>
      <button id="play-chord" class="ghost">Play (placeholder)</button>
    </div>
    <p id="practice-feedback" style="margin-top:10px;color:#fff"></p>
    <button class="back-btn" onclick="goBack()">‚¨Ö Back</button>
  </div>

  <div id="strum" class="card hidden-panel" style="display:none">
    <h2 style="margin-top:0">Practice Strum</h2>
    <input id="song-search" type="text" placeholder="Search songs..." style="margin-bottom:12px" />
    <div id="song-list" style="max-height:360px;overflow:auto;padding-right:6px"></div>
    <div style="margin-top:12px">
      <p id="song-pattern" style="font-weight:700">Pattern: ‚Äî</p>
      <button id="start-mic" class="ghost">Start Mic Test</button>
      <button id="stop-mic" class="ghost" style="display:none">Stop Mic</button>
      <p id="strum-feedback" style="margin-top:8px;color:#fff"></p>
      <div id="strum-highlight" aria-live="polite"></div>
    </div>
    <button class="back-btn" onclick="goBack()">‚¨Ö Back</button>
  </div>

  <div id="quiz" class="card hidden-panel" style="display:none">
    <h2 style="margin-top:0">Chord Recognition Quiz</h2>
    <div style="margin-bottom:12px">
      <button id="start-quiz">Start Quiz</button>
      <button id="reset-quiz" class="ghost" style="display:none">Reset</button>
    </div>
    <div id="quiz-area" class="hidden-panel" style="text-align:center;display:none">
      <div class="timer" id="timer">5</div>
      <div id="quiz-image" style="margin:8px"></div>
      <div id="quiz-options" style="max-width:420px;margin:0 auto;text-align:center"></div>
      <p id="quiz-progress" style="margin-top:8px"></p>
    </div>
    <div id="quiz-result" class="hidden-panel" style="margin-top:12px;font-weight:700;display:none"></div>
    <button class="back-btn" onclick="goBack()">‚¨Ö Back</button>
  </div>

  <div id="dashboard" class="card hidden-panel" style="display:none">
    <h2 style="margin-top:0">Dashboard</h2>
    <p>Strum Accuracy: <span id="dash-strum">0%</span></p>
    <p>Quiz Score History: <span id="dash-quiz">N/A</span></p>
    <button class="back-btn" onclick="goBack()">‚¨Ö Back</button>
  </div>
</main>

<script type="module">
  // Firebase imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail, onAuthStateChanged, updatePassword, deleteUser } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDkMmF78dFu2dmuzka6xuwpLRD5NRCCJtY",
    authDomain: "guitar-hub-25dfa.firebaseapp.com",
    projectId: "guitar-hub-25dfa",
    storageBucket: "guitar-hub-25dfa.appspot.com",
    messagingSenderId: "36479296604",
    appId: "1:36479296604:web:5dbcfb2aec3912f8ba7299",
    measurementId: "G-N4HZW695LF"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  // Panels
  const loginScreen = document.getElementById("login-screen");
  const mainMenu = document.getElementById("main-menu");
  const chordsPanel = document.getElementById("chords");
  const practicePanel = document.getElementById("practice");
  const strumPanel = document.getElementById("strum");
  const quizPanel = document.getElementById("quiz");
  const dashboardPanel = document.getElementById("dashboard");
  const accountPanel = document.getElementById("account-panel");

  // Form elements
  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");
  const authMsg = document.getElementById("auth-msg");
  const burgerBtn = document.getElementById("burger");
  const accountEmail = document.getElementById("account-email");

  // Utility: transition show/hide with display toggles to allow CSS transitions
  function showPanel(panelEl){
    // hide all panels
    [loginScreen, mainMenu, chordsPanel, practicePanel, strumPanel, quizPanel, dashboardPanel].forEach(p=>{
      if(!p) return;
      p.style.display = "none";
      p.classList.remove("visible-panel");
      p.classList.add("hidden-panel");
    });
    // show requested
    panelEl.style.display = ""; // let CSS/layout decide
    // give small timeout so CSS transitions fire
    requestAnimationFrame(()=>{
      panelEl.classList.remove("hidden-panel");
      panelEl.classList.add("visible-panel");
    });
  }

  // Ensure functions referenced from HTML onclick are available on window
  function goBack(){
    showPanel(mainMenu);
  }
  window.goBack = goBack;

  // Dark Mode toggle
  document.getElementById("dark-toggle").addEventListener("click", ()=> {
    document.body.classList.toggle("light-mode");
    // keep certain text white by CSS rule above
  });

  // Account panel toggle
  burgerBtn.addEventListener("click", ()=>{
    accountPanel.style.display = accountPanel.style.display === "block" ? "none" : "block";
  });

  // toggle password visibility
  document.getElementById("toggle-pass").addEventListener("click", ()=>{
    passwordInput.type = passwordInput.type === "password" ? "text" : "password";
  });

  // Auth actions
  document.getElementById("signup-btn").addEventListener("click", async ()=>{
    const email = emailInput.value.trim();
    const pw = passwordInput.value;
    if(!email || !pw){ authMsg.textContent = "Provide email & password to sign up."; authMsg.style.color="#f88"; return; }
    try{
      await createUserWithEmailAndPassword(auth, email, pw);
      authMsg.style.color="#8f8"; authMsg.textContent = "Account created, signed in.";
    }catch(e){ authMsg.style.color="#f88"; authMsg.textContent = e.message; }
  });

  document.getElementById("login-btn").addEventListener("click", async ()=>{
    const email = emailInput.value.trim();
    const pw = passwordInput.value;
    if(!email || !pw){ authMsg.textContent = "Enter email & password to sign in."; authMsg.style.color="#f88"; return; }
    try{
      await signInWithEmailAndPassword(auth, email, pw);
      authMsg.style.color="#8f8"; authMsg.textContent = "Signed in.";
    }catch(e){ authMsg.style.color="#f88"; authMsg.textContent = e.message; }
  });

  // Continue without account
  document.getElementById("continue-btn").addEventListener("click", ()=>{
    showPanel(mainMenu);
    accountEmail.textContent = "Guest";
  });

  // Forgot password
  document.getElementById("forgot-link").addEventListener("click", async (ev)=>{
    ev.preventDefault();
    const email = emailInput.value.trim();
    if(!email){ authMsg.style.color="#f88"; authMsg.textContent = "Enter your email then click Reset."; return; }
    try{
      await sendPasswordResetEmail(auth, email);
      authMsg.style.color="#8f8"; authMsg.textContent = "Reset email sent (check inbox).";
    }catch(e){ authMsg.style.color="#f88"; authMsg.textContent = e.message; }
  });

  // signout
  document.getElementById("signout-btn").addEventListener("click", async ()=>{
    try{ await signOut(auth);
      showPanel(loginScreen);
      accountPanel.style.display='none';
      accountEmail.textContent='Not signed in';
      authMsg.textContent='';
    } catch(e){ console.error(e); }
  });

  // change and delete password
  document.getElementById("change-pass").addEventListener("click", async ()=>{
    const newPass = prompt("Enter new password (min 6 chars):");
    if(!newPass) return;
    if(!auth.currentUser){ alert("Sign in required to change password."); return; }
    try{
      await updatePassword(auth.currentUser, newPass);
      alert("Password updated.");
    }catch(e){ alert(e.message); }
  });
  document.getElementById("delete-account").addEventListener("click", async ()=>{
    if(!auth.currentUser){ alert("Not signed in."); return; }
    if(!confirm("Delete your account permanently?")) return;
    try{
      await deleteUser(auth.currentUser);
      alert("Account deleted.");
      showPanel(loginScreen);
    }catch(e){
      alert("Delete failed: "+e.message);
    }
  });

  onAuthStateChanged(auth, (user)=>{
    if(user){
      accountEmail.textContent = user.email || "User";
      showPanel(mainMenu);
      authMsg.textContent = "";
    }
  });

  // --- Image mapping helper ---
  // Images live in /image/ folder. Filenames: c.png, am.png, fsharp.png, fsharpm.png, etc.
  function chordToFilename(chord){
    // Normalize chord name to filename according to rules:
    // - '#' -> 'sharp'
    // - minors have trailing 'm' (e.g., Am -> am.png, F#m -> fsharpm.png)
    // - other modifiers (maj7 etc) fallback to lowercase without spaces + .png
    if(!chord) return 'placeholder.png';
    let name = chord.replace(/\s+/g,'').toLowerCase();
    name = name.replace(/#/g,'sharp');
    // if chord ends with 'm' and it's a minor like 'am' or 'fsharpm', keep it.
    // Many chords in list are like "C","Am","Cmaj7","F#m" etc.
    // We'll return name + '.png' normally.
    return `${name}.png`;
  }

  // --- Chords grid populate ---
  // Full set (expandable)
  const chords = ["C","D","E","F","G","A","B","Am","Dm","Em","F#m","Bm","Cmaj7","C#m","G#m","F#","Fsharpm","Gm","Cm","Amaj7"];
  const chordGrid = document.getElementById("chord-grid");
  function populateChordGrid(){
    chordGrid.innerHTML = "";
    chords.forEach(chord=>{
      const card = document.createElement("div");
      card.className = "chord-card";
      const fname = chordToFilename(chord);
      // center image and label
      card.innerHTML = `<img src="image/${fname}" alt="${chord} chord" onerror="this.onerror=null;this.src='image/placeholder.png'"><div class="label">${chord}</div>`;
      chordGrid.appendChild(card);
    });
  }

  populateChordGrid();

  // --- Main Menu Buttons (make click handlers robust) ---
  document.getElementById("btn-chords").addEventListener("click", ()=>{
    showPanel(chordsPanel);
  });
  document.getElementById("btn-practice").addEventListener("click", ()=>{
    showPanel(practicePanel);
    // show one chord immediately when entering practice
    showNextPracticeChord();
  });
  document.getElementById("btn-strum").addEventListener("click", ()=>{
    showPanel(strumPanel);
    renderSongs(); // ensure song list rendered
  });
  document.getElementById("btn-quiz").addEventListener("click", ()=>{
    showPanel(quizPanel);
  });
  document.getElementById("btn-learn-songs").addEventListener("click", ()=>{
    alert("Song learning module not implemented yet.");
  });
  document.getElementById("btn-tune").addEventListener("click", ()=>{
    window.open('https://www.guitartuna.com/', '_blank');
  });

  document.getElementById("show-dashboard").addEventListener("click", ()=>{
    showPanel(dashboardPanel);
    accountPanel.style.display = 'none';
    updateDashboardUI();
  });

  // Expose some functions for inline onclicks (if present)
  window.showPanel = showPanel;

  // --- Practice Chords Logic ---
  const practiceChordList = ["C","D","E","F","G","A","B","Am","Dm","Em","F#m","Bm","Cmaj7","C#m","G#m"];
  let currentPracticeChord = null;
  function showNextPracticeChord(){
    currentPracticeChord = practiceChordList[Math.floor(Math.random()*practiceChordList.length)];
    document.getElementById("practice-chord-display").textContent = currentPracticeChord;
    // show a picture if available
    const fname = chordToFilename(currentPracticeChord);
    document.getElementById("practice-feedback").innerHTML = `<img src="image/${fname}" style="width:150px" onerror="this.onerror=null;this.style.display='none'">`;
  }
  document.getElementById("next-chord").addEventListener("click", showNextPracticeChord);

  // Play placeholder (could integrate WebAudio synth later)
  document.getElementById("play-chord").addEventListener("click", ()=>{
    // placeholder feedback
    document.getElementById("practice-feedback").textContent = `Playing ${currentPracticeChord || '‚Äî' } (placeholder)`;
    setTimeout(()=> showNextPracticeChord(), 900);
  });

  // --- Song List & Strum Entries ---
  const songs = [
    {name:"Beautiful in White - Westlife", chords:"G D Em C", pattern:"‚Üì ‚Üì ‚Üë ‚Üë ‚Üì ‚Üë"},
    {name:"Wonderwall - Oasis", chords:"Em7 G Dsus4 A7sus4", pattern:"‚Üì ‚Üì ‚Üë ‚Üë ‚Üì ‚Üë"},
    {name:"Knockin' on Heaven's Door - Bob Dylan", chords:"G D Am G D C", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë"},
    {name:"Zombie - The Cranberries", chords:"Em C G D", pattern:"‚Üì ‚Üë ‚Üì ‚Üë"},
    {name:"Let It Be - The Beatles", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üì ‚Üë ‚Üì ‚Üì ‚Üë"},
    {name:"Perfect - Ed Sheeran", chords:"G Em C D", pattern:"‚Üì ‚Üì ‚Üë ‚Üë ‚Üì ‚Üë"},
    {name:"Shape of You - Ed Sheeran", chords:"Am F C G", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë"},
    {name:"Hallelujah - Jeff Buckley", chords:"C Am C Am", pattern:"‚Üì ‚Üë ‚Üì ‚Üë"}
    {name:"Cup of Joe ‚Äì Multo", chords:"E B (capo 4)", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë ‚Üì"},
    {name:"December Avenue ‚Äì Saksi Ang Langit", chords:"D G D G Em D/F# G", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë ‚Üì"},
    {name:"Soapdish ‚Äì Tensionado", chords:"A C#m Bm Dm7", pattern:"‚Üì ‚Üì ‚Üë ‚Üë ‚Üì ‚Üë"},
    {name:"Maki ‚Äì Dilaw", chords:"A C Em F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë ‚Üì"},
    {name:"sombr ‚Äì Back to Friends", chords:"F Dm Am C", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë ‚Üì"},
    {name:"Le John ‚Äì Naiilang", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë ‚Üì"},
    {name:"HUNTR/X ‚Äì Golden", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë ‚Üì"},
    {name:"Kehlani ‚Äì Folded", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë ‚Üì"},
    {name:"Justin Bieber ‚Äì DAISIES", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë ‚Üì"},
    {name:"Rico Blanco ‚Äì Your Universe", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë ‚Üì"},
    {name:"Earl Agustin ‚Äì Tibok", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë ‚Üì"},
    {name:"Cup of Joe ‚Äì Tingin (w/ Janine)", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë ‚Üì"},
    {name:"KATSEYE ‚Äì Gabriela", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë ‚Üì"},
    {name:"Arthur Nery ‚Äì Isa Lang", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë ‚Üì"},
    {name:"December Avenue ‚Äì Bulong", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë ‚Üì"},
    {name:"NIKI ‚Äì You‚Äôll Be in My Heart (Spotify Singles)", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë ‚Üì"},
    {name:"Up Dharma Down ‚Äì Tadhana", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë ‚Üì"},
    {name:"The Script ‚Äì The Man Who Can‚Äôt Be Moved", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë ‚Üì"},
    {name:"Earl Agustin ‚Äì Dalangin", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë ‚Üì"},
    {name:"The Goo Goo Dolls ‚Äì Iris", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë ‚Üì"},
    {name:"Sabrina Carpenter ‚Äì Manchild", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë ‚Üì"},
    {name:"Sugarfree ‚Äì Burnout", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë ‚Üì"},
    {name:"Amiel Sol ‚Äì Sa Bawat Sandali", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë ‚Üì"},
    {name:"HELLMERRY ‚Äì My Day", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë ‚Üì"},
    {name:"Khel Pangilinan ‚Äì Alipin", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë ‚Üì"},
    {name:"Saja Boys ‚Äì Soda Pop", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë ‚Üì"},
    {name:"Unique Salonga ‚Äì Sino", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë ‚Üì"},
    {name:"Parokya Ni Edgar ‚Äì Pangarap Lang Kita", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë ‚Üì"},
    {name:"Skusta Clee ‚Äì Kalimutan Ka", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë ‚Üì"},
    {name:"Dionela ‚Äì Marilag", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë ‚Üì"},
    {name:"Nateman ‚Äì IMMA FLIRT", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë ‚Üì"},
    {name:"Ogie Alcasid ‚Äì Nandito Ako", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë ‚Üì"},
    {name:"Calein ‚Äì Umaasa", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë ‚Üì"},
    {name:"Over October ‚Äì Ikot", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë ‚Üì"},
    {name:"Cup of Joe ‚Äì Misteryoso", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë ‚Üì"},
    {name:"Hale ‚Äì Kung Wala Ka", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë ‚Üì"},
    {name:"Dionela ‚Äì Sining (w/ Jay R)", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë ‚Üì"},
    {name:"NOBITA ‚Äì Ikaw Lang", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë ‚Üì"},
    {name:"Rico Blanco ‚Äì Antukin", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë ‚Üì"},
    {name:"Sabrina Carpenter ‚Äì Tears", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë ‚Üì"},
    {name:"December Avenue ‚Äì Sa Ngalan Ng Pag-Ibig", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë ‚Üì"},
    {name:"IV Of Spades ‚Äì Mundo", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë ‚Üì"},
    {name:"Up Dharma Down ‚Äì Unti-Unti", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë ‚Üì"},
    {name:"Shanti Dope ‚Äì City Girl", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë ‚Üì"},
    {name:"Ben&Ben ‚Äì Kathang Isip", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë ‚Üì"},
    {name:"Jin ‚Äì Don‚Äôt Say You Love Me", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë ‚Üì"},
    {name:"Cup of Joe ‚Äì Estranghero", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë ‚Üì"},
    {name:"Arthur Nery ‚Äì TAKE ALL THE LOVE", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üë ‚Üì"}
    // add more if you want...
  ];
  const songList = document.getElementById("song-list");
  const songSearch = document.getElementById("song-search");

  function escapeHtmlJS(s){ return s.replace(/'/g,"\\'").replace(/"/g,'\\"'); }

  function renderSongs(filter=""){
    songList.innerHTML = "";
    const q = (filter||"").trim().toLowerCase();
    songs.forEach(s=>{
      if(q && !s.name.toLowerCase().includes(q)) return;
      const div = document.createElement("div");
      div.className = "song";
      div.innerHTML = `<div class="title">${s.name}</div>
        <div class="meta">Chords: ${s.chords}<br>Strum: ${s.pattern}
          <div style="margin-top:8px">
            <button class="ghost" data-name="${escapeHtmlJS(s.name)}">Select</button>
          </div>
        </div>`;
      // attach select handler
      const btn = div.querySelector("button");
      btn.addEventListener("click", ()=>{
        selectSong(s.name);
      });
      songList.appendChild(div);
    });
  }
  songSearch && songSearch.addEventListener("input", ()=> renderSongs(songSearch.value));
  renderSongs();

  function selectSong(name){
    const song = songs.find(s=>s.name===name);
    if(!song) return;
    document.getElementById("song-pattern").textContent = `Pattern: ${song.pattern}`;
    // prepare highlight UI
    currentPattern = song.pattern.split(/\s+/).filter(Boolean);
    currentStrumIndex = 0;
    updateStrumHighlight();
    document.getElementById("strum-feedback").textContent = "";
  }

  // --- Strum detection using audio analysis (naive) ---
  let audioContext, analyser, dataArray, freqArray, sourceStream;
  // The strum detection approach used here is heuristic:
  // - we analyze time-domain amplitude (RMS) for "attack"
  // - we analyze frequency centroid to heuristically distinguish down vs up (this is not perfect)
  let currentPattern = ["‚Üì","‚Üì","‚Üë","‚Üì"]; // default
  let currentStrumIndex = 0;
  let hits = 0;
  let totalStrums = 0;
  let strumActive = false;
  let lastDetectTime = 0;
  const strumFeedback = document.getElementById("strum-feedback");
  const startMicBtn = document.getElementById("start-mic");
  const stopMicBtn = document.getElementById("stop-mic");
  const dashStrumEl = document.getElementById("dash-strum");

  function updateStrumHighlight(){
    const highlight = document.getElementById("strum-highlight");
    highlight.innerHTML = "";
    currentPattern.forEach((s,i)=>{
      const span = document.createElement("span");
      span.className = "strum-char";
      span.textContent = s;
      if(i === currentStrumIndex) span.classList.add("strum-current");
      highlight.appendChild(span);
    });
  }

  async function startMic(){
    try{
      if(!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const stream = await navigator.mediaDevices.getUserMedia({audio:true});
      sourceStream = stream;
      source = audioContext.createMediaStreamSource(stream);
      analyser = audioContext.createAnalyser();
      analyser.fftSize = 2048;
      source.connect(analyser);
      const bufferLength = analyser.fftSize;
      dataArray = new Uint8Array(bufferLength);
      freqArray = new Uint8Array(analyser.frequencyBinCount);
      currentStrumIndex = 0;
      hits = 0;
      totalStrums = 0;
      strumActive = true;
      lastDetectTime = 0;
      updateStrumHighlight();
      startMicBtn.style.display = "none";
      stopMicBtn.style.display = "inline-block";
      strumFeedback.textContent = "Mic active ‚Äî strum the pattern!";
      requestAnimationFrame(checkStrum);
    }catch(e){
      strumFeedback.textContent = "Mic access denied or not available.";
    }
  }
  function stopMic(){
    if(sourceStream){
      sourceStream.getTracks().forEach(t=>t.stop());
      sourceStream = null;
    }
    strumActive = false;
    startMicBtn.style.display = "inline-block";
    stopMicBtn.style.display = "none";
    strumFeedback.textContent = "Mic stopped.";
  }

  stopMicBtn.addEventListener("click", stopMic);

  function computeRMS(bytes){
    // bytes: Uint8Array from getByteTimeDomainData
    let sum = 0;
    for(let i=0;i<bytes.length;i++){
      const v = (bytes[i] - 128) / 128;
      sum += v*v;
    }
    return Math.sqrt(sum / bytes.length);
  }

  function estimateCentroid(freqBytes){
    // naive centroid using magnitude * bin index
    let sum = 0, weight = 0;
    for(let i=0;i<freqBytes.length;i++){
      const mag = freqBytes[i];
      sum += mag * i;
      weight += mag;
    }
    return weight ? (sum / weight) : 0;
  }

  function checkStrum(){
    if(!strumActive) return;
    const now = performance.now();
    analyser.getByteTimeDomainData(dataArray);
    analyser.getByteFrequencyData(freqArray);
    const rms = computeRMS(dataArray);
    const centroid = estimateCentroid(freqArray);
    // detection heuristics
    // - require a minimum spacing between detections (avoid repeats)
    // - rms threshold for attack
    // - centroid threshold to guess up vs down (heuristic)
    if(rms > 0.04 && (now - lastDetectTime) > 200){ // threshold + 200ms debounce
      lastDetectTime = now;
      // decide direction: centroid higher => more high-frequency content => likely "up" (heuristic)
      const detected = centroid > 40 ? "‚Üë" : "‚Üì";
      totalStrums++;
      // check against expected
      const expected = currentPattern[currentStrumIndex] || currentPattern[currentStrumIndex % currentPattern.length];
      const highlightEls = document.querySelectorAll("#strum-highlight .strum-char");
      // mark the character accordingly
      if(detected === expected){
        hits++;
        // mark as correct briefly then advance
        if(highlightEls[currentStrumIndex]) {
          highlightEls[currentStrumIndex].classList.add("strum-correct");
          highlightEls[currentStrumIndex].classList.remove("strum-current");
        }
        currentStrumIndex++;
        strumFeedback.textContent = "Good!";
      } else {
        // wrong
        if(highlightEls[currentStrumIndex]) {
          highlightEls[currentStrumIndex].classList.add("strum-wrong");
        }
        strumFeedback.textContent = `Wrong strum (${detected}), expected ${expected}`;
      }
      // update dashboard stat immediately
      const accuracy = totalStrums > 0 ? Math.round((hits/totalStrums)*100) : 0;
      dashStrumEl.textContent = accuracy + "%";
      // store in localStorage
      localStorage.setItem('guitarhub_strum_accuracy', accuracy.toString());
      // if pattern complete
      if(currentStrumIndex >= currentPattern.length){
        strumFeedback.textContent = "Pattern completed!";
        // reset highlight to show all correct/wrong persistently
        strumActive = false;
        stopMic();
        return;
      } else {
        // update highlight for next expected
        updateStrumHighlight();
      }
    }
    requestAnimationFrame(checkStrum);
  }

  startMicBtn.addEventListener("click", ()=>{
    // ensure pattern is set from song selection; if not, keep default
    if(!currentPattern || currentPattern.length===0) currentPattern = ["‚Üì","‚Üì","‚Üë","‚Üì"];
    currentStrumIndex = 0;
    updateStrumHighlight();
    startMic();
  });

  // --- Quiz logic with images + history ---
  const quizChords = ["C","D","E","F","G","A","B","Am","Dm","Em","F#m","Bm","Cmaj7","C#m","G#m","F#","Gm","Cm","Amaj7"]; // more included
  let quizScore = 0;
  let quizCount = 0;
  const quizTotal = 10;
  const quizArea = document.getElementById("quiz-area");
  const quizResult = document.getElementById("quiz-result");
  const quizImage = document.getElementById("quiz-image");
  const quizOptions = document.getElementById("quiz-options");
  const timerEl = document.getElementById("timer");
  let quizTimer;
  let currentQuizChord;

  // show quiz panel handler
  document.getElementById("start-quiz").addEventListener("click", ()=>{
    quizScore = 0; quizCount = 0;
    quizResult.style.display = "none";
    quizResult.classList.add("hidden-panel");
    quizArea.style.display = "";
    quizArea.classList.remove("hidden-panel");
    quizArea.classList.add("visible-panel");
    nextQuizChord();
  });

  document.getElementById("reset-quiz").addEventListener("click", ()=>{
    quizScore = 0; quizCount = 0;
    quizArea.style.display = "none";
    quizArea.classList.add("hidden-panel");
    quizResult.style.display = "none";
    quizResult.classList.add("hidden-panel");
  });

  function nextQuizChord(){
    if(quizCount >= quizTotal){
      // finish
      quizArea.style.display = "none";
      quizArea.classList.add("hidden-panel");
      quizResult.style.display = "";
      quizResult.classList.remove("hidden-panel");
      quizResult.classList.add("visible-panel");
      quizResult.textContent = `Quiz Completed! Score: ${quizScore}/${quizTotal}`;
      // save to history
      const hist = JSON.parse(localStorage.getItem('guitarhub_quiz_history')||"[]");
      hist.push({score: quizScore, total: quizTotal, ts: Date.now()});
      localStorage.setItem('guitarhub_quiz_history', JSON.stringify(hist));
      updateDashboardUI();
      return;
    }
    currentQuizChord = quizChords[Math.floor(Math.random()*quizChords.length)];
    // show image for chord
    const fname = chordToFilename(currentQuizChord);
    quizImage.innerHTML = `<img src="image/${fname}" alt="${currentQuizChord}" style="width:150px" onerror="this.onerror=null;this.src='image/placeholder.png'">`;
    quizOptions.innerHTML = "";
    // build 4 options
    const copy = quizChords.slice();
    // shuffle
    for(let i=copy.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [copy[i],copy[j]]=[copy[j],copy[i]];}
    let options = copy.slice(0,4);
    if(!options.includes(currentQuizChord)) options[Math.floor(Math.random()*4)] = currentQuizChord;
    options.forEach(opt=>{
      const btn = document.createElement("button");
      btn.textContent = opt;
      btn.addEventListener("click", ()=>{
        if(opt === currentQuizChord) quizScore++;
        quizCount++;
        clearInterval(quizTimer);
        nextQuizChord();
      });
      quizOptions.appendChild(btn);
    });
    startQuizTimer();
  }

  function startQuizTimer(){
    let time = 15;
    timerEl.textContent = time;
    clearInterval(quizTimer);
    quizTimer = setInterval(()=>{
      time--;
      timerEl.textContent = time;
      if(time<=0){
        clearInterval(quizTimer);
        quizCount++;
        nextQuizChord();
      }
    },1000);
  }

  // --- Dashboard update ---
  function updateDashboardUI(){
    const acc = localStorage.getItem('guitarhub_strum_accuracy') || "0";
    document.getElementById("dash-strum").textContent = `${acc}%`;
    const hist = JSON.parse(localStorage.getItem('guitarhub_quiz_history') || "[]");
    if(hist.length===0) document.getElementById("dash-quiz").textContent = "N/A";
    else {
      // display last 5 scores
      const last = hist.slice(-5).map(h=>`${h.score}/${h.total}`).join(", ");
      document.getElementById("dash-quiz").textContent = last;
    }
  }

  // expose goBack & showPanel if HTML uses them inline
  window.showPanel = showPanel;
  window.goBack = goBack;

  // --- Init: make login screen visible on first load ---
  // Ensure the initial panel state is correct:
  function initPanels(){
    // hide all then show login screen (or mainMenu if authed)
    [mainMenu, chordsPanel, practicePanel, strumPanel, quizPanel, dashboardPanel].forEach(p=>{ p.style.display="none"; p.classList.add("hidden-panel"); p.classList.remove("visible-panel"); });
    // determine if user logged in (firebase onAuthStateChanged will show mainMenu); otherwise show login
    loginScreen.style.display = "";
    loginScreen.classList.add("visible-panel");
    loginScreen.classList.remove("hidden-panel");
  }
  initPanels();

  // utility to shuffle outside
  function shuffleArray(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} return a; }

  // update dashboard UI on load
  updateDashboardUI();

  // Expose some helpers for debugging via console (optional)
  window._GH = {
    showPanel, populateChordGrid, showNextPracticeChord, renderSongs, selectSong, stopMic, startMic
  };

</script>
</body>
</html>
