<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Guitar Hub Trainer - Ultimate Edition</title>
<style>
  :root{
    --bg:#111;
    --panel:#000;
    --accent:orange;
    --muted:#222;
    --text:#fff;
    --card:#1a1a1a;
    --white:#fff;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:Arial, sans-serif;
    background:var(--bg);
    color:var(--text);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    text-align:center;
    transition:background 0.25s,color 0.25s;
  }
  header{
    width:100%;
    background:var(--panel);
    padding:10px 18px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    position:fixed;
    top:0; left:0;
    z-index:1000;
    box-shadow:0 2px 8px rgba(0,0,0,0.6);
  }
  .logo{display:flex;align-items:center;font-weight:700;font-size:1.25rem;color:var(--white)}
  .logo .guitar{color:var(--white)}
  .logo .hub{color:black;background:orange;padding:4px 8px;border-radius:6px;margin-left:8px}
  .controls{display:flex;gap:8px;align-items:center}
  main{padding:112px 14px 40px; max-width:980px;margin:0 auto;}
  button{padding:10px 16px;border-radius:8px;border:none;background:var(--accent);color:#000;font-weight:600;cursor:pointer;transition:all 0.2s}
  button:hover{opacity:0.9}
  .back-btn{background:#444;color:#fff}
  .ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:8px}
  .card{background:var(--muted);padding:14px;border-radius:10px;margin:12px 0;box-shadow:0 6px 16px rgba(0,0,0,0.6);transition:all 0.3s ease}
  .hidden{display:none;opacity:0;transition:opacity 0.3s ease}
  .visible{display:block;opacity:1;transition:opacity 0.3s ease}
  .chord-grid{display:flex;flex-wrap:wrap;gap:14px;justify-content:center;padding:8px}
  .chord-card{width:120px;background:#222;padding:10px;border-radius:10px;box-shadow:0 6px 14px rgba(0,0,0,0.6);text-align:center;transition:transform 0.2s; display:flex;flex-direction:column;align-items:center;justify-content:center;}
  .chord-card:hover{transform:scale(1.05)}
  .chord-card img{width:100px;height:auto;display:block;margin:0 auto;object-fit:contain}
  .timer{font-weight:700;color:gold;font-size:1.2rem;margin:8px}
  #quiz-options button{display:block;width:100%;margin:8px 0;background:#333;color:#fff;padding:10px;border-radius:8px}
  input[type="text"],input[type="email"],input[type="password"],textarea,select{
    width:100%;padding:10px;border-radius:8px;border:none;background:#1b1b1b;color:#fff;margin-bottom:10px;font-size:1rem;
  }
  .row{display:flex;gap:8px;align-items:center}
  .row .small{width:48px;padding:8px}
  .song{padding:10px;border-radius:8px;background:#171717;margin:8px 0;text-align:left;color:var(--white);display:flex;flex-direction:column}
  .song .title{font-weight:700;color:var(--white)}
  .song .meta{font-size:0.9rem;color:#ddd;margin-top:6px}
  #burger{font-size:1.4rem;background:none;border:none;color:#fff;cursor:pointer;padding:6px 8px}
  #account-panel{position:fixed;top:58px;right:12px;width:320px;background:#141414;padding:12px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,0.6);display:none;z-index:1100;color:var(--white)}
  #account-panel h4{margin:0 0 8px 0}
  #strum-highlight{font-size:1.5rem;margin:12px 0;letter-spacing:6px;color:var(--white)}
  .centered{display:flex;align-items:center;justify-content:center}
  .metronome-ball{width:18px;height:18px;border-radius:50%;background:orange;margin-top:8px;display:inline-block;transform:translateX(0);transition:transform 0.05s linear}
  .not-copy{user-select:none;-webkit-user-select:none;-moz-user-select:none;}
  .admin-badge{background:gold;color:#111;padding:4px 8px;border-radius:8px;font-weight:700}
  .badge-pill{display:inline-block;padding:4px 8px;border-radius:6px;background:#333;color:#fff;margin-right:6px}
  .song-actions{margin-top:8px}
  .song-actions button{margin-right:6px}
  @media (max-width:600px){
    .logo{font-size:1.05rem}
    main{padding:120px 12px}
    .chord-card{width:96px}
  }
  /* Light-mode tweaks: keep most important text white per your requirement */
  .light-mode{background:#fff;color:var(--white)}
  .light-mode .logo .guitar{color:var(--white)}
  .light-mode .logo .hub{background:orange;color:black}
  .light-mode .song, .light-mode .song .title, .light-mode #main-menu h2, .light-mode #login-screen h1,
  .light-mode #practice h2, .light-mode #strum h2, .light-mode #song-pattern, .light-mode #strum-feedback {
    color:var(--white) !important;
  }
  .light-mode input, .light-mode textarea, .light-mode select { background:#1b1b1b; color:var(--white); }
  /* smaller helper */
  .muted-small{font-size:0.85rem;color:#bbb}
  .flex-row{display:flex;gap:8px;align-items:center}
</style>
</head>
<body>

<header class="not-copy">
  <div class="logo not-copy">
    <span class="guitar">Guitar</span><span class="hub">Hub</span>
  </div>
  <div class="controls">
    <button id="dark-toggle" title="Toggle theme">üåó</button>
    <button id="burger" aria-label="Open account menu">‚ò∞</button>
  </div>
</header>

<div id="account-panel" aria-hidden="true" class="not-copy">
  <h4>Account</h4>
  <p id="account-email">Not signed in</p>
  <div style="display:flex;gap:8px;margin-top:8px;">
    <button id="show-dashboard" class="ghost">Dashboard</button>
    <button id="signout-btn" class="ghost">Sign out</button>
  </div>
  <hr style="margin:10px 0;border-color:#222">
  <button id="change-pass" class="ghost" style="width:100%;margin-bottom:8px">Change password</button>
  <button id="delete-account" class="ghost" style="width:100%;color:#ff6666">Delete account</button>
  <div style="margin-top:12px">
    <div id="badge-list"></div>
  </div>
</div>

<main>
  <div id="login-screen" class="card">
    <h1 style="margin:0 0 8px 0;color:var(--white)" class="not-copy">Login</h1>
    <input id="email" type="email" placeholder="Email" autocomplete="username">
    <div class="row" style="align-items:center">
      <input id="password" type="password" placeholder="Password" autocomplete="current-password" style="flex:1">
      <button id="toggle-pass" class="ghost small" title="Show/Hide">üëÅÔ∏è</button>
    </div>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:8px">
      <button id="login-btn">Login</button>
      <button id="signup-btn" class="ghost">Sign up</button>
    </div>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:10px">
      <button id="continue-btn" class="ghost">Continue without account</button>
    </div>
    <p style="margin:12px 0 0 0"><a href="#" id="forgot-link" style="color:#ddd">Forgot password?</a></p>
    <p id="auth-msg" style="color:#f88;margin-top:8px"></p>
  </div>

  <div id="main-menu" class="card hidden not-copy">
    <h2 style="margin-top:0;color:var(--white)">Main Menu</h2>
    <div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center">
      <button id="btn-chords">View Chords</button>
      <button id="btn-practice">Practice Chords</button>
      <button id="btn-strum">Practice Strum</button>
      <button id="btn-quiz">Chord Recognition Quiz</button>
      <button id="btn-learn-songs" class="ghost">Learn Songs</button>
      <button id="btn-tune" class="ghost" onclick="window.open('https://www.guitartuna.com/','_blank')">Tune with GuitarTuna</button>
      <button id="btn-metronome" class="ghost">Metronome</button>
    </div>
  </div>

  <div id="chords" class="card hidden">
    <h2 style="margin-top:0;color:var(--white)">Basic Chords</h2>
    <div class="chord-grid" id="chord-grid"></div>
    <div style="display:flex;justify-content:center">
      <button class="back-btn" onclick="goBack()">‚¨Ö Back</button>
    </div>
  </div>

  <div id="practice" class="card hidden">
    <h2 style="margin-top:0;color:var(--white)">Practice Chords (Random)</h2>
    <div id="practice-chord-display" style="font-size:2rem;margin:16px;color:var(--white)"></div>
    <div style="display:flex;gap:8px;justify-content:center">
      <button id="next-chord">Next Chord</button>
      <button id="play-chord" class="ghost">Play Chord</button>
    </div>
    <p id="practice-feedback" style="margin-top:10px;color:var(--white)"></p>
    <button class="back-btn" onclick="goBack()">‚¨Ö Back</button>
  </div>

  <div id="strum" class="card hidden">
    <h2 style="margin-top:0;color:var(--white)">Practice Strum</h2>
    <input id="song-search" type="text" placeholder="Search songs..." style="margin-bottom:12px;color:var(--white);background:#222"/>
    <div id="song-list" style="max-height:360px;overflow:auto;padding-right:6px"></div>
    <div style="margin-top:12px">
      <p id="song-pattern" style="font-weight:700;color:var(--white)">Pattern: ‚Äî</p>
      <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:6px">
        <button id="start-mic" class="ghost">Start Mic Test</button>
        <button id="start-strum-practice" class="ghost">Start Strum Practice</button>
        <button id="stop-mic" class="ghost">Stop Mic</button>
      </div>
      <p id="strum-feedback" style="margin-top:8px;color:var(--white)"></p>
      <div id="strum-highlight"></div>
    </div>
    <button class="back-btn" onclick="goBack()">‚¨Ö Back</button>
  </div>

  <div id="quiz" class="card hidden">
    <h2 style="margin-top:0;color:var(--white)">Chord Recognition Quiz</h2>
    <div style="margin-bottom:12px">
      <label class="muted-small">Timer (seconds): <input id="quiz-timer" type="number" value="5" style="width:80px;display:inline-block;margin-left:8px"></label>
      <div style="margin-top:8px">
        <button id="start-quiz">Start Quiz</button>
        <button id="reset-quiz" class="ghost" style="display:none">Reset</button>
      </div>
    </div>
    <div id="quiz-area" class="hidden" style="text-align:center">
      <div class="timer" id="timer">5</div>
      <div id="quiz-image" style="margin:8px"></div>
      <div id="quiz-options" style="max-width:420px;margin:0 auto;text-align:center"></div>
      <p id="quiz-progress" style="margin-top:8px"></p>
    </div>
    <div id="quiz-result" class="hidden" style="margin-top:12px;font-weight:700"></div>
    <button class="back-btn" onclick="goBack()">‚¨Ö Back</button>
  </div>

  <div id="metronome" class="card hidden">
    <h2 style="margin-top:0;color:var(--white)">Metronome</h2>
    <div style="display:flex;gap:8px;align-items:center;justify-content:center">
      <label class="muted-small">BPM:</label>
      <input id="metronome-bpm" type="range" min="40" max="220" value="100" style="width:240px">
      <span id="bpm-display">100</span>
    </div>
    <div class="centered" style="margin-top:12px">
      <button id="start-metronome">Start</button>
      <button id="stop-metronome" class="ghost">Stop</button>
    </div>
    <div class="centered" style="margin-top:18px">
      <div id="metronome-visual" style="width:300px;height:40px;background:#111;border-radius:6px;display:flex;align-items:center;padding:0 12px;justify-content:space-between">
        <div style="width:20%"></div>
        <div style="width:20%"></div>
        <div style="width:20%"></div>
        <div style="width:20%"></div>
        <div style="width:20%"></div>
        <div style="flex-basis:100%" class="centered"><div id="metronome-ball" class="metronome-ball"></div></div>
      </div>
    </div>
    <button class="back-btn" onclick="goBack()">‚¨Ö Back</button>
  </div>

  <div id="dashboard" class="card hidden">
    <h2 style="margin-top:0;color:var(--white)">Dashboard</h2>
    <p>Strum Accuracy: <span id="dash-strum">0%</span></p>
    <p>Quiz Score History: <span id="dash-quiz">N/A</span></p>
    <p>Streak: <span id="dash-streak">0</span></p>
    <div style="margin-top:12px">
      <button id="download-data" class="ghost">Download My Stats</button>
    </div>
    <button class="back-btn" onclick="goBack()">‚¨Ö Back</button>
  </div>

  <!-- Admin Panel -->
  <div id="admin-panel" class="card hidden" style="margin-top:20px;">
    <h2 style="color:var(--white)">Admin Controls</h2>
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <button id="admin-add-song">Add Song</button>
      <button id="admin-bulk-add">Bulk Add Songs</button>
      <button id="admin-refresh">Refresh Song List</button>
    </div>
    <div id="admin-song-list" style="max-height:300px;overflow:auto"></div>
    <h3 style="color:var(--white)">Manual User Override</h3>
    <input id="override-user" type="text" placeholder="Enter user email">
    <input id="override-streak" type="number" placeholder="Set streak">
    <input id="override-level" type="text" placeholder="Set level">
    <input id="override-highscore" type="number" placeholder="Set high score">
    <button id="apply-override">Apply Changes</button>
    <div style="margin-top:12px">
      <button class="back-btn" onclick="goBack()">‚¨Ö Back</button>
    </div>
  </div>

</main>

<!-- Firebase + App Logic -->
<script type="module">
  // --- Firebase CDN imports (you provided config earlier) ---
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail, onAuthStateChanged, updatePassword, deleteUser } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, getDocs, doc, setDoc, updateDoc, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDkMmF78dFu2dmuzka6xuwpLRD5NRCCJtY",
    authDomain: "guitar-hub-25dfa.firebaseapp.com",
    projectId: "guitar-hub-25dfa",
    storageBucket: "guitar-hub-25dfa.appspot.com",
    messagingSenderId: "36479296604",
    appId: "1:36479296604:web:5dbcfb2aec3912f8ba7299",
    measurementId: "G-N4HZW695LF"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // --- Elements & Panels ---
  const loginScreen = document.getElementById("login-screen");
  const mainMenu = document.getElementById("main-menu");
  const chordsPanel = document.getElementById("chords");
  const practicePanel = document.getElementById("practice");
  const strumPanel = document.getElementById("strum");
  const quizPanel = document.getElementById("quiz");
  const dashboardPanel = document.getElementById("dashboard");
  const metronomePanel = document.getElementById("metronome");
  const adminPanel = document.getElementById("admin-panel");
  const accountPanel = document.getElementById("account-panel");
  const adminSongList = document.getElementById("admin-song-list");

  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");
  const authMsg = document.getElementById("auth-msg");
  const burgerBtn = document.getElementById("burger");
  const accountEmail = document.getElementById("account-email");
  const badgeListEl = document.getElementById("badge-list");

  // Hardcoded admin email (change as needed)
  const HARDCODED_ADMIN = "florenzjed12@gmail.com";

  // Persistent theme
  const savedTheme = localStorage.getItem("gh_theme");
  if(savedTheme === "light") document.body.classList.add("light-mode");

  document.getElementById("dark-toggle").addEventListener("click", ()=> {
    document.body.classList.toggle("light-mode");
    if(document.body.classList.contains("light-mode")) localStorage.setItem("gh_theme","light");
    else localStorage.setItem("gh_theme","dark");
  });

  // Burger panel toggle
  burgerBtn.addEventListener("click", ()=>{
    accountPanel.style.display = accountPanel.style.display === "block" ? "none" : "block";
  });

  // show/hide utility
  function showPanel(panel){
    // hide all panels
    [loginScreen, mainMenu, chordsPanel, practicePanel, strumPanel, quizPanel, dashboardPanel, metronomePanel, adminPanel].forEach(p=>{
      if(!p) return;
      p.classList.add("hidden");
    });
    if(panel) panel.classList.remove("hidden");
    accountPanel.style.display='none';
  }

  // Keep many titles white in light-mode per your request
  // (We managed this in CSS: .light-mode overrides certain items to white)

  // Login / Signup / Auth
  document.getElementById("toggle-pass").addEventListener("click", ()=>{
    passwordInput.type = passwordInput.type === "password" ? "text" : "password";
  });

  document.getElementById("signup-btn").addEventListener("click", async ()=>{
    const email = emailInput.value.trim();
    const pw = passwordInput.value;
    if(!email || !pw){ authMsg.textContent = "Provide email & password to sign up."; return; }
    try{
      await createUserWithEmailAndPassword(auth, email, pw);
      authMsg.style.color = "#8f8"; authMsg.textContent = "Account created, signed in.";
    }catch(e){ authMsg.style.color="#f88"; authMsg.textContent = e.message; }
  });

  document.getElementById("login-btn").addEventListener("click", async ()=>{
    const email = emailInput.value.trim();
    const pw = passwordInput.value;
    if(!email || !pw){ authMsg.textContent = "Enter email & password to sign in."; authMsg.style.color="#f88"; return; }
    try{
      await signInWithEmailAndPassword(auth, email, pw);
      authMsg.style.color="#8f8"; authMsg.textContent = "Signed in.";
    }catch(e){ authMsg.style.color="#f88"; authMsg.textContent = e.message; }
  });

  document.getElementById("continue-btn").addEventListener("click", ()=>{
    showPanel(mainMenu);
    accountEmail.textContent = "Guest";
  });

  document.getElementById("forgot-link").addEventListener("click", async (ev)=>{
    ev.preventDefault();
    const email = emailInput.value.trim();
    if(!email){ authMsg.style.color="#f88"; authMsg.textContent = "Enter your email then click Reset."; return; }
    try{
      await sendPasswordResetEmail(auth, email);
      authMsg.style.color="#8f8"; authMsg.textContent = "Reset email sent (check inbox).";
    }catch(e){ authMsg.style.color="#f88"; authMsg.textContent = e.message; }
  });

  document.getElementById("signout-btn").addEventListener("click", async ()=>{
    try{
      await signOut(auth);
      showPanel(loginScreen);
      accountPanel.style.display='none';
      accountEmail.textContent='Not signed in';
      authMsg.textContent='';
      // hide admin panel on logout
      adminPanel.classList.add("hidden");
    }catch(e){ console.error(e); }
  });

  document.getElementById("change-pass").addEventListener("click", async ()=>{
    const newPass = prompt("Enter new password (min 6 chars):");
    if(!newPass) return;
    if(!auth.currentUser){ alert("Sign in required to change password."); return; }
    try{
      await updatePassword(auth.currentUser, newPass);
      alert("Password updated.");
    }catch(e){ alert(e.message); }
  });

  document.getElementById("delete-account").addEventListener("click", async ()=>{
    if(!auth.currentUser){ alert("Not signed in."); return; }
    if(!confirm("Delete your account permanently?")) return;
    try{
      await deleteUser(auth.currentUser);
      alert("Account deleted.");
      showPanel(loginScreen);
    }catch(e){
      alert("Delete failed: "+e.message);
    }
  });

  // When auth changes
  onAuthStateChanged(auth, (user)=>{
    if(user){
      accountEmail.textContent = user.email || "User";
      showPanel(mainMenu);
      authMsg.textContent = "";
      // show admin if email matches hardcoded admin
      if(user.email === HARDCODED_ADMIN) adminPanel.classList.remove("hidden");
      else adminPanel.classList.add("hidden");
      renderBadgesForUser(user);
      ensureLeaderboardEntry(user);
    } else {
      // not signed in
      showPanel(loginScreen);
      accountEmail.textContent = "Not signed in";
      adminPanel.classList.add("hidden");
    }
  });

  // --- Navigation (main menu buttons) ---
  document.getElementById("btn-chords").addEventListener("click", ()=>{
    showPanel(chordsPanel);
    populateChordGrid();
  });
  document.getElementById("btn-practice").addEventListener("click", ()=>{
    showPanel(practicePanel);
  });
  document.getElementById("btn-strum").addEventListener("click", ()=>{
    showPanel(strumPanel);
    renderSongs(); // show song list
  });
  document.getElementById("btn-quiz").addEventListener("click", ()=>{
    showPanel(quizPanel);
  });
  document.getElementById("show-dashboard").addEventListener("click", ()=>{
    showPanel(dashboardPanel);
    accountPanel.style.display='none';
    loadDashboardStats();
  });
  document.getElementById("btn-metronome").addEventListener("click", ()=> showPanel(metronomePanel));

  function goBack(){
    showPanel(mainMenu);
  }

  // --- Chords grid & image mapping ---
  const allChords = ["C","D","E","F","G","A","B","Am","Dm","Em","F#m","Bm","Cmaj7","C#m","G#m","F#","Fsharpm","Bb","Bbmaj","Bbm"];
  const chordGrid = document.getElementById("chord-grid");
  function chordFilename(name){
    // produce possible filenames for name. Map '#' -> sharp, 'm' -> m suffix optionally
    // Example: C -> c.png, F# -> fsharp.png, F#m -> fsharpm.png, Em -> em.png
    let base = name.toLowerCase().replace(/\+/g,"plus").replace(/maj7/g,"maj7").replace(/\s+/g,"");
    base = base.replace("#","sharp");
    // remove any slashes or other chars
    base = base.replace(/[^a-z0-9\-]/g,"");
    // common patterns: 'fsharpm' for F#m, but for natural F# maybe fsharp.png, so try both when checking.
    return base + ".png";
  }

  function populateChordGrid(){
    chordGrid.innerHTML = "";
    // prefer a larger list (allChords), but you can expand
    allChords.forEach(chord=>{
      const card = document.createElement("div");
      card.className = "chord-card";
      const fname = chordFilename(chord);
      const title = document.createElement("div");
      title.style.fontWeight = "700";
      title.style.marginBottom = "8px";
      title.textContent = chord;
      const img = document.createElement("img");
      img.src = `image/${fname}`;
      img.alt = `${chord} chord`;
      img.onerror = function(){ this.onerror=null; this.src='image/placeholder.png' };
      // center image and text
      card.appendChild(title);
      card.appendChild(img);
      chordGrid.appendChild(card);
    });
  }

  // --- Practice chords ---
  const practiceChords = ["C","D","E","F","G","A","B","Am","Dm","Em","F#m","Bm","Cmaj7","C#m","G#m"];
  const practiceDisplay = document.getElementById("practice-chord-display");
  const practiceFeedback = document.getElementById("practice-feedback");
  let currentPracticeChord = null;
  document.getElementById("next-chord").addEventListener("click", ()=>{
    currentPracticeChord = practiceChords[Math.floor(Math.random()*practiceChords.length)];
    practiceDisplay.textContent = currentPracticeChord;
    practiceFeedback.innerHTML = `<img src="image/${chordFilename(currentPracticeChord)}" style="width:150px" onerror="this.onerror=null;this.style.display='none'">`;
  });
  document.getElementById("play-chord").addEventListener("click", ()=>{
    // placeholder: play a quick beep for demonstration
    try{
      const ac = new (window.AudioContext || window.webkitAudioContext)();
      const o = ac.createOscillator();
      const g = ac.createGain();
      o.type = "sine";
      o.frequency.value = 220;
      g.gain.value = 0.05;
      o.connect(g); g.connect(ac.destination);
      o.start();
      setTimeout(()=>{ o.stop(); ac.close(); }, 300);
    }catch(e){ console.warn("Audio not available:", e); }
  });

  // --- Songs list for strum practice ---
  // initial songs array (can be loaded from Firestore)
  let songs = [
    {name:"Wonderwall - Oasis", chords:"Em7 G Dsus4 A7sus4", pattern:"‚Üì ‚Üì ‚Üë ‚Üë ‚Üì ‚Üë"},
    {name:"Knockin' on Heaven's Door - Bob Dylan", chords:"G D Am C", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üì ‚Üë"},
    {name:"Zombie - The Cranberries", chords:"Em C G D", pattern:"‚Üì ‚Üë ‚Üì ‚Üë"},
    {name:"Let It Be - The Beatles", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üì ‚Üë"},
    {name:"Perfect - Ed Sheeran", chords:"G Em C D", pattern:"‚Üì ‚Üì ‚Üë ‚Üë ‚Üì ‚Üë"},
    {name:"Beautiful in White - Westlife", chords:"G D Em C", pattern:"‚Üì ‚Üì ‚Üë ‚Üë ‚Üì ‚Üë"}
  ];

  const songListEl = document.getElementById("song-list");
  const songSearch = document.getElementById("song-search");

  function renderSongs(filter=""){
    songListEl.innerHTML = "";
    const q = (filter||"").trim().toLowerCase();
    songs.forEach((s, idx)=>{
      if(q && !s.name.toLowerCase().includes(q)) return;
      const div = document.createElement("div");
      div.className = "song";
      div.innerHTML = `<div class="title">${s.name}</div>
        <div class="meta">Chords: ${s.chords}<br>Strum: ${s.pattern}</div>
        <div class="song-actions"><button class="ghost" data-idx="${idx}" onclick="selectSongByIndex(${idx})">Select</button></div>`;
      songListEl.appendChild(div);
    });
  }
  songSearch && songSearch.addEventListener("input", ()=> renderSongs(songSearch.value));
  renderSongs();

  function selectSongByIndex(i){
    const s = songs[i];
    if(!s) return;
    document.getElementById("song-pattern").textContent = `Pattern: ${s.pattern} ‚Äî Chords: ${s.chords}`;
    document.getElementById("strum-feedback").textContent = "";
    // set the current pattern for strum practice
    currentPattern = s.pattern.replace(/\s+/g," ").trim().split(" ");
    currentStrumIndex = 0;
    highlightStrum();
  }

  // Optionally load songs from Firestore collection "songs"
  async function loadSongsFromFirestore(){
    try{
      const snaps = await getDocs(collection(db,"songs"));
      const arr = [];
      snaps.forEach(d=>{ arr.push(Object.assign({id:d.id}, d.data())); });
      if(arr.length) {
        songs = arr.map(x => ({name:x.name||x.title||x.name, chords:x.chords||x.capo||"", pattern:x.pattern||"‚Üì ‚Üì ‚Üë"}));
        renderSongs();
      }
    }catch(e){ console.warn("Could not load songs from Firestore:", e); }
  }
  // call once to try to populate if available
  loadSongsFromFirestore();

  // --- Strum detection & accuracy ---
  let audioContext, analyser, dataArray, source;
  // default pattern
  let currentPattern = ["‚Üì","‚Üì","‚Üë","‚Üì"];
  let currentStrumIndex = 0;
  let hits = 0;
  let totalStrums = 0;
  let strumActive = false;
  const strumFeedback = document.getElementById("strum-feedback");
  const startMicBtn = document.getElementById("start-mic");
  const stopMicBtn = document.getElementById("stop-mic");
  const startStrumPracticeBtn = document.getElementById("start-strum-practice");

  let micStream = null;
  async function startMic(){
    if(strumActive) return;
    try{
      if(!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
      micStream = await navigator.mediaDevices.getUserMedia({audio:true});
      source = audioContext.createMediaStreamSource(micStream);
      analyser = audioContext.createAnalyser();
      analyser.fftSize = 2048;
      source.connect(analyser);
      const bufferLength = analyser.fftSize;
      dataArray = new Float32Array(bufferLength);
      // reset counters
      currentStrumIndex = 0;
      hits = 0;
      totalStrums = 0;
      strumActive = true;
      highlightStrum();
      strumFeedback.textContent = "Mic active ‚Äî strum now.";
      requestAnimationFrame(scanForStrums);
    }catch(e){
      strumFeedback.textContent = "Mic access failed: " + (e.message||e);
      console.error(e);
    }
  }

  function stopMic(){
    strumActive = false;
    if(micStream){
      micStream.getTracks().forEach(t=>t.stop());
      micStream = null;
    }
    if(audioContext){
      // don't close audioContext to allow reuse
    }
    strumFeedback.textContent = "Mic stopped.";
  }
  startMicBtn.addEventListener("click", startMic);
  stopMicBtn.addEventListener("click", stopMic);

  // heuristic detection: detect envelope peaks; determine "direction" by measuring slope on short window
  let lastEnvelope = 0;
  function computeEnvelope(arr){
    // arr is Float32Array with values in [-1..1]
    let sum=0;
    for(let i=0;i<100 && i<arr.length;i++){ sum += Math.abs(arr[i]); }
    return sum/100;
  }

  function detectDirection(arr){
    // simple heuristic: compute small-window average, compare front half vs back half
    const mid = Math.floor(arr.length/2);
    let a=0,b=0;
    for(let i=0;i<mid;i++) a += arr[i];
    for(let i=mid;i<arr.length;i++) b += arr[i];
    a /= mid; b /= (arr.length-mid);
    // if back half more positive than front => likely "down" (sweep toward mic), otherwise "up"
    return (Math.abs(b) > Math.abs(a)) ? "‚Üì" : "‚Üë";
  }

  function scanForStrums(){
    if(!strumActive || !analyser) return;
    analyser.getFloatTimeDomainData(dataArray);
    const env = computeEnvelope(dataArray);
    // detect peaks using threshold relative to last envelope
    const threshold = 0.02; // tune this value as needed
    if(env > lastEnvelope + threshold && env > 0.03){
      // detected transient
      const dir = detectDirection(dataArray);
      totalStrums++;
      const expected = currentPattern[currentStrumIndex] || currentPattern[currentStrumIndex % currentPattern.length];
      if(dir === expected){
        hits++;
        currentStrumIndex++;
        strumFeedback.textContent = "Good ("+dir+")";
        highlightStrum(true);
      } else {
        // wrong direction
        strumFeedback.textContent = "Wrong strum ("+dir+") expected "+expected;
        highlightStrum(false);
      }
      // update dashboard stat locally and in Firestore if signed in
      const accuracy = totalStrums>0?Math.round((hits/totalStrums)*100):0;
      document.getElementById("dash-strum").textContent = accuracy + "%";
      // attempt to update firestore leaderboard if user signed in
      if(auth.currentUser){
        ensureLeaderboardEntry(auth.currentUser, {strumAccuracy: accuracy});
      }
      if(currentStrumIndex >= currentPattern.length){
        strumFeedback.textContent = "Pattern completed!";
        strumActive = false;
        return;
      }
    }
    lastEnvelope = env;
    requestAnimationFrame(scanForStrums);
  }

  function highlightStrum(correct){
    const el = document.getElementById("strum-highlight");
    if(!el) return;
    const html = currentPattern.map((s,i)=>{
      if(i < currentStrumIndex) return `<span style="opacity:0.6">${s}</span>`;
      if(i === currentStrumIndex){
        if(correct===true) return `<span style="background:green;padding:4px;border-radius:4px">${s}</span>`;
        if(correct===false) return `<span style="background:red;padding:4px;border-radius:4px">${s}</span>`;
        return `<span style="background:orange;padding:4px;border-radius:4px">${s}</span>`;
      }
      return s;
    }).join(" ");
    el.innerHTML = html;
  }

  startStrumPracticeBtn.addEventListener("click", ()=>{
    // ensure pattern set
    if(!currentPattern || !currentPattern.length){
      currentPattern = ["‚Üì","‚Üì","‚Üë","‚Üì"];
    }
    currentStrumIndex = 0;
    hits = 0;
    totalStrums = 0;
    strumActive = true;
    highlightStrum();
    startMic();
  });

  // --- Quiz logic ---
  const quizChords = ["C","D","E","F","G","A","B","Am","Dm","Em","F#m","Bm","Cmaj7","C#m","G#m"];
  let quizScore = 0;
  let quizCount = 0;
  let quizTotal = 10;
  const quizArea = document.getElementById("quiz-area");
  const quizResult = document.getElementById("quiz-result");
  const quizImage = document.getElementById("quiz-image");
  const quizOptions = document.getElementById("quiz-options");
  const timerEl = document.getElementById("timer");
  let quizTimer;
  let currentQuizChord;

  function shuffleArray(array){
    const arr = array.slice();
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()* (i+1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  document.getElementById("start-quiz").addEventListener("click", ()=>{
    quizScore = 0;
    quizCount = 0;
    quizTotal = 10;
    quizArea.classList.remove("hidden");
    quizResult.classList.add("hidden");
    nextQuizChord();
  });

  document.getElementById("reset-quiz").addEventListener("click", ()=>{
    quizScore=0; quizCount=0;
   quizArea.classList.add("hidden");
    quizResult.classList.add("hidden");
  });

  function nextQuizChord(){
    const configuredTime = Math.max(1, parseInt(document.getElementById("quiz-timer").value || "5"));
    if(quizCount >= quizTotal){
      quizArea.classList.add("hidden");
      quizResult.classList.remove("hidden");
      quizResult.textContent = `Quiz Completed! Score: ${quizScore}/${quizTotal}`;
      // update quiz history in dashboard
      updateQuizHistory(quizScore);
      return;
    }
    currentQuizChord = quizChords[Math.floor(Math.random()*quizChords.length)];
    // show image if exists
    const fname = chordFilename(currentQuizChord);
    quizImage.innerHTML = `<img src="image/${fname}" alt="${currentQuizChord}" style="width:160px" onerror="this.onerror=null;this.style.display='none'">`;
    quizOptions.innerHTML = "";
    // pick 4 options
    const choices = shuffleArray(quizChords).slice(0,4);
    if(!choices.includes(currentQuizChord)) choices[Math.floor(Math.random()*4)] = currentQuizChord;
    choices.forEach(o=>{
      const btn = document.createElement("button");
      btn.textContent = o;
      btn.addEventListener("click", ()=>{
        if(o===currentQuizChord) quizScore++;
        quizCount++;
        clearInterval(quizTimer);
        nextQuizChord();
      });
      quizOptions.appendChild(btn);
    });
    startTimeForQuiz(configuredTime);
  }

  function startTimeForQuiz(seconds){
    let t = seconds;
    timerEl.textContent = t;
    clearInterval(quizTimer);
    quizTimer = setInterval(()=>{
      t--;
      timerEl.textContent = t;
      if(t<=0){
        clearInterval(quizTimer);
        quizCount++;
        nextQuizChord();
      }
    },1000);
  }

  function updateQuizHistory(score){
    const hist = JSON.parse(localStorage.getItem("gh_quiz_history")||"[]");
    hist.unshift({score, at:Date.now()});
    if(hist.length>10) hist.pop();
    localStorage.setItem("gh_quiz_history", JSON.stringify(hist));
    document.getElementById("dash-quiz").textContent = hist.slice(0,3).map(h=>h.score).join(", ") || "N/A";
    // update leaderboard as well
    if(auth.currentUser) ensureLeaderboardEntry(auth.currentUser, {lastQuizScore: score});
  }

  // --- Dashboard ---
  async function loadDashboardStats(){
    const acc = document.getElementById("dash-strum");
    const hist = JSON.parse(localStorage.getItem("gh_quiz_history")||"[]");
    document.getElementById("dash-quiz").textContent = hist.length ? hist.map(h=>h.score).join(", ") : "N/A";
    // strum accuracy shown live
    // load leaderboard entry if available
    if(auth.currentUser){
      try{
        const q = query(collection(db, "leaderboard"), where("displayName", "==", auth.currentUser.email));
        const snaps = await getDocs(q);
        snaps.forEach(d=>{
          const data = d.data();
          if(data && data.streak) document.getElementById("dash-streak").textContent = data.streak;
          if(data && data.highScore !== undefined) document.getElementById("dash-quiz").textContent = data.highScore;
        });
      }catch(e){ console.warn("Dashboard firestore load error", e); }
    }
  }

  // --- Leaderboard helper functions ---
  async function ensureLeaderboardEntry(user, extra={}){
    // create or update a leaderboard doc keyed by uid if possible
    if(!user) return;
    try{
      const q = query(collection(db, "leaderboard"), where("displayName", "==", user.email));
      const snaps = await getDocs(q);
      if(snaps.empty){
        // create
        await addDoc(collection(db,"leaderboard"), {
          displayName: user.email,
          highScore: extra.lastQuizScore || 0,
          lastPlayed: Date.now(),
          level: "Beginner",
          streak: extra.streak || 0,
          badges: ["Beginner"]
        });
      } else {
        // update first match
        const docSnap = snaps.docs[0];
        await updateDoc(doc(db,"leaderboard",docSnap.id), Object.assign({
          lastPlayed: Date.now()
        }, extra));
      }
    }catch(e){ console.warn("Leaderboard ensure failed", e); }
  }

  // --- Admin panel functions ---
  document.getElementById("admin-add-song").addEventListener("click", async ()=>{
    const name = prompt("Song name (Artist - Title):");
    if(!name) return;
    const chords = prompt("Chords (space separated or comma):", "G D Em C");
    const pattern = prompt("Strum pattern (use ‚Üì and ‚Üë):", "‚Üì ‚Üì ‚Üë ‚Üë ‚Üì ‚Üë");
    try{
      await addDoc(collection(db,"songs"), {name, chords, pattern, created: Date.now()});
      alert("Song added to Firestore.");
      loadSongsFromFirestore();
    }catch(e){
      alert("Add failed: " + e.message);
    }
  });

  document.getElementById("admin-bulk-add").addEventListener("click", async ()=>{
    const bulk = prompt("Paste songs JSON array (e.g. [{name:'n',chords:'',pattern:''},...])");
    if(!bulk) return;
    try{
      const arr = JSON.parse(bulk);
      let count = 0;
      for(const s of arr){
        if(!s.name) continue;
        await addDoc(collection(db,"songs"), {name: s.name, chords: s.chords||"", pattern: s.pattern||"‚Üì ‚Üì ‚Üë"});
        count++;
      }
      alert(`${count} songs added.`);
      loadSongsFromFirestore();
    }catch(e){ alert("Bulk add error: " + e.message); }
  });

  document.getElementById("admin-refresh").addEventListener("click", ()=> loadSongsFromFirestore());

  document.getElementById("apply-override").addEventListener("click", async ()=>{
    const email = document.getElementById("override-user").value;
    const streak = parseInt(document.getElementById("override-streak").value)||0;
    const level = document.getElementById("override-level").value || "Beginner";
    const highScore = parseInt(document.getElementById("override-highscore").value)||0;
    if(!email){ alert("Enter email"); return; }
    // find doc by displayName (email)
    const q = query(collection(db,"leaderboard"), where("displayName","==", email));
    const snaps = await getDocs(q);
    if(!snaps.empty){
      const d = snaps.docs[0];
      await updateDoc(doc(db,"leaderboard",d.id), {streak, level, highScore, lastPlayed: Date.now()});
      alert("User updated.");
    } else {
      await addDoc(collection(db,"leaderboard"), {displayName: email, streak, level, highScore, lastPlayed: Date.now()});
      alert("New user created.");
    }
  });

  // load admin song list view
  async function renderAdminSongList(){
    adminSongList.innerHTML = "";
    try{
      const snaps = await getDocs(collection(db,"songs"));
      snaps.forEach(d=>{
        const data = d.data();
        const div = document.createElement("div");
        div.style.borderBottom = "1px solid #222";
        div.style.padding = "8px 0";
        div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;">
          <div style="flex:1;">
            <div style="font-weight:700;color:var(--white)">${data.name}</div>
            <div class="muted-small">Chords: ${data.chords} | Pattern: ${data.pattern}</div>
          </div>
          <div style="margin-left:10px">
            <button class="ghost" data-id="${d.id}" data-name="${data.name}">Edit</button>
            <button class="ghost" data-id="${d.id}" data-name="${data.name}" style="color:#f88">Delete</button>
          </div>
        </div>`;
        adminSongList.appendChild(div);
      });
      // wire edit buttons (delegation)
      adminSongList.querySelectorAll("button.ghost").forEach(b=>{
        b.addEventListener("click", async (e)=>{
          const id = b.getAttribute("data-id");
          if(b.textContent.trim().toLowerCase() === "edit"){
            const docRef = doc(db,"songs",id);
            // fetch doc
            const snaps = await getDocs(query(collection(db,"songs"), where("__name__","==",id)));
            let rec = null;
            snaps.forEach(s=> rec = Object.assign({id:s.id}, s.data()));
            if(!rec) {
              alert("Could not load song.");
              return;
            }
            // show prompt editing GUI
            const newName = prompt("Song name:", rec.name);
            if(newName===null) return;
            const newChords = prompt("Chords:", rec.chords || "");
            if(newChords===null) return;
            const newPattern = prompt("Pattern:", rec.pattern || "‚Üì ‚Üì ‚Üë");
            if(newPattern===null) return;
            await updateDoc(doc(db,"songs",id), {name:newName, chords:newChords, pattern:newPattern});
            alert("Saved.");
            renderAdminSongList();
            loadSongsFromFirestore();
          } else {
            // delete confirmation (simple delete not implemented fully due to limited API in this snippet)
            if(!confirm("Delete this song?")) return;
            try{
              await updateDoc(doc(db,"songs",id), {deleted: true});
              alert("Marked deleted (soft). Refreshing.");
              renderAdminSongList();
            }catch(err){ alert("Delete failed: " + err.message); }
          }
        });
      });
    }catch(e){ adminSongList.innerHTML = "Failed to load songs: " + e.message; }
  }

  // periodically render admin list when admin panel visible
  setInterval(()=>{ if(!adminPanel.classList.contains("hidden")) renderAdminSongList(); }, 8000);

  // --- Metronome ---
  let metronomeInterval = null;
  let beatIndex = 0;
  function startMetronome(){
    const bpm = parseInt(document.getElementById("metronome-bpm").value || 100);
    document.getElementById("bpm-display").textContent = bpm;
    const ms = 60000 / bpm;
    if(metronomeInterval) clearInterval(metronomeInterval);
    // audio click
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    metronomeInterval = setInterval(()=>{
      // play short click
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = "square";
      o.frequency.value = 880;
      g.gain.value = 0.05;
      o.connect(g); g.connect(ctx.destination);
      o.start();
      setTimeout(()=>o.stop(), 60);
      // move ball visually: alternate translateXpercentage
      const ball = document.getElementById("metronome-ball");
      if(!ball) return;
      beatIndex = (beatIndex+1)%4;
      const leftPercent = (beatIndex / 3) * 100;
      ball.style.transform = `translateX(${leftPercent}%)`;
    }, ms);
  }
  function stopMetronome(){
    if(metronomeInterval) clearInterval(metronomeInterval);
    metronomeInterval = null;
    document.getElementById("metronome-ball").style.transform = `translateX(0%)`;
  }
  document.getElementById("metronome-bpm").addEventListener("input", (e)=> document.getElementById("bpm-display").textContent = e.target.value);
  document.getElementById("start-metronome").addEventListener("click", startMetronome);
  document.getElementById("stop-metronome").addEventListener("click", stopMetronome);

  // --- Utility: shuffle/populate on load ---
  function init(){
    // show login or main menu based on auth state handled by onAuthStateChanged
    populateChordGrid();
    renderSongs();
    // render badges sample
    badgeListEl.innerHTML = `<div class="badge-pill">Beginner</div> <div class="badge-pill">Intermediate</div>`;
  }
  init();

  // --- Extras: make certain texts non-copyable as requested (class .not-copy used) ---

  // --- Recording dashboard update example ---
  document.getElementById("download-data").addEventListener("click", ()=>{
    const data = {
      quiz: JSON.parse(localStorage.getItem("gh_quiz_history")||"[]"),
      strumAccuracy: document.getElementById("dash-strum").textContent
    };
    const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "guitarhub_stats.json";
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  });

  // expose some functions for convenience in console
  window.GH = {
    showPanel, populateChordGrid, renderSongs, startMic, stopMic, loadSongsFromFirestore, renderAdminSongList
  };

  // Additional minor: load leaderboard into console for debugging
  window.loadLeaderboard = async ()=>{
    const snaps = await getDocs(collection(db,"leaderboard"));
    const arr = [];
    snaps.forEach(d=> arr.push(Object.assign({id:d.id}, d.data())));
    console.log(arr);
    return arr;
  };

  // finalize
  console.log("Guitar Hub Trainer loaded.");
</script>
</body>
</html>

