<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Guitar Hub-Ultimate Edition</title>
<style>
  :root{
    --bg:#111;
    --panel:#000;
    --accent:orange;
    --muted:#222;
    --text:#fff;
    --card:#1a1a1a;
    --white:#fff;
    --success: #28a745;
    --danger: #ff595e;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:Arial, sans-serif;
    background:var(--bg);
    color:var(--text);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    text-align:center;
    transition:background 0.25s,color 0.25s;
  }
  header{
    width:100%;
    background:var(--panel);
    padding:10px 18px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    position:fixed;
    top:0; left:0;
    z-index:1000;
    box-shadow:0 2px 8px rgba(0,0,0,0.6);
  }
  .logo{display:flex;align-items:center;font-weight:700;font-size:1.25rem;color:var(--white)}
  .logo .guitar{color:var(--white)}
  .logo .hub{color:black;background:orange;padding:4px 8px;border-radius:6px;margin-left:8px}
  .controls{display:flex;gap:8px;align-items:center}
  main{padding:92px 14px 40px; max-width:1100px;margin:0 auto; text-align:left;}
  button{padding:10px 16px;border-radius:8px;border:none;background:var(--accent);color:#000;font-weight:600;cursor:pointer;transition:all 0.18s}
  button:hover{opacity:0.95}
  .back-btn{background:#444;color:#fff}
  .ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:8px}
  .card{background:var(--muted);padding:14px;border-radius:10px;margin:12px 0;box-shadow:0 6px 16px rgba(0,0,0,0.6);transition:all 0.3s ease}
  .hidden{display:none;opacity:0;transition:opacity 0.3s ease}
  .visible{display:block;opacity:1;transition:opacity 0.3s ease}
  .chord-grid{display:flex;flex-wrap:wrap;gap:14px;justify-content:center;padding:8px}
  .chord-card{width:120px;background:#222;padding:10px;border-radius:10px;box-shadow:0 6px 14px rgba(0,0,0,0.6);text-align:center;transition:transform 0.2s; color:var(--white)}
  .chord-card:hover{transform:scale(1.05)}
  .chord-card img{width:100px;height:auto;display:block;margin:8px auto}
  .timer{font-weight:700;color:gold;font-size:1.2rem;margin:8px}
  #quiz-options button{display:block;width:100%;margin:8px 0;background:#333;color:#fff;padding:10px;border-radius:8px}
  input[type="text"],input[type="email"],input[type="password"],textarea{
    width:100%;padding:10px;border-radius:8px;border:none;background:#1b1b1b;color:#fff;margin-bottom:10px;font-size:1rem;
  }
  .row{display:flex;gap:8px;align-items:center}
  .row .small{width:48px;padding:8px}
  .song{padding:10px;border-radius:8px;background:#171717;margin:8px 0;text-align:left;color:var(--white)}
  .song .title{font-weight:700}
  .song .meta{font-size:0.9rem;color:#ddd;margin-top:6px}
  #burger{font-size:1.4rem;background:none;border:none;color:#fff;cursor:pointer;padding:6px 8px}
  #account-panel{position:fixed;top:58px;right:12px;width:320px;background:#141414;padding:12px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,0.6);display:none;z-index:1100;color:var(--white)}
  #account-panel h4{margin:0 0 8px 0}
  #strum-highlight{font-size:1.5rem;margin:12px 0;letter-spacing:6px;color:var(--white)}
  .small-muted{font-size:0.85rem;color:#bbb}
  /* Metronome */
  .metronome{
    display:flex;align-items:center;gap:12px;justify-content:center;margin-top:12px;
  }
  .metro-track{
    position:relative;width:240px;height:8px;background:#333;border-radius:8px;overflow:hidden;
  }
  .metro-ball{
    position:absolute;left:0;top:-6px;width:20px;height:20px;border-radius:50%;background:orange;box-shadow:0 3px 8px rgba(0,0,0,0.6);transform:translateX(0);
  }
  .metro-beat{
    height:100%;width:2px;background:#444;display:inline-block;margin-left:0;
  }
  .badge{display:inline-block;padding:4px 8px;border-radius:8px;background:#222;color:#fff;margin:4px;font-weight:700}
  .admin-only{display:none}
  .no-select{user-select:none}
  .inline-row{display:flex;gap:8px;align-items:center}
  .table{width:100%;border-collapse:collapse}
  .table td,.table th{padding:8px;border-bottom:1px solid #222}
  .leaderboard {max-height:300px;overflow:auto}
  /* light mode tweaks but keep key text white where requested */
  .light-mode{background:#fff;color:#000}
  .light-mode .card{background:#fff}
  .light-mode .song{color:var(--white) !important}
  .light-mode .logo .guitar{color:var(--white)}
  .light-mode .logo .hub{background:orange;color:black}
  /* ensure main text items remain white when toggled */
  .force-white { color: var(--white) !important; }
  @media (max-width:900px){
    main{padding:110px 14px}
    .metro-track{width:160px}
  }
</style>
</head>
<body class="no-select">

<header>
  <div class="logo">
    <span class="guitar">ùóöùòÇùó∂ùòÅùóÆùóø</span><span class="hub">ùóõùòÇùóØ</span>
  </div>
  <div class="controls">
    <button id="dark-toggle" title="Toggle theme">üåó</button>
    <button id="burger" aria-label="Open account menu">‚ò∞</button>
  </div>
</header>

<div id="account-panel" aria-hidden="true">
  <h4>Account</h4>
  <p id="account-email">Not signed in</p>
  <p id="account-username" class="small-muted">No username</p>
  <div style="display:flex;gap:8px;margin-top:8px;">
    <button id="show-dashboard" class="ghost">Dashboard</button>
    <button id="signout-btn" class="ghost">Sign out</button>
  </div>
  <hr style="margin:10px 0;border-color:#222">
  <div style="display:flex;gap:8px;margin-bottom:8px">
    <button id="change-username" class="ghost" style="flex:1">Change Username</button>
    <button id="change-pass" class="ghost">Change password</button>
  </div>
  <button id="delete-account" class="ghost" style="width:100%;color:#ff6666">Delete account</button>
  <div style="margin-top:10px" id="badge-area"></div>
</div>

<main>
  <!-- LOGIN -->
  <div id="login-screen" class="card">
    <h1 style="margin:0 0 8px 0;color:var(--white)">Login</h1>
    <input id="email" type="email" placeholder="Email" autocomplete="username">
    <div class="row" style="align-items:center">
      <input id="password" type="password" placeholder="Password" autocomplete="current-password" style="flex:1">
      <button id="toggle-pass" class="ghost small" title="Show/Hide">üëÅÔ∏è</button>
    </div>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:8px">
      <button id="login-btn">Login</button>
      <button id="signup-btn" class="ghost">Sign up</button>
    </div>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:10px">
      <button id="continue-btn" class="ghost">Continue without account</button>
    </div>
    <p style="margin:12px 0 0 0"><a href="#" id="forgot-link" style="color:#ddd">Forgot password?</a></p>
    <p id="auth-msg" style="color:#f88;margin-top:8px"></p>
  </div>

  <!-- MAIN MENU -->
  <div id="main-menu" class="card hidden">
    <h2 style="margin-top:0;color:var(--white)">Main Menu</h2>
    <div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center">
      <button id="btn-chords" class="force-white">View Chords</button>
      <button id="btn-practice" class="force-white">Practice Chords</button>
      <button id="btn-strum" class="force-white">Practice Strum</button>
      <button id="btn-quiz" class="force-white">Chord Recognition Quiz</button>
      <button id="btn-learn-songs" class="ghost force-white">Learn Songs</button>
      <button id="btn-tune" class="ghost force-white">Tune with GuitarTuna</button>
      <button id="btn-metronome" class="ghost force-white">Metronome</button>
    </div>
  </div>

  <!-- CHORDS -->
  <div id="chords" class="card hidden">
    <h2 style="margin-top:0;color:var(--white)">Basic Chords</h2>
    <div class="chord-grid" id="chord-grid"></div>
    <button class="back-btn" id="chords-back">‚¨Ö Back</button>
  </div>

  <!-- PRACTICE -->
  <div id="practice" class="card hidden">
    <h2 style="margin-top:0;color:var(--white)">Practice Chords (Random)</h2>
    <div id="practice-chord-display" style="font-size:2rem;margin:16px;color:var(--white)"></div>
    <div style="display:flex;gap:8px;justify-content:center">
      <button id="next-chord">Next Chord</button>
      <button id="play-chord" class="ghost">Play Chord</button>
    </div>
    <p id="practice-feedback" style="margin-top:10px;color:var(--white)"></p>
    <button class="back-btn" id="practice-back">‚¨Ö Back</button>
  </div>

  <!-- STRUM -->
  <div id="strum" class="card hidden">
    <h2 style="margin-top:0;color:var(--white)">Practice Strum</h2>
    <input id="song-search" type="text" placeholder="Search songs..." style="margin-bottom:12px;color:#fff;background:#222"/>
    <div id="song-list" style="max-height:360px;overflow:auto;padding-right:6px"></div>
    <div style="margin-top:12px">
      <p id="song-pattern" style="font-weight:700;color:var(--white)">Pattern: ‚Äî</p>
      <div style="display:flex;gap:8px">
        <button id="start-mic" class="ghost">Start Mic Test</button>
        <button id="start-strum-practice" class="ghost">Start Strum Practice</button>
        <button id="stop-mic" class="ghost">Stop Mic</button>
      </div>
      <p id="strum-feedback" style="margin-top:8px;color:var(--white)"></p>
      <div id="strum-highlight"></div>
    </div>
    <button class="back-btn" id="strum-back">‚¨Ö Back</button>
  </div>

  <!-- QUIZ -->
  <div id="quiz" class="card hidden">
    <h2 style="margin-top:0;color:var(--white)">Chord Recognition Quiz</h2>
    <div style="margin-bottom:12px">
      <button id="start-quiz">Start Quiz</button>
      <button id="reset-quiz" class="ghost" style="display:none">Reset</button>
    </div>
    <div id="quiz-area" class="hidden" style="text-align:center">
      <div class="timer" id="timer">5</div>
      <div id="quiz-image" style="margin:8px"></div>
      <div id="quiz-options" style="max-width:420px;margin:0 auto;text-align:center"></div>
      <p id="quiz-progress" style="margin-top:8px;color:var(--white)"></p>
    </div>
    <div id="quiz-result" class="hidden" style="margin-top:12px;font-weight:700;color:var(--white)"></div>
    <button class="back-btn" id="quiz-back">‚¨Ö Back</button>
  </div>

  <!-- METRONOME -->
  <div id="metronome" class="card hidden">
    <h2 style="margin-top:0;color:var(--white)">Metronome</h2>
    <div class="metronome">
      <div style="display:flex;flex-direction:column;gap:8px;align-items:center">
        <label style="color:var(--white)">BPM</label>
        <input id="metro-bpm" type="number" min="40" max="240" value="90" style="width:80px">
      </div>
      <div class="metro-track" id="metro-track">
        <div class="metro-ball" id="metro-ball"></div>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px;align-items:center">
        <label style="color:var(--white)">Beats</label>
        <input id="metro-beats" type="number" min="1" max="12" value="4" style="width:80px">
      </div>
    </div>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:12px">
      <button id="start-metro">Start</button>
      <button id="stop-metro" class="ghost">Stop</button>
    </div>
    <button class="back-btn" id="metro-back">‚¨Ö Back</button>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard" class="card hidden">
    <h2 style="margin-top:0;color:var(--white)">Dashboard</h2>
    <p style="color:var(--white)">Username: <span id="dash-username">‚Äî</span></p>
    <p style="color:var(--white)">Strum Accuracy: <span id="dash-strum">0%</span></p>
    <p style="color:var(--white)">Quiz Score History: <span id="dash-quiz">N/A</span></p>
    <div id="leaderboard-wrap" style="margin-top:12px">
      <h3 style="color:var(--white)">Leaderboard</h3>
      <div class="leaderboard card" id="leaderboard"></div>
    </div>
    <button class="back-btn" id="dash-back">‚¨Ö Back</button>
  </div>

  <!-- ADMIN PANEL -->
  <div id="admin-panel" class="card hidden">
    <h2 style="margin-top:0;color:var(--white)">Admin Controls</h2>

    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
      <input id="admin-new-song" type="text" placeholder="Song JSON (name|author|capo|chords|pattern)" style="flex:1">
      <button id="admin-add-song">Add Song</button>
    </div>

    <div style="margin-bottom:8px">
      <label style="color:var(--white)">Bulk add songs (paste JSON array of objects)</label>
      <textarea id="admin-bulk" rows="6" placeholder='[{"name":"Song","author":"X","capo":"","chords":"G C D","pattern":"‚Üì ‚Üì ‚Üë ‚Üë"}, ...]'></textarea>
      <div style="display:flex;gap:8px">
        <button id="admin-bulk-add">Bulk Add</button>
        <button id="admin-clear-songs" class="ghost">Clear All Songs</button>
      </div>
    </div>

    <h3 style="color:var(--white)">Songs (editable)</h3>
    <div id="admin-song-list" style="max-height:300px;overflow:auto"></div>

    <h3 style="color:var(--white);margin-top:12px">Manual User Override</h3>
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <input id="override-user" type="text" placeholder="Enter user email">
      <input id="override-username" type="text" placeholder="Set username">
    </div>
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <input id="override-streak" type="number" placeholder="Set streak">
      <input id="override-level" type="text" placeholder="Set level">
      <input id="override-highscore" type="number" placeholder="Set high score">
    </div>
    <div style="display:flex;gap:8px">
      <button id="apply-override">Apply Changes</button>
      <button id="admin-close" class="ghost">Close Admin (hide)</button>
    </div>

    <button class="back-btn" id="admin-back">‚¨Ö Back</button>
  </div>

  <div id="footer-note" class="card" style="display:none">
    <p style="color:#aaa">Footer / debug info</p>
  </div>

</main>

<!-- Firebase & App Logic -->
<script type="module">
  // Firebase (CDN) modules (v12.x)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail, onAuthStateChanged, updatePassword, deleteUser } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
  import { getFirestore, collection, getDocs, addDoc, doc, setDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

  // ---------- Configuration ----------
  const firebaseConfig = {
    apiKey: "AIzaSyDkMmF78dFu2dmuzka6xuwpLRD5NRCCJtY",
    authDomain: "guitar-hub-25dfa.firebaseapp.com",
    projectId: "guitar-hub-25dfa",
    storageBucket: "guitar-hub-25dfa.appspot.com",
    messagingSenderId: "36479296604",
    appId: "1:36479296604:web:5dbcfb2aec3912f8ba7299",
    measurementId: "G-N4HZW695LF"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ---------- Elements ----------
  const loginScreen = document.getElementById("login-screen");
  const mainMenu = document.getElementById("main-menu");
  const chordsPanel = document.getElementById("chords");
  const practicePanel = document.getElementById("practice");
  const strumPanel = document.getElementById("strum");
  const quizPanel = document.getElementById("quiz");
  const dashboardPanel = document.getElementById("dashboard");
  const adminPanel = document.getElementById("admin-panel");
  const metronomePanel = document.getElementById("metronome");

  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");
  const authMsg = document.getElementById("auth-msg");
  const burgerBtn = document.getElementById("burger");
  const accountPanel = document.getElementById("account-panel");
  const accountEmail = document.getElementById("account-email");
  const accountUsername = document.getElementById("account-username");
  const badgeArea = document.getElementById("badge-area");

  // Admin email hardcoded (change to your admin email)
  const adminEmail = "florenzjed12@gmail.com"; // <-- change here if needed

  // ---------- UI helpers ----------
  function showPanel(panel){
    [loginScreen, mainMenu, chordsPanel, practicePanel, strumPanel, quizPanel, dashboardPanel, adminPanel, metronomePanel].forEach(p=>{
      if(p===panel){
        p.classList.remove("hidden");
        p.classList.add("visible");
      } else {
        p.classList.add("hidden");
        p.classList.remove("visible");
      }
    });
    // hide account panel on navigation
    accountPanel.style.display = 'none';
  }
  function goBack(){
    chordsPanel.classList.add("hidden");
    practicePanel.classList.add("hidden");
    strumPanel.classList.add("hidden");
    quizPanel.classList.add("hidden");
    dashboardPanel.classList.add("hidden");
    adminPanel.classList.add("hidden");
    metronomePanel.classList.add("hidden");
    mainMenu.classList.remove("hidden");
  }

  // ---------- Dark toggle ----------
  document.getElementById("dark-toggle").addEventListener("click", ()=> {
    document.body.classList.toggle("light-mode");
    // keep certain texts white as requested
    document.querySelectorAll('.force-white').forEach(el=>el.style.color='var(--white)');
    document.querySelectorAll('.song').forEach(el=>el.style.color='var(--white)');
    document.querySelectorAll('#practice h2,#main-menu h2,#login-screen h1').forEach(el=>el.style.color='var(--white)');
  });

  burgerBtn.addEventListener("click", ()=>{
    accountPanel.style.display = accountPanel.style.display === "block" ? "none" : "block";
  });

  // ---------- Auth ----------
  document.getElementById("signup-btn").addEventListener("click", async ()=>{
    const email = emailInput.value.trim();
    const pw = passwordInput.value;
    if(!email || !pw){ authMsg.textContent = "Provide email & password to sign up."; return; }
    try{
      await createUserWithEmailAndPassword(auth, email, pw);
      authMsg.style.color = "#8f8"; authMsg.textContent = "Account created, signed in.";
    }catch(e){ authMsg.style.color="#f88"; authMsg.textContent = e.message; }
  });

  document.getElementById("login-btn").addEventListener("click", async ()=>{
    const email = emailInput.value.trim();
    const pw = passwordInput.value;
    if(!email || !pw){ authMsg.textContent = "Enter email & password to sign in."; authMsg.style.color="#f88"; return; }
    try{
      await signInWithEmailAndPassword(auth, email, pw);
      authMsg.style.color="#8f8"; authMsg.textContent = "Signed in.";
    }catch(e){ authMsg.style.color="#f88"; authMsg.textContent = e.message; }
  });

  document.getElementById("forgot-link").addEventListener("click", async (ev)=>{
    ev.preventDefault();
    const email = emailInput.value.trim();
    if(!email){ authMsg.style.color="#f88"; authMsg.textContent = "Enter your email then click Reset."; return; }
    try{
      await sendPasswordResetEmail(auth, email);
      authMsg.style.color="#8f8"; authMsg.textContent = "Reset email sent (check inbox).";
    }catch(e){ authMsg.style.color="#f88"; authMsg.textContent = e.message; }
  });

  document.getElementById("signout-btn").addEventListener("click", async ()=>{
    try{ await signOut(auth); loginScreen.classList.remove("hidden"); mainMenu.classList.add("hidden"); accountPanel.style.display='none'; accountEmail.textContent='Not signed in'; accountUsername.textContent='No username'; authMsg.textContent=''; }
    catch(e){ console.error(e); }
  });

  document.getElementById("delete-account").addEventListener("click", async ()=>{
    if(!auth.currentUser){ alert("Not signed in."); return; }
    if(!confirm("Delete your account permanently?")) return;
    try{
      await deleteUser(auth.currentUser);
      alert("Account deleted.");
      loginScreen.classList.remove("hidden"); mainMenu.classList.add("hidden");
    }catch(e){
      alert("Delete failed: "+e.message);
    }
  });

  document.getElementById("change-pass").addEventListener("click", async ()=>{
    const newPass = prompt("Enter new password (min 6 chars):");
    if(!newPass) return;
    if(!auth.currentUser){ alert("Sign in required to change password."); return; }
    try{
      await updatePassword(auth.currentUser, newPass);
      alert("Password updated.");
    }catch(e){ alert(e.message); }
  });

  // change username
  document.getElementById("change-username").addEventListener("click", async ()=>{
    const newUser = prompt("Enter new username:");
    if(!newUser) return;
    const user = auth.currentUser;
    if(!user){
      alert("Sign in required.");
      return;
    }
    // update local display and attempt to write to leaderboard doc if exists
    accountUsername.textContent = newUser;
    accountEmail.textContent = user.email;
    try{
      // search for leaderboard doc with this user's email
      const lb = collection(db,"leaderboard");
      const snaps = await getDocs(lb);
      let foundId = null;
      snaps.forEach(s=>{
        if(s.data().email === user.email || s.data().displayName === user.email || s.data().displayName === newUser) {
          foundId = s.id;
        }
      });
      if(foundId){
        await updateDoc(doc(db,"leaderboard",foundId), { displayName:newUser, lastPlayed:Date.now() });
      } else {
        // create a new leaderboard doc for this user
        await addDoc(collection(db,"leaderboard"), { displayName:newUser, email: user.email, highScore:0, lastPlayed:Date.now(), streak:0, level:"Beginner" });
      }
      alert("Username updated.");
      renderLeaderboard(); // refresh
    }catch(e){
      console.warn("Could not update leaderboard username:", e);
    }
  });

  // Watch auth changes
  onAuthStateChanged(auth, async (user)=>{
    if(user){
      accountEmail.textContent = user.email || "User";
      // default username from email if none
      const pretty = (user.email || "Guest").split("@")[0];
      accountUsername.textContent = pretty;
      // show main menu
      loginScreen.classList.add("hidden");
      mainMenu.classList.remove("hidden");
      // show admin panel if admin email
      if(user.email === adminEmail){
        adminPanel.classList.remove("hidden");
        adminPanel.classList.add("visible");
        document.getElementById("admin-add-song").classList.remove('hidden');
      } else {
        adminPanel.classList.add("hidden");
      }
      // upsert leaderboard entry for newly signed user (ensures everyone is tracked)
      try{
        const snaps = await getDocs(collection(db,"leaderboard"));
        let found = null;
        snaps.forEach(s=>{
          const d = s.data();
          if(d.email === user.email || d.displayName === user.email){
            found = { id:s.id, data:d };
          }
        });
        if(!found){
          await addDoc(collection(db,"leaderboard"), { displayName: pretty, email: user.email, highScore: 0, lastPlayed: Date.now(), streak:0, level:"Beginner" });
        }
      }catch(e){
        console.warn("Leaderboard upsert failed", e);
      }
    } else {
      accountEmail.textContent = "Not signed in";
      accountUsername.textContent = "No username";
      // show login by default
      loginScreen.classList.remove("hidden");
      mainMenu.classList.add("hidden");
      adminPanel.classList.add("hidden");
    }
    renderLeaderboard();
  });

  // CONTROLS for main menu buttons
  document.getElementById("btn-chords").addEventListener("click", ()=>{
    showPanel(chordsPanel);
    populateChordGrid();
  });
  document.getElementById("btn-practice").addEventListener("click", ()=>{
    showPanel(practicePanel);
  });
  document.getElementById("btn-strum").addEventListener("click", ()=>{
    showPanel(strumPanel);
    renderSongs(); // populate song list
  });
  document.getElementById("btn-quiz").addEventListener("click", ()=>{
    showPanel(quizPanel);
  });
  document.getElementById("btn-tune").addEventListener("click", ()=>{
    window.open('https://www.guitartuna.com/', '_blank');
  });
  document.getElementById("btn-metronome").addEventListener("click", ()=> showPanel(metronomePanel));

  // back buttons
  document.getElementById("chords-back").addEventListener("click", goBack);
  document.getElementById("practice-back").addEventListener("click", goBack);
  document.getElementById("strum-back").addEventListener("click", goBack);
  document.getElementById("quiz-back").addEventListener("click", goBack);
  document.getElementById("metro-back").addEventListener("click", goBack);
  document.getElementById("dash-back").addEventListener("click", goBack);
  document.getElementById("admin-back").addEventListener("click", goBack);

  // ---------- Chords data & rendering ----------
  // expanded set of chords; file mapping uses lowercase and # -> sharp etc.
  const chordList = ["C","D","E","F","G","A","B","Am","Dm","Em","F#m","Bm","Cmaj7","C#m","G#m","F#","Fsharpm","c","csharp","g#","gsharpm"];
  // Function to map chord names to file names in your `image/` folder
  function chordToFilename(chordName){
    // user requested patterns like c.png, fsharp.png, fsharpm.png
    // We'll try several fallbacks.
    let name = chordName.toLowerCase();
    // replace # with sharp
    name = name.replace(/#/g,"sharp");
    // remove spaces and slashes
    name = name.replace(/\s+/g,"").replace(/\//g,"");
    // common normalization examples:
    // F#m -> fsharpm
    name = name.replace(/m$/,"m"); // keep trailing m
    return `${name}.png`;
  }

  const chordGrid = document.getElementById("chord-grid");
  function populateChordGrid(){
    chordGrid.innerHTML = "";
    const chordsToShow = chordList; // you can expand this list
    chordsToShow.forEach(ch=>{
      const card = document.createElement("div");
      card.className = "chord-card";
      const fname = chordToFilename(ch);
      card.innerHTML = `<div style="font-weight:700;color:var(--white)">${ch}</div>
        <img src="image/${fname}" alt="${ch} chord" loading="lazy" onerror="this.onerror=null;this.src='image/placeholder.png'">`;
      chordGrid.appendChild(card);
    });
  }

  // ---------- Practice ----------
  const practiceChords = ["C","D","E","F","G","A","B","Am","Dm","Em","F#m","Bm","Cmaj7","C#m","G#m"];
  let currentPracticeChord = null;
  document.getElementById("next-chord").addEventListener("click", ()=>{
    currentPracticeChord = practiceChords[Math.floor(Math.random()*practiceChords.length)];
    document.getElementById("practice-chord-display").textContent = currentPracticeChord;
    // show larger image if available
    const imgName = chordToFilename(currentPracticeChord);
    document.getElementById("practice-feedback").innerHTML = `<img src="image/${imgName}" style="width:200px" onerror="this.onerror=null;this.style.display='none'">`;
  });

  document.getElementById("play-chord").addEventListener("click", ()=>{
    // placeholder: simple beep for now. Real chord audio requires audio files.
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = "sine";
    o.frequency.value = 220;
    o.connect(g);
    g.connect(ctx.destination);
    o.start();
    g.gain.setValueAtTime(0.001, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.1, ctx.currentTime + 0.01);
    g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.6);
    o.stop(ctx.currentTime + 0.7);
  });

  // ---------- Song list & Strum ----------
  // songs collection in Firestore named 'songs' - fallback to local array if Firestore fails
  let songsCache = [
    {name:"Wonderwall - Oasis", author:"Oasis", chords:"Em7 G Dsus4 A7sus4", pattern:"‚Üì ‚Üì ‚Üë ‚Üë ‚Üì ‚Üë", capo:"2"},
    {name:"Knockin' on Heaven's Door - Bob Dylan", author:"Bob Dylan", chords:"G D Am C", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üì ‚Üë"},
    {name:"Let It Be - The Beatles", author:"The Beatles", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üì ‚Üë"},
    {name:"Beautiful in White - Westlife", author:"Westlife", chords:"G D Em C", pattern:"‚Üì ‚Üì ‚Üë ‚Üë ‚Üì ‚Üë"}
  ];

  const songListEl = document.getElementById("song-list");
  const songSearch = document.getElementById("song-search");
  async function fetchSongsFromDB(){
    try{
      const snaps = await getDocs(collection(db,"songs"));
      const arr = [];
      snaps.forEach(s=>{
        const d = s.data();
        arr.push({id:s.id, ...d});
      });
      if(arr.length) songsCache = arr;
    }catch(e){
      console.warn("Could not fetch songs from Firestore:", e);
    }
  }

  async function renderSongs(filter=""){
    songListEl.innerHTML = "";
    const q = (filter || "").trim().toLowerCase();
    songsCache.forEach(s=>{
      if(q && !s.name.toLowerCase().includes(q) && !s.author.toLowerCase().includes(q)) return;
      const div = document.createElement("div");
      div.className = "song";
      div.innerHTML = `<div class="title">${s.name}</div>
        <div class="meta">Chords: ${s.chords} ${s.capo?`(Capo ${s.capo})`:''}<br>Strumming: ${s.pattern}</div>
        <div style="margin-top:8px"><button class="ghost select-song" data-name="${s.name}">Select</button> <button class="ghost preview-song" data-name="${s.name}">Preview</button></div>`;
      songListEl.appendChild(div);
    });
    // attach select handlers
    document.querySelectorAll('.select-song').forEach(btn=>{
      btn.addEventListener('click',(e)=>{
        const name = e.currentTarget.dataset.name;
        selectSong(name);
      });
    });
    document.querySelectorAll('.preview-song').forEach(btn=>{
      btn.addEventListener('click',(e)=>{
        const name = e.currentTarget.dataset.name;
        previewSong(name);
      });
    });
  }

  songSearch && songSearch.addEventListener("input", ()=> renderSongs(songSearch.value));

  function selectSong(name){
    const song = songsCache.find(s=>s.name===name);
    if(!song) return;
    document.getElementById("song-pattern").textContent = `Pattern: ${song.pattern} ‚Äî Chords: ${song.chords}${song.capo?` (Capo ${song.capo})`:''}`;
    document.getElementById("strum-feedback").textContent = "";
    // set current pattern for strum practice
    currentPattern = (song.pattern || "‚Üì").split(/\s+/).filter(Boolean);
    currentStrumIndex = 0;
    highlightStrum();
  }

  function previewSong(name){
    alert("Preview (placeholder) for: " + name);
  }

  // on initial load try to fetch songs
  fetchSongsFromDB().then(()=> renderSongs());

  // ---------- Strum detection ----------
  // pattern variables (default)
  let audioContext, analyser, dataArray, sourceStream;
  let currentPattern = ["‚Üì","‚Üì","‚Üë","‚Üì"];
  let currentStrumIndex = 0;
  let hits = 0;
  let totalStrums = 0;
  let strumActive = false;
  const strumFeedback = document.getElementById("strum-feedback");
  const startMicBtn = document.getElementById("start-mic");
  const startStrumPracticeBtn = document.getElementById("start-strum-practice");
  const stopMicBtn = document.getElementById("stop-mic");

  function highlightStrum(){
    const highlight = document.getElementById("strum-highlight");
    // join pattern and highlight current index
    highlight.innerHTML = currentPattern.map((s,i)=>{
      if(i===currentStrumIndex) return `<span style="padding:4px 8px;border-radius:6px;background:#333;color:var(--white);font-weight:800">${s}</span>`;
      return `<span style="padding:4px 8px">${s}</span>`;
    }).join(" ");
  }

  async function startMic(){
    if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
      strumFeedback.textContent = "Mic not supported.";
      return;
    }
    try{
      if(!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const stream = await navigator.mediaDevices.getUserMedia({audio:true});
      sourceStream = stream;
      source = audioContext.createMediaStreamSource(stream);
      analyser = audioContext.createAnalyser();
      analyser.fftSize = 2048;
      source.connect(analyser);
      dataArray = new Uint8Array(analyser.fftSize);
      strumFeedback.textContent = "Mic ready.";
    }catch(e){
      strumFeedback.textContent = "Mic access denied.";
      console.error(e);
    }
  }
    function stopMic(){
    if(sourceStream){
      sourceStream.getTracks().forEach(t=>t.stop());
      sourceStream = null;
      strumActive = false;
      strumFeedback.textContent = "Mic stopped.";
    }
  }

  function detectStrumOnce(){
    if(!analyser) return null;
    analyser.getByteTimeDomainData(dataArray);
    // compute simple RMS / amplitude metric
    let sum = 0;
    for(let i=0;i<dataArray.length;i++){
      let v = dataArray[i]-128;
      sum += v*v;
    }
    const rms = Math.sqrt(sum / dataArray.length);
    return rms;
  }

  // Heuristic: determine strum direction by short-time high-frequency presence vs low-frequency amplitude change
  function determineStrumDirection(){
    // Very basic: if rms high -> treat as down; if moderate & higher centroid -> treat as up
    // For now use simple threshold: >9 => down; between 4-9 => up (tunable)
    const rms = detectStrumOnce();
    if(rms === null) return null;
    if(rms > 12) return "‚Üì";
    if(rms > 6) return "‚Üë";
    return null;
  }

  function checkStrumLoop(){
    if(!strumActive) return;
    const dir = determineStrumDirection();
    if(dir){
      totalStrums++;
      // compare to expected
      const expect = currentPattern[currentStrumIndex] || currentPattern[currentPattern.length-1];
      if(dir === expect){
        hits++;
        // show green for step
        const el = document.createElement("span");
        el.textContent = ` ${dir} `;
        el.style.color = "var(--white)";
        strumFeedback.textContent = "Correct: " + dir;
        currentStrumIndex++;
        highlightStrum();
      } else {
        strumFeedback.textContent = "Wrong strum: " + dir + " (expected " + expect + ")";
      }
      const acc = totalStrums>0 ? Math.round((hits/totalStrums)*100) : 0;
      document.getElementById("dash-strum").textContent = acc + "%";
      // when pattern completed
      if(currentStrumIndex >= currentPattern.length){
        strumFeedback.textContent = "Pattern completed!";
        strumActive = false;
        return;
      }
    }
    requestAnimationFrame(checkStrumLoop);
  }

  startStrumPracticeBtn.addEventListener("click", ()=>{
    if(!analyser){
      strumFeedback.textContent = "Start mic first.";
      return;
    }
    currentStrumIndex = 0;
    hits = 0;
    totalStrums = 0;
    strumActive = true;
    highlightStrum();
    strumFeedback.textContent = "Start strumming the pattern...";
    requestAnimationFrame(checkStrumLoop);
  });

  startMicBtn.addEventListener("click", async ()=>{
    await startMic();
  });
  stopMicBtn.addEventListener("click", ()=> stopMic());

  // ---------- Quiz ----------
  const quizChords = ["C","D","E","F","G","A","B","Am","Dm","Em","F#m","Bm","Cmaj7","C#m","G#m"];
  let quizScore = 0;
  let quizCount = 0;
  const quizTotal = 10;
  const quizArea = document.getElementById("quiz-area");
  const quizResult = document.getElementById("quiz-result");
  const quizImage = document.getElementById("quiz-image");
  const quizOptions = document.getElementById("quiz-options");
  const timerEl = document.getElementById("timer");
  let quizTimer;
  let currentQuizChord;

  function shuffleArray(array){
    const arr = array.slice();
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]] = [arr[j],arr[i]];
    }
    return arr;
  }

  function nextQuizChord(){
    if(quizCount >= quizTotal){
      quizArea.classList.add("hidden");
      quizResult.classList.remove("hidden");
      quizResult.textContent = `Quiz Completed! Score: ${quizScore}/${quizTotal}`;
      // update leaderboard with score history...
      saveQuizResult(quizScore);
      return;
    }
    currentQuizChord = quizChords[Math.floor(Math.random()*quizChords.length)];
    // Try to show image if exists, otherwise show text
    const img = document.createElement("img");
    img.alt = currentQuizChord;
    img.src = `image/${chordToFilename(currentQuizChord)}`;
    img.style.maxWidth = "220px";
    img.onerror = function(){ img.remove(); quizImage.textContent = currentQuizChord; };
    quizImage.innerHTML = "";
    quizImage.appendChild(img);
    quizOptions.innerHTML = "";
    const choices = shuffleArray(quizChords).slice(0,3);
    if(!choices.includes(currentQuizChord)) choices[Math.floor(Math.random()*3)] = currentQuizChord;
    // include correct answer and possibly one duplicate to make 4
    const fullChoices = shuffleArray([...choices, quizChords[Math.floor(Math.random()*quizChords.length)] ]).slice(0,4);
    fullChoices.forEach(o=>{
      const btn = document.createElement("button");
      btn.textContent = o;
      btn.addEventListener("click", ()=>{
        if(o===currentQuizChord) quizScore++;
        quizCount++;
        clearInterval(quizTimer);
        nextQuizChord();
      });
      quizOptions.appendChild(btn);
    });
    startQuizTimer();
  }

  function startQuizTimer(){
    let time = 8;
    timerEl.textContent = time;
    clearInterval(quizTimer);
    quizTimer = setInterval(()=>{
      time--;
      timerEl.textContent = time;
      if(time<=0){
        clearInterval(quizTimer);
        quizCount++;
        nextQuizChord();
      }
    },1000);
  }

  document.getElementById("start-quiz").addEventListener("click", ()=>{
    quizScore = 0;
    quizCount = 0;
    quizResult.classList.add("hidden");
    quizArea.classList.remove("hidden");
    nextQuizChord();
  });
  document.getElementById("reset-quiz").addEventListener("click", ()=>{
    quizScore = 0; quizCount = 0;
    quizArea.classList.add("hidden");
    quizResult.classList.add("hidden");
  });

  // ---------- Metronome Implementation ----------
  let metroInterval = null;
  const metroBall = document.getElementById("metro-ball");
  const metroTrack = document.getElementById("metro-track");
  const metroBpmInput = document.getElementById("metro-bpm");
  const metroBeatsInput = document.getElementById("metro-beats");

  function startMetronome(){
    const bpm = parseInt(metroBpmInput.value) || 90;
    const beats = parseInt(metroBeatsInput.value) || 4;
    const beatMs = (60 / bpm) * 1000;
    // remove any existing animation/frame
    stopMetronome();
    // animate ball across track based on beat position
    let beatIndex = 0;
    const trackWidth = metroTrack.clientWidth - 20; // ball width offset
    function tick(){
      // compute position based on beatIndex within beats
      const pos = (beatIndex % beats) / (beats - 1 || 1); // 0..1
      const x = Math.round(pos * trackWidth);
      metroBall.style.transform = `translateX(${x}px)`;
      // tiny audio tick
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = 'square';
      o.frequency.value = 1000;
      o.connect(g); g.connect(ctx.destination);
      g.gain.setValueAtTime(0.0001, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.001);
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.05);
      o.start(); o.stop(ctx.currentTime + 0.06);
      beatIndex++;
    }
    tick(); // initial
    metroInterval = setInterval(tick, beatMs);
  }

  function stopMetronome(){
    if(metroInterval) clearInterval(metroInterval);
    metroInterval = null;
    metroBall.style.transform = `translateX(0px)`;
  }

  document.getElementById("start-metro").addEventListener("click", startMetronome);
  document.getElementById("stop-metro").addEventListener("click", stopMetronome);

  // ---------- Leaderboard (Firestore) ----------
  async function renderLeaderboard(){
    const wrap = document.getElementById("leaderboard");
    wrap.innerHTML = "<p style='color:#aaa'>Loading...</p>";
    try{
      const q = query(collection(db,"leaderboard"), orderBy("highScore","desc"));
      const snaps = await getDocs(q);
      wrap.innerHTML = "<table class='table'><thead><tr><th>#</th><th>Name</th><th>Score</th><th>Streak</th></tr></thead><tbody></tbody></table>";
      const tbody = wrap.querySelector("tbody");
      let rank = 1;
      snaps.forEach(s=>{
        const d = s.data();
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>#${rank++}</td><td>${d.displayName || d.email || 'Guest'}</td><td>${d.highScore||0}</td><td>${d.streak||0}</td>`;
        tbody.appendChild(tr);
      });
    }catch(e){
      // fallback: local caching of some users
      wrap.innerHTML = "<p style='color:#f88'>Could not load leaderboard (offline). Showing cached.</p>";
    }
  }
  renderLeaderboard();

  // ---------- Save Quiz Result to leaderboard (sample) ----------
  async function saveQuizResult(score){
    if(!auth.currentUser) return;
    try{
      // find doc for this user
      const snaps = await getDocs(collection(db,"leaderboard"));
      let docId = null; let best = 0;
      snaps.forEach(s=>{
        const d = s.data();
        if(d.email === auth.currentUser.email || d.displayName === auth.currentUser.email) {
          docId = s.id; best = d.highScore || 0;
        }
      });
      if(docId){
        const upd = {};
        if(score > best) upd.highScore = score;
        upd.lastPlayed = Date.now();
        await updateDoc(doc(db,"leaderboard",docId), upd);
      } else {
        await addDoc(collection(db,"leaderboard"), { displayName: auth.currentUser.email.split("@")[0], email: auth.currentUser.email, highScore: score, lastPlayed: Date.now(), streak:0 });
      }
      renderLeaderboard();
    }catch(e){
      console.warn("Could not save quiz result:", e);
    }
  }

  // ---------- ADMIN: song add/edit/delete ----------
  async function renderAdminSongs(){
    const list = document.getElementById("admin-song-list");
    list.innerHTML = "<p style='color:#aaa'>Loading...</p>";
    try{
      const snaps = await getDocs(collection(db,"songs"));
      list.innerHTML = "";
      snaps.forEach(s=>{
        const d = s.data();
        const row = document.createElement("div");
        row.style.borderBottom = "1px solid #222";
        row.style.padding = "8px 0";
        row.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong style="color:var(--white)">${d.name}</strong><div class="small-muted">${d.author || ''} ${d.capo?'(Capo '+d.capo+')':''}</div></div>
          <div style="display:flex;gap:8px">
            <button class="ghost admin-edit" data-id="${s.id}">Edit</button>
            <button class="ghost admin-delete" data-id="${s.id}">Delete</button>
          </div>
        </div>`;
        list.appendChild(row);
      });
      document.querySelectorAll('.admin-edit').forEach(btn=>{
        btn.addEventListener('click', async (e)=>{
          const id = e.currentTarget.dataset.id;
          const snap = await getDocs(collection(db,"songs"));
          let data = null;
          snap.forEach(s=>{
            if(s.id === id) data = {id:s.id, ...s.data()};
          });
          if(data){
            // open a prompt-style editor (simple)
            const newName = prompt("Song name:", data.name) || data.name;
            const newAuthor = prompt("Author:", data.author || '') || data.author;
            const newCapo = prompt("Capo (empty for none):", data.capo || '') || data.capo;
            const newChords = prompt("Chords:", data.chords || '') || data.chords;
            const newPattern = prompt("Pattern:", data.pattern || '') || data.pattern;
            await updateDoc(doc(db,"songs",id), { name:newName, author:newAuthor, capo:newCapo, chords:newChords, pattern:newPattern });
            alert("Song updated.");
            fetchSongsFromDB().then(()=> renderSongs()).then(()=> renderAdminSongs());
          }
        });
      });
      document.querySelectorAll('.admin-delete').forEach(btn=>{
        btn.addEventListener('click', async (e)=>{
          const id = e.currentTarget.dataset.id;
          if(confirm("Delete this song permanently?")) {
            await deleteDoc(doc(db,"songs",id));
            fetchSongsFromDB().then(()=> renderSongs()).then(()=> renderAdminSongs());
          }
        });
      });
    }catch(e){
      list.innerHTML = "<p style='color:#f88'>Could not load admin song list.</p>";
    }
  }

  document.getElementById("admin-add-song").addEventListener("click", async ()=>{
    const raw = document.getElementById("admin-new-song").value.trim();
    if(!raw) { alert("Enter song data in format: name|author|capo|chords|pattern"); return; }
    const parts = raw.split("|").map(s=>s.trim());
    const [name, author, capo, chords, pattern] = parts;
    try{
      await addDoc(collection(db,"songs"), { name:name||'Untitled', author:author||'', capo:capo||'', chords:chords||'', pattern:pattern||'' });
      document.getElementById("admin-new-song").value = "";
      fetchSongsFromDB().then(()=> renderSongs()).then(()=> renderAdminSongs());
      alert("Song added.");
    }catch(e){
      alert("Add failed: "+e.message);
    }
  });

  document.getElementById("admin-bulk-add").addEventListener("click", async ()=>{
    const t = document.getElementById("admin-bulk").value.trim();
    if(!t) { alert("Paste bulk JSON array into the textarea."); return; }
    try{
      const arr = JSON.parse(t);
      if(!Array.isArray(arr)) throw new Error("Expected JSON array");
      for(const s of arr){
        await addDoc(collection(db,"songs"), s);
      }
      document.getElementById("admin-bulk").value = "";
      fetchSongsFromDB().then(()=> renderSongs()).then(()=> renderAdminSongs());
      alert("Bulk add finished.");
    }catch(e){
      alert("Bulk add error: " + e.message);
    }
  });

  document.getElementById("admin-clear-songs").addEventListener("click", async ()=>{
    if(!confirm("Delete ALL songs from Firestore songs collection? This cannot be undone.")) return;
    try{
      const snaps = await getDocs(collection(db,"songs"));
      for(const s of snaps.docs){ await deleteDoc(doc(db,"songs",s.id)); }
      fetchSongsFromDB().then(()=> renderSongs()).then(()=> renderAdminSongs());
      alert("Cleared songs.");
    }catch(e){
      alert("Clear failed: "+e.message);
    }
  });

  document.getElementById("apply-override").addEventListener("click", async ()=>{
    const email = document.getElementById("override-user").value.trim();
    const username = document.getElementById("override-username").value.trim();
    const streak = parseInt(document.getElementById("override-streak").value)||0;
    const level = document.getElementById("override-level").value || "Beginner";
    const highScore = parseInt(document.getElementById("override-highscore").value)||0;
    if(!email){ alert("Provide an email"); return; }
    try{
      const snaps = await getDocs(collection(db,"leaderboard"));
      let userDoc = null;
      snaps.forEach(s=>{
        const d = s.data();
        if(d.email === email || d.displayName === email || d.displayName === username){
          userDoc = s.id;
        }
      });
      if(userDoc){
        await updateDoc(doc(db,"leaderboard",userDoc), {
          displayName: username || email,
          streak: streak,
          level: level,
          highScore: highScore,
          lastPlayed: Date.now()
        });
        alert("User updated successfully!");
      } else {
        await setDoc(doc(db,"leaderboard",email),{
          displayName: username || email,
          email: email,
          streak: streak,
          level: level,
          highScore: highScore,
          lastPlayed: Date.now()
        });
        alert("New user created and updated!");
      }
      renderLeaderboard();
    }catch(e){
      alert("Override failed: "+e.message);
    }
  });

  document.getElementById("admin-close").addEventListener("click", ()=>{
    adminPanel.classList.add("hidden");
  });

  // ---------- Initialize admin UI on page load if admin user signed in ----------
  async function initAdminIfNeeded(){
    try{
      const u = auth.currentUser;
      if(u && u.email === adminEmail){
        adminPanel.classList.remove("hidden");
        renderAdminSongs();
      } else {
        adminPanel.classList.add("hidden");
      }
    }catch(e){}
  }
  initAdminIfNeeded();

  // ---------- Utility: populate initial DB seed if empty (optional) ----------
  // (LEFT DISABLED ‚Äî you can enable to seed)
  async function optionalSeed(){
    // Example: if songs collection is empty, upload songsCache
    try{
      const snaps = await getDocs(collection(db,"songs"));
      if(snaps.size === 0){
        for(const s of songsCache){
          await addDoc(collection(db,"songs"), s);
        }
      }
    }catch(e){}
  }
  // optionalSeed(); // uncomment to seed automatically

  // ---------- Startup: ensure UI initial state ----------
  loginScreen.classList.remove("hidden");
  mainMenu.classList.add("hidden");
  chordsPanel.classList.add("hidden");
  practicePanel.classList.add("hidden");
  strumPanel.classList.add("hidden");
  quizPanel.classList.add("hidden");
  dashboardPanel.classList.add("hidden");
  adminPanel.classList.add("hidden");
  metronomePanel.classList.add("hidden");

  // ensure buttons in main menu always white text
  document.querySelectorAll('#main-menu button').forEach(b=>b.classList.add('force-white'));

  // ---------- Small UX polishing ----------
  document.getElementById("toggle-pass").addEventListener("click", ()=>{
    passwordInput.type = passwordInput.type === "password" ? "text":"password";
  });

  document.getElementById("continue-btn").addEventListener("click", ()=>{
    loginScreen.classList.add("hidden");
    mainMenu.classList.remove("hidden");
    accountEmail.textContent = "Guest";
    accountUsername.textContent = "Guest";
  });

  // show dashboard handler (from account panel)
  document.getElementById("show-dashboard").addEventListener("click", ()=>{
    showPanel(dashboardPanel);
    renderLeaderboard();
    accountPanel.style.display = 'none';
  });

  // When admin logs out, hide the admin panel
  onAuthStateChanged(auth,(u)=>{
    if(!u){
      adminPanel.classList.add("hidden");
    }
  });

  // If adminPanel should have an admin-only button visible only for admin in menu:
  function updateAdminVisibility(){
    const u = auth.currentUser;
    if(u && u.email === adminEmail){
      document.querySelectorAll('.admin-only').forEach(el=>el.style.display='inline-block');
    } else {
      document.querySelectorAll('.admin-only').forEach(el=>el.style.display='none');
    }
  }
  // run once
  updateAdminVisibility();

  // ---------- Render initial chord grid (not yet shown) ----------
  // populateChordGrid(); // when chords panel is opened we populate to avoid heavy startup

</script>
</body>
</html>

