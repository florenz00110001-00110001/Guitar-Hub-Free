<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Guitar Hub Trainer - Ultimate Edition</title>
<style>
  :root{
    --bg:#111;
    --panel:#000;
    --accent:orange;
    --muted:#222;
    --text:#fff;
    --card:#1a1a1a;
    --white:#fff;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:Arial, sans-serif;
    background:var(--bg);
    color:var(--text);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    text-align:center;
    transition:background 0.25s,color 0.25s;
  }
  header{
    width:100%;
    background:var(--panel);
    padding:10px 18px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    position:fixed;
    top:0; left:0;
    z-index:1000;
    box-shadow:0 2px 8px rgba(0,0,0,0.6);
  }
  .logo{display:flex;align-items:center;font-weight:700;font-size:1.25rem;color:var(--white)}
  .logo .guitar{color:var(--white)}
  .logo .hub{color:black;background:orange;padding:4px 8px;border-radius:6px;margin-left:8px}
  .controls{display:flex;gap:8px;align-items:center}
  main{padding:92px 14px 40px; max-width:980px;margin:0 auto;}
  button{padding:10px 16px;border-radius:8px;border:none;background:var(--accent);color:#000;font-weight:600;cursor:pointer;transition:all 0.2s}
  button:hover{opacity:0.9}
  .back-btn{background:#444;color:#fff}
  .ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:8px}
  .card{background:var(--muted);padding:14px;border-radius:10px;margin:12px 0;box-shadow:0 6px 16px rgba(0,0,0,0.6);transition:all 0.3s ease}
  .hidden{display:none;opacity:0;transition:opacity 0.3s ease}
  .visible{display:block;opacity:1;transition:opacity 0.3s ease}
  .chord-grid{display:flex;flex-wrap:wrap;gap:14px;justify-content:center;padding:8px}
  .chord-card{width:120px;background:#222;padding:10px;border-radius:10px;box-shadow:0 6px 14px rgba(0,0,0,0.6);text-align:center;transition:transform 0.2s}
  .chord-card:hover{transform:scale(1.05)}
  .chord-card img{width:100px;height:auto;display:block;margin:8px auto}
  .timer{font-weight:700;color:gold;font-size:1.2rem;margin:8px}
  #quiz-options button{display:block;width:100%;margin:8px 0;background:#333;color:#fff;padding:10px;border-radius:8px}
  input[type="text"],input[type="email"],input[type="password"],textarea,select{
    width:100%;padding:10px;border-radius:8px;border:none;background:#1b1b1b;color:#fff;margin-bottom:10px;font-size:1rem;
  }
  .row{display:flex;gap:8px;align-items:center}
  .row .small{width:48px;padding:8px}
  .song{padding:10px;border-radius:8px;background:#171717;margin:8px 0;text-align:left;color:var(--white)}
  .song .title{font-weight:700}
  .song .meta{font-size:0.9rem;color:#ddd;margin-top:6px}
  #burger{font-size:1.4rem;background:none;border:none;color:#fff;cursor:pointer;padding:6px 8px}
  #account-panel{position:fixed;top:58px;right:12px;width:320px;background:#141414;padding:12px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,0.6);display:none;z-index:1100;color:var(--white)}
  #account-panel h4{margin:0 0 8px 0}
  #strum-highlight{font-size:1.5rem;margin:12px 0;letter-spacing:6px;color:var(--white)}
  .metronome-ball{width:18px;height:18px;border-radius:50%;background:orange;margin:0 auto;transform-origin:center;display:block}
  .metronome-track{height:6px;width:220px;background:#222;border-radius:6px;margin:8px auto;display:flex;align-items:center;justify-content:flex-start;padding:0 6px}
  .metronome-spot{width:12px;height:12px;border-radius:50%;background:#555}
  .badge{display:inline-block;padding:4px 8px;border-radius:6px;background:#333;color:#fff;margin-left:6px;font-size:0.9rem}
  .admin-only{display:none}
  @media (max-width:600px){
    .logo{font-size:1.05rem}
    main{padding:96px 12px}
    .chord-card{width:96px}
  }
  /* Keep some text forced white where asked */
  .force-white, .song, #song-pattern, #start-mic, #start-strum-practice, #stop-mic, #practice-feedback, #practice-chord-display { color: var(--white) !important; }
  .light-mode{background:#fff;color:#000}
  .light-mode .logo .hub{background:orange;color:black}
  .light-mode button{color:#000}
</style>
</head>
<body>

<header>
  <div class="logo">
    <span class="guitar">Guitar</span><span class="hub">Hub</span>
  </div>
  <div class="controls">
    <button id="dark-toggle" title="Toggle theme">üåó</button>
    <button id="burger" aria-label="Open account menu">‚ò∞</button>
  </div>
</header>

<div id="account-panel" aria-hidden="true">
  <h4>Account <span id="user-badge" class="badge" style="display:none">Admin</span></h4>
  <p id="account-email">Not signed in</p>
  <p id="account-username" class="force-white"></p>
  <div style="display:flex;gap:8px;margin-top:8px;">
    <button id="show-dashboard" class="ghost">Dashboard</button>
    <button id="signout-btn" class="ghost">Sign out</button>
  </div>
  <hr style="margin:10px 0;border-color:#222">
  <button id="change-pass" class="ghost" style="width:100%;margin-bottom:8px">Change password</button>
  <button id="delete-account" class="ghost" style="width:100%;color:#ff6666">Delete account</button>
</div>

<main>
  <!-- Login -->
  <div id="login-screen" class="card">
    <h1 style="margin:0 0 8px 0;color:var(--white)">Login</h1>
    <input id="email" type="email" placeholder="Email" autocomplete="username">
    <div class="row" style="align-items:center">
      <input id="password" type="password" placeholder="Password" autocomplete="current-password" style="flex:1">
      <button id="toggle-pass" class="ghost small" title="Show/Hide">üëÅÔ∏è</button>
    </div>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:8px">
      <button id="login-btn">Login</button>
      <button id="signup-btn" class="ghost">Sign up</button>
    </div>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:10px">
      <button id="continue-btn" class="ghost">Continue without account</button>
    </div>
    <p style="margin:12px 0 0 0"><a href="#" id="forgot-link" style="color:#ddd">Forgot password?</a></p>
    <p id="auth-msg" style="color:#f88;margin-top:8px"></p>
  </div>

  <!-- Main Menu -->
  <div id="main-menu" class="card hidden">
    <h2 style="margin-top:0;color:var(--white)">Main Menu</h2>
    <div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center">
      <button id="btn-chords">View Chords</button>
      <button id="btn-practice">Practice Chords</button>
      <button id="btn-strum">Practice Strum</button>
      <button id="btn-quiz">Chord Recognition Quiz</button>
      <button id="btn-learn-songs" class="ghost">Learn Songs</button>
      <button id="btn-tune" class="ghost">Tune with GuitarTuna</button>
      <button id="btn-metronome" class="ghost">Metronome</button>
    </div>
  </div>

  <!-- Chords -->
  <div id="chords" class="card hidden">
    <h2 style="margin-top:0;color:var(--white)">Basic Chords</h2>
    <div class="chord-grid" id="chord-grid"></div>
    <button class="back-btn" id="back-chords">‚¨Ö Back</button>
  </div>

  <!-- Practice -->
  <div id="practice" class="card hidden">
    <h2 style="margin-top:0;color:var(--white)">Practice Chords (Random)</h2>
    <div id="practice-chord-display" class="force-white" style="font-size:2rem;margin:16px"></div>
    <div style="display:flex;gap:8px;justify-content:center">
      <button id="next-chord">Next Chord</button>
      <button id="play-chord" class="ghost">Play Chord</button>
    </div>
    <p id="practice-feedback" class="force-white" style="margin-top:10px"></p>
    <button class="back-btn" id="back-practice">‚¨Ö Back</button>
  </div>

  <!-- Strum Practice -->
  <div id="strum" class="card hidden">
    <h2 style="margin-top:0;color:var(--white)">Practice Strum</h2>
    <input id="song-search" type="text" placeholder="Search songs..." style="margin-bottom:12px;color:var(--white);background:#222"/>
    <div id="song-list" style="max-height:360px;overflow:auto;padding-right:6px"></div>
    <div style="margin-top:12px">
      <p id="song-pattern" style="font-weight:700;color:var(--white)">Pattern: ‚Äî</p>
      <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:8px">
        <button id="start-mic" class="ghost">Start Mic Test</button>
        <button id="start-strum-practice" class="ghost">Start Strum Practice</button>
        <button id="stop-mic" class="ghost">Stop Mic</button>
      </div>
      <p id="strum-feedback" style="margin-top:8px;color:var(--white)"></p>
      <div id="strum-highlight" class="force-white"></div>
    </div>
    <button class="back-btn" id="back-strum">‚¨Ö Back</button>
  </div>

  <!-- Quiz -->
  <div id="quiz" class="card hidden">
    <h2 style="margin-top:0;color:var(--white)">Chord Recognition Quiz</h2>
    <div style="margin-bottom:12px">
      <button id="start-quiz">Start Quiz</button>
      <button id="reset-quiz" class="ghost" style="display:none">Reset</button>
    </div>
    <div id="quiz-area" class="hidden" style="text-align:center">
      <div class="timer" id="timer">5</div>
      <div id="quiz-image" style="margin:8px"></div>
      <div id="quiz-options" style="max-width:420px;margin:0 auto;text-align:center"></div>
      <p id="quiz-progress" style="margin-top:8px"></p>
    </div>
    <div id="quiz-result" class="hidden" style="margin-top:12px;font-weight:700"></div>
    <button class="back-btn" id="back-quiz">‚¨Ö Back</button>
  </div>

  <!-- Metronome -->
  <div id="metronome" class="card hidden">
    <h2 style="margin-top:0;color:var(--white)">Metronome</h2>
    <div style="display:flex;gap:8px;justify-content:center;align-items:center">
      <button id="start-met" class="ghost">Start</button>
      <button id="stop-met" class="ghost">Stop</button>
      <label style="display:flex;align-items:center;gap:6px;margin-left:10px;color:var(--white)">BPM
        <input id="met-bpm" type="number" value="80" min="30" max="240" style="width:80px;margin-left:6px">
      </label>
    </div>
    <div class="metronome-track" id="met-track">
      <div class="metronome-ball" id="met-ball"></div>
    </div>
    <button class="back-btn" id="back-met">‚¨Ö Back</button>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="card hidden">
    <h2 style="margin-top:0;color:var(--white)">Dashboard</h2>
    <p class="force-white">Username: <span id="dash-username">-</span></p>
    <p class="force-white">Email: <span id="dash-email">-</span></p>
    <p>Strum Accuracy: <span id="dash-strum">0%</span></p>
    <p>Quiz Score History: <span id="dash-quiz">N/A</span></p>
    <button class="back-btn" id="back-dashboard">‚¨Ö Back</button>
  </div>

  <!-- Admin Panel -->
  <div id="admin-panel" class="card hidden">
    <h2>Admin Controls</h2>

    <h3>Add / Edit Song</h3>
    <div style="display:grid;gap:6px">
      <input id="admin-song-name" placeholder="Song Name">
      <input id="admin-song-author" placeholder="Author">
      <input id="admin-song-capo" placeholder="Capo (e.g. 4) or leave blank">
      <input id="admin-song-chords" placeholder="Chords (space separated)">
      <input id="admin-song-pattern" placeholder="Pattern (e.g. ‚Üì ‚Üì ‚Üë ‚Üë ‚Üì ‚Üë)">
      <div style="display:flex;gap:8px">
        <button id="admin-save-song">Save Song</button>
        <button id="admin-clear-song" class="ghost">Clear</button>
      </div>
    </div>

    <h3>Bulk Add Songs (paste lines like: Name|Author|Capo|Chords|Pattern)</h3>
    <textarea id="admin-bulk" placeholder="One song per line. Example:\nBeautiful in White - Westlife|Westlife||G D Em C|‚Üì ‚Üì ‚Üë ‚Üë ‚Üì ‚Üë" rows="6"></textarea>
    <div style="display:flex;gap:8px">
      <button id="admin-bulk-add">Bulk Add</button>
    </div>

    <h3>Manual User Override</h3>
    <input id="override-user" type="text" placeholder="Enter user email (or username)">
    <input id="override-streak" type="number" placeholder="Set streak">
    <input id="override-level" type="text" placeholder="Set level">
    <input id="override-highscore" type="number" placeholder="Set high score">
    <div style="display:flex;gap:8px">
      <button id="apply-override">Apply Changes</button>
    </div>

    <h3>Admin Song List</h3>
    <div id="admin-song-list" style="max-height:240px;overflow:auto"></div>

    <button class="back-btn" id="back-admin">‚¨Ö Back</button>
  </div>
</main>

<!-- Firebase & App Logic -->
<script type="module">
  // CDN Firebase imports (v12)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail, onAuthStateChanged, updatePassword, deleteUser } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, setDoc, doc, getDocs, getDoc, updateDoc, deleteDoc, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDkMmF78dFu2dmuzka6xuwpLRD5NRCCJtY",
    authDomain: "guitar-hub-25dfa.firebaseapp.com",
    projectId: "guitar-hub-25dfa",
    storageBucket: "guitar-hub-25dfa.appspot.com",
    messagingSenderId: "36479296604",
    appId: "1:36479296604:web:5dbcfb2aec3912f8ba7299",
    measurementId: "G-N4HZW695LF"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Hardcoded admin email (change as needed)
  const ADMIN_EMAIL = "florenzjed12@gmail.com"; // <-- your admin email

  // Panels
  const loginScreen = document.getElementById("login-screen");
  const mainMenu = document.getElementById("main-menu");
  const chordsPanel = document.getElementById("chords");
  const practicePanel = document.getElementById("practice");
  const strumPanel = document.getElementById("strum");
  const quizPanel = document.getElementById("quiz");
  const dashboardPanel = document.getElementById("dashboard");
  const metronomePanel = document.getElementById("metronome");
  const adminPanel = document.getElementById("admin-panel");
  const accountPanel = document.getElementById("account-panel");

  // Elements
  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");
  const authMsg = document.getElementById("auth-msg");
  const burgerBtn = document.getElementById("burger");
  const accountEmail = document.getElementById("account-email");
  const accountUsernameEl = document.getElementById("account-username");
  const userBadgeEl = document.getElementById("user-badge");

  // keep specific text white always even in light mode by adding .force-white
  function showPanel(panel){
    // hide all
    [loginScreen, mainMenu, chordsPanel, practicePanel, strumPanel, quizPanel, dashboardPanel, metronomePanel, adminPanel].forEach(p=>{
      if(p) { p.classList.add('hidden'); p.classList.remove('visible'); }
    });
    if(panel){
      panel.classList.remove('hidden');
      panel.classList.add('visible');
    }
    // close account panel when navigating
    accountPanel.style.display = 'none';
  }

  // Dark mode / light mode persist
  const darkToggle = document.getElementById('dark-toggle');
  function applyTheme(){
    const mode = localStorage.getItem('gh_mode') || 'dark';
    if(mode === 'light') document.body.classList.add('light-mode');
    else document.body.classList.remove('light-mode');
  }
  darkToggle.addEventListener('click', ()=> {
    document.body.classList.toggle('light-mode');
    const isLight = document.body.classList.contains('light-mode');
    localStorage.setItem('gh_mode', isLight ? 'light' : 'dark');
    // Keep force-white elements white in all modes (we used .force-white)
  });
  applyTheme();

  // burger toggle
  burgerBtn.addEventListener("click", ()=>{
    accountPanel.style.display = accountPanel.style.display === "block" ? "none" : "block";
  });

  document.getElementById("toggle-pass").addEventListener("click", ()=>{
    passwordInput.type = passwordInput.type === "password" ? "text" : "password";
  });

  // Auth - sign up
  document.getElementById("signup-btn").addEventListener("click", async ()=>{
    const email = emailInput.value.trim();
    const pw = passwordInput.value;
    if(!email || !pw){ authMsg.textContent = "Provide email & password to sign up."; return; }
    try{
      await createUserWithEmailAndPassword(auth, email, pw);
      authMsg.style.color = "#8f8"; authMsg.textContent = "Account created, signed in.";
      // create leaderboard doc for user
      await createOrUpdateLeaderboardForUser(email, { displayName: email, highScore:0, lastPlayed:Date.now(), level:'Beginner', streak:0 });
    }catch(e){ authMsg.style.color="#f88"; authMsg.textContent = e.message; }
  });

  // Auth - login
  document.getElementById("login-btn").addEventListener("click", async ()=>{
    const email = emailInput.value.trim();
    const pw = passwordInput.value;
    if(!email || !pw){ authMsg.textContent = "Enter email & password to sign in."; authMsg.style.color="#f88"; return; }
    try{
      await signInWithEmailAndPassword(auth, email, pw);
      authMsg.style.color="#8f8"; authMsg.textContent = "Signed in.";
    }catch(e){ authMsg.style.color="#f88"; authMsg.textContent = e.message; }
  });

  // Continue as guest
  document.getElementById("continue-btn").addEventListener("click", ()=>{
    showPanel(mainMenu);
    accountEmail.textContent = "Guest";
    accountUsernameEl.textContent = "";
    userBadgeEl.style.display = 'none';
  });

  // Forgot password
  document.getElementById("forgot-link").addEventListener("click", async (ev)=>{
    ev.preventDefault();
    const email = emailInput.value.trim();
    if(!email){ authMsg.style.color="#f88"; authMsg.textContent = "Enter your email then click Reset."; return; }
    try{
      await sendPasswordResetEmail(auth, email);
      authMsg.style.color="#8f8"; authMsg.textContent = "Reset email sent (check inbox).";
    }catch(e){ authMsg.style.color="#f88"; authMsg.textContent = e.message; }
  });

  // Sign out
  document.getElementById("signout-btn").addEventListener("click", async ()=>{
    try{
      await signOut(auth);
      showPanel(loginScreen);
      accountPanel.style.display = 'none';
      accountEmail.textContent = 'Not signed in';
      accountUsernameEl.textContent = '';
      userBadgeEl.style.display = 'none';
    } catch(e){ console.error(e); }
  });

  // Change password
  document.getElementById("change-pass").addEventListener("click", async ()=>{
    const newPass = prompt("Enter new password (min 6 chars):");
    if(!newPass) return;
    if(!auth.currentUser){ alert("Sign in required to change password."); return; }
    try{
      await updatePassword(auth.currentUser, newPass);
      alert("Password updated.");
    }catch(e){ alert(e.message); }
  });

  // Delete account (Auth + Firestore leaderboard doc)
  document.getElementById("delete-account").addEventListener("click", async ()=>{
    if(!auth.currentUser){ alert("Not signed in."); return; }
    if(!confirm("Delete your account permanently? This removes your auth and leaderboard entry.")) return;
    try{
      const email = auth.currentUser.email;
      // delete leaderboard doc if exists
      const q = query(collection(db,'leaderboard'), where('email','==', email), limit(1));
      const snap = await getDocs(q);
      snap.forEach(s => {
        deleteDoc(doc(db, 'leaderboard', s.id)).catch(()=>{});
      });
      await deleteUser(auth.currentUser);
      alert("Account deleted.");
      showPanel(loginScreen);
    }catch(e){
      alert("Delete failed: "+e.message);
    }
  });

  // onAuth state change
  onAuthStateChanged(auth, async (user)=>{
    if(user){
      accountEmail.textContent = user.email || "User";
      accountUsernameEl.textContent = user.displayName || '';
      showPanel(mainMenu);
      authMsg.textContent = "";

        // ensure leaderboard doc exists
      await createOrUpdateLeaderboardForUser(user.email, { displayName: user.displayName || user.email, email:user.email, highScore:0, lastPlayed:Date.now(), level:'Beginner', streak:0 });

      // show admin if email matches
      if(user.email === ADMIN_EMAIL){
        userBadgeEl.textContent = 'Admin';
        userBadgeEl.style.display = 'inline-block';
        // show admin-only UI/button
        document.querySelectorAll('.admin-only').forEach(el=>el.style.display='inline-block');
        // Admin button visible in account panel
        // show admin panel button somewhere ‚Äî we keep admin panel accessible via burger -> Dashboard -> Admin
      } else {
        userBadgeEl.style.display = 'none';
        document.querySelectorAll('.admin-only').forEach(el=>el.style.display='none');
      }

      // update dashboard fields from Firestore
      await refreshDashboardFor(user.email);
      await populateAdminSongList(); // admin only ‚Äî harmless for non-admin
    } else {
      // logged out
      showPanel(loginScreen);
    }
  });

  // --- Leaderboard helper: create or update doc for user email ---
  async function createOrUpdateLeaderboardForUser(email, obj){
    try{
      // find existing by email
      const q = query(collection(db,'leaderboard'), where('email','==', email), limit(1));
      const snap = await getDocs(q);
      if(snap.empty){
        // create new
        await addDoc(collection(db,'leaderboard'), { ...obj, email: email, createdAt: Date.now() });
      } else {
        // update first doc
        const d = snap.docs[0];
        await updateDoc(doc(db,'leaderboard',d.id), { ...obj, lastPlayed: Date.now() });
      }
    }catch(e){
      console.warn("Leaderboard create/update error:", e);
    }
  }

  // --- NAVIGATION: main menu buttons ---
  document.getElementById("btn-chords").addEventListener("click", ()=>{
    showPanel(chordsPanel);
    populateChordGrid();
  });

  document.getElementById("btn-practice").addEventListener("click", ()=>{
    showPanel(practicePanel);
  });

  document.getElementById("btn-strum").addEventListener("click", ()=>{
    showPanel(strumPanel);
    renderSongs();
  });

  document.getElementById("btn-quiz").addEventListener("click", ()=>{
    showPanel(quizPanel);
  });

  document.getElementById("btn-metronome").addEventListener("click", ()=>{
    showPanel(metronomePanel);
  });

  document.getElementById("btn-learn-songs").addEventListener("click", ()=>{
    alert("Learn songs will open the song learning module (not implemented fully).");
  });

  document.getElementById("btn-tune").addEventListener("click", ()=>{
    window.open('https://www.guitartuna.com/', '_blank');
  });

  // back buttons
  document.getElementById("back-chords").addEventListener("click", ()=> showPanel(mainMenu));
  document.getElementById("back-practice").addEventListener("click", ()=> showPanel(mainMenu));
  document.getElementById("back-strum").addEventListener("click", ()=> showPanel(mainMenu));
  document.getElementById("back-quiz").addEventListener("click", ()=> showPanel(mainMenu));
  document.getElementById("back-dashboard").addEventListener("click", ()=> showPanel(mainMenu));
  document.getElementById("back-met").addEventListener("click", ()=> showPanel(mainMenu));
  document.getElementById("back-admin").addEventListener("click", ()=> showPanel(mainMenu));

  // Dashboard button
  document.getElementById("show-dashboard").addEventListener("click", async ()=>{
    showPanel(dashboardPanel);
    accountPanel.style.display = 'none';
    if(auth.currentUser) await refreshDashboardFor(auth.currentUser.email);
  });

  async function refreshDashboardFor(email){
    if(!email) return;
    try{
      const q = query(collection(db,'leaderboard'), where('email','==', email), limit(1));
      const snap = await getDocs(q);
      if(!snap.empty){
        const data = snap.docs[0].data();
        document.getElementById('dash-username').textContent = data.displayName || data.email || 'User';
        document.getElementById('dash-email').textContent = data.email || '';
        if(data.strumAccuracy !== undefined) document.getElementById('dash-strum').textContent = data.strumAccuracy + '%';
        else document.getElementById('dash-strum').textContent = (data.strumAccuracy || 0) + '%';
        if(data.quizHistory) document.getElementById('dash-quiz').textContent = data.quizHistory.join(', ');
      }
    }catch(e){ console.warn("Dashboard refresh error", e); }
  }

  // --------------------
  // Chords grid population
  // --------------------
  const chordsAll = ["C","D","E","F","G","A","B","Am","Dm","Em","F#m","Bm","Cmaj7","C#m","G#m","F#","G#","A#","Bb","Db"];
  function chordNameToFile(chord){
    // produce simple mapping: F# -> fsharp.png, F#m -> fsharpm.png, C -> c.png, A# -> asharp.png, Bb -> bb.png
    let name = chord.toLowerCase();
    name = name.replace(/#/g, 'sharp');
    name = name.replace(/m$/,'m'); // keep trailing m for minors if that's the image naming convention
    // User wanted names like c.png, fsharp.png, fsharpm.png. We'll attempt to match:
    if(name.endsWith('m') && !name.endsWith('maj7')) {
      // e.g. fsharpm or am
      return `${name}.png`;
    }
    return `${name}.png`;
  }

  function populateChordGrid(){
    const grid = document.getElementById('chord-grid');
    grid.innerHTML = '';
    chordsAll.forEach(ch=>{
      const card = document.createElement('div');
      card.className = 'chord-card';
      const fname = chordNameToFile(ch);
      card.innerHTML = `<div style="font-weight:700;color:var(--white)">${ch}</div>
        <img src="image/${fname}" alt="${ch} chord" onerror="this.onerror=null;this.src='image/placeholder.png'">`;
      grid.appendChild(card);
    });
  }

  // --------------------
  // Practice chords
  // --------------------
  let practiceChords = chordsAll.slice();
  let currentPracticeChord = null;
  document.getElementById('next-chord').addEventListener('click', ()=>{
    currentPracticeChord = practiceChords[Math.floor(Math.random()*practiceChords.length)];
    document.getElementById('practice-chord-display').textContent = currentPracticeChord;
    document.getElementById('practice-feedback').innerHTML = `<img src="image/${chordNameToFile(currentPracticeChord)}" style="width:150px" onerror="this.onerror=null;this.style.display='none'">`;
  });

  // play chord placeholder (no builtin sounds)
  document.getElementById('play-chord').addEventListener('click', ()=>{
    alert('Play chord feature requires pre-recorded audio samples. Add audio assets named by chord to enable playback.');
  });

  // --------------------
  // Songs list & Strum practice
  // --------------------
  // initial songs array (you asked to add many; here is a starter list; admin can bulk-add)
  let songs = [
    {name:"Wonderwall - Oasis", author:"Oasis", capo:"2", chords:"Em7 G Dsus4 A7sus4", pattern:"‚Üì ‚Üì ‚Üë ‚Üë ‚Üì ‚Üë"},
    {name:"Knockin' on Heaven's Door - Bob Dylan", author:"Bob Dylan", capo:"", chords:"G D Am C", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üì ‚Üë"},
    {name:"Zombie - The Cranberries", author:"The Cranberries", capo:"", chords:"Em C G D", pattern:"‚Üì ‚Üì ‚Üë ‚Üë"},
    {name:"Let It Be - The Beatles", author:"The Beatles", capo:"", chords:"C G Am F", pattern:"‚Üì ‚Üì ‚Üë ‚Üì ‚Üì ‚Üë"},
    {name:"Beautiful in White - Westlife", author:"Westlife", capo:"", chords:"G D Em C", pattern:"‚Üì ‚Üì ‚Üë ‚Üë ‚Üì ‚Üë"}
  ];

  const songListEl = document.getElementById('song-list');
  const songSearchEl = document.getElementById('song-search');
  function renderSongs(filter=''){
    songListEl.innerHTML = '';
    const q = (filter||'').trim().toLowerCase();
    songs.forEach(s=>{
      if(q && !s.name.toLowerCase().includes(q) && !s.author.toLowerCase().includes(q)) return;
      const div = document.createElement('div');
      div.className = 'song';
      div.innerHTML = `<div class="title" style="color:var(--white)">${s.name}</div>
        <div class="meta">Author: ${s.author} <br> Chords: ${s.chords} <br> Capo: ${s.capo||'-'} <br> Pattern: ${s.pattern}</div>
        <div style="margin-top:8px">
          <button class="ghost select-song" data-name="${escapeHtml(s.name)}">Select</button>
        </div>`;
      songListEl.appendChild(div);
    });
    // attach select handlers
    document.querySelectorAll('.select-song').forEach(btn=>{
      btn.addEventListener('click', (ev)=>{
        const nm = ev.currentTarget.dataset.name;
        selectSong(nm);
      });
    });
  }
  function escapeHtml(str){ return str.replace(/'/g,"\\'").replace(/\"/g,"\\\""); }

  songSearchEl && songSearchEl.addEventListener('input', ()=> renderSongs(songSearchEl.value));
  renderSongs();

  function selectSong(name){
    // find song by name
    const song = songs.find(s=>s.name === name) || songs.find(s=>decodeURIComponent(s.name) === name);
    if(!song) { return; }
    document.getElementById('song-pattern').textContent = `Pattern: ${song.pattern}`;
    // set selected pattern for strum practice
    currentPattern = song.pattern.split(/\s+/).filter(Boolean);
    highlightStrum();
    document.getElementById('strum-feedback').textContent = '';
  }

  // --------------------
  // Strum detection (simple amplitude + heuristic to detect direction)
  // --------------------
  let audioContext, analyser, dataArray, source;
  let currentPattern = ["‚Üì","‚Üì","‚Üë","‚Üì"]; // default example
  let currentStrumIndex = 0;
  let hits = 0;
  let totalStrums = 0;
  let strumActive = false;
  let lastRms = 0;
  const strumFeedback = document.getElementById("strum-feedback");
  const startMicBtn = document.getElementById("start-mic");
  const startStrumPracticeBtn = document.getElementById("start-strum-practice");
  const stopMicBtn = document.getElementById("stop-mic");

  async function startMic(){
    if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){ strumFeedback.textContent = "Mic not supported."; return; }
    try{
      if(!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
      source = audioContext.createMediaStreamSource(stream);
      analyser = audioContext.createAnalyser();
      analyser.fftSize = 2048;
      source.connect(analyser);
      const bufferLength = analyser.fftSize;
      dataArray = new Uint8Array(bufferLength);
      strumFeedback.textContent = "Mic active ‚Äî listening...";
      // when mic started but not strum practice, we just show live info
      if(strumActive) {
        currentStrumIndex = 0; hits=0; totalStrums=0;
        highlightStrum();
      }
      listenLoop();
    }catch(e){
      strumFeedback.textContent = "Mic access denied.";
    }
  }

  function stopMic(){
    if(source && source.mediaStream){
      const tracks = source.mediaStream.getTracks();
      tracks.forEach(t=>t.stop());
    }
    if(audioContext && audioContext.state !== 'closed'){
      // don't close AudioContext to reuse (optional)
    }
    strumActive = false;
    strumFeedback.textContent = "Mic stopped.";
  }

  function rmsFromData(arr){
    let sum=0;
    for(let i=0;i<arr.length;i++){
      const v = arr[i]-128;
      sum += v*v;
    }
    return Math.sqrt(sum/arr.length);
  }

  function listenLoop(){
    if(!analyser) return;
    analyser.getByteTimeDomainData(dataArray);
    const rms = rmsFromData(dataArray);
    // simple threshold-based "strum" detection
    const threshold = 10; // tweakable
    if(rms > threshold && lastRms <= threshold){
      // detected an onset
      // detect "direction" by analyzing slope between start and next few samples (very heuristic)
      // We'll use frequency centroid approximation (not accurate), but we can simply alternate detection or compare energy in lower vs higher bins
      // For simplicity, detect down (‚Üì) if low-frequency energy > high-frequency energy, otherwise ‚Üë
      const freqData = new Uint8Array(analyser.frequencyBinCount);
      analyser.getByteFrequencyData(freqData);
      const half = Math.floor(freqData.length/3);
      let low=0, high=0;
      for(let i=0;i<half;i++) low += freqData[i];
      for(let i=half;i<freqData.length;i++) high += freqData[i];
      const detected = (low > high) ? "‚Üì" : "‚Üë";
      handleStrumDetected(detected);
    }
    lastRms = rms;
    requestAnimationFrame(listenLoop);
                                                     }
    function handleStrumDetected(detected){
    totalStrums++;
    if(strumActive){
      const expected = currentPattern[currentStrumIndex] || currentPattern[currentStrumIndex % currentPattern.length];
      if(detected === expected){
        hits++;
        // mark highlight green for this index
        markStrumIndex(currentStrumIndex, true);
        currentStrumIndex++;
        strumFeedback.textContent = "Good!";
      } else {
        markStrumIndex(currentStrumIndex, false);
        strumFeedback.textContent = `Wrong strum (detected ${detected}, expected ${expected})`;
      }
      updateStrumDashboardAccuracy();
      if(currentStrumIndex >= currentPattern.length){
        strumFeedback.textContent = "Pattern completed!";
        strumActive = false;
        // save strum accuracy to user leaderboard doc
        saveStrumResult();
      }
    } else {
      strumFeedback.textContent = `Detected ${detected} (not in practice mode)`;
    }
  }

  function markStrumIndex(idx, ok){
    const highlight = document.getElementById('strum-highlight');
    const parts = currentPattern.map((s,i)=> {
      if(i===idx){
        return ok ? `<span style="color:lightgreen">[${s}]</span>` : `<span style="color:#ff6666">[${s}]</span>`;
      }
      return s;
    });
    highlight.innerHTML = parts.join(' ');
  }

  function highlightStrum(){
    const highlight = document.getElementById('strum-highlight');
    highlight.textContent = currentPattern.map((s,i)=>i===currentStrumIndex?`[${s}]`:s).join(" ");
  }

  function updateStrumDashboardAccuracy(){
    const accuracy = totalStrums>0 ? Math.round((hits/totalStrums)*100) : 0;
    document.getElementById('dash-strum').textContent = accuracy + '%';
  }

  async function saveStrumResult(){
    if(!auth.currentUser) return;
    const email = auth.currentUser.email;
    const accuracy = totalStrums>0 ? Math.round((hits/totalStrums)*100) : 0;
    // update leaderboard doc
    try{
      const q = query(collection(db,'leaderboard'), where('email','==', email), limit(1));
      const snap = await getDocs(q);
      if(!snap.empty){
        const d = snap.docs[0];
        const data = d.data();
        const newHistory = (data.strumHistory || []);
        newHistory.push({ date: Date.now(), accuracy });
        await updateDoc(doc(db,'leaderboard',d.id), { strumAccuracy: accuracy, strumHistory: newHistory, lastPlayed: Date.now() });
      } else {
        await addDoc(collection(db,'leaderboard'), { email, displayName: auth.currentUser.displayName||email, strumAccuracy: accuracy, strumHistory:[{date:Date.now(),accuracy}], lastPlayed: Date.now()});
      }
    }catch(e){ console.warn("saveStrumResult err", e); }
  }

  startMicBtn.addEventListener('click', async ()=>{
    strumActive = false; // just mic test
    await startMic();
  });
  startStrumPracticeBtn.addEventListener('click', async ()=>{
    strumActive = true;
    currentStrumIndex = 0; hits=0; totalStrums=0;
    highlightStrum();
    await startMic();
    strumFeedback.textContent = "Strum practice started ‚Äî follow the highlighted pattern.";
  });
  stopMicBtn.addEventListener('click', ()=> stopMic());

  // --------------------
  // Quiz
  // --------------------
  const quizChords = chordsAll.slice(); // include all chords
  let quizScore = 0;
  let quizCount = 0;
  const quizTotal = 10;
  const quizArea = document.getElementById("quiz-area");
  const quizResult = document.getElementById("quiz-result");
  const quizImage = document.getElementById("quiz-image");
  const quizOptions = document.getElementById("quiz-options");
  const timerEl = document.getElementById("timer");
  let quizTimer;
  let currentQuizChord;

  document.getElementById("start-quiz").addEventListener("click", ()=>{
    quizScore = 0; quizCount = 0;
    quizResult.classList.add("hidden"); quizArea.classList.remove("hidden");
    nextQuizChord();
  });

  document.getElementById("reset-quiz").addEventListener("click", ()=>{
    quizScore=0; quizCount=0; quizArea.classList.add("hidden"); quizResult.classList.add("hidden");
  });

  function nextQuizChord(){
    if(quizCount >= quizTotal){
      quizArea.classList.add("hidden"); quizResult.classList.remove("hidden");
      quizResult.textContent = `Quiz Completed! Score: ${quizScore}/${quizTotal}`;
      // update user leaderboard with quiz score history
      saveQuizResult(quizScore);
      return;
    }
    currentQuizChord = quizChords[Math.floor(Math.random()*quizChords.length)];
    // show chord image if exists
    const imgFile = chordNameToFile(currentQuizChord);
    quizImage.innerHTML = `<img src="image/${imgFile}" alt="${currentQuizChord}" style="width:160px" onerror="this.onerror=null;this.style.display='none'">`;
    quizOptions.innerHTML = "";
    const choices = shuffleArray(quizChords).slice(0,3);
    if(!choices.includes(currentQuizChord)) choices[Math.floor(Math.random()*3)] = currentQuizChord;
    choices.push(currentQuizChord); // ensure
    const finalChoices = shuffleArray(choices);
    finalChoices.forEach(c=>{
      const btn = document.createElement("button");
      btn.textContent = c;
      btn.addEventListener("click", ()=>{
        if(c===currentQuizChord) quizScore++;
        quizCount++;
        clearInterval(quizTimer);
        nextQuizChord();
      });
      quizOptions.appendChild(btn);
    });
    startQuizTimer();
  }

  function startQuizTimer(){
    let time = 20; // default 7 sec
    timerEl.textContent = time;
    clearInterval(quizTimer);
    quizTimer = setInterval(()=>{
      time--; timerEl.textContent = time;
      if(time<=0){
        clearInterval(quizTimer);
        quizCount++;
        nextQuizChord();
      }
    },1000);
  }

  function shuffleArray(array){
    return array.sort(()=>Math.random()-0.5);
  }

  async function saveQuizResult(score){
    if(!auth.currentUser) return;
    const email = auth.currentUser.email;
    try{
      const q = query(collection(db,'leaderboard'), where('email','==', email), limit(1));
      const snap = await getDocs(q);
      if(!snap.empty){
        const d = snap.docs[0];
        const data = d.data();
        const hist = data.quizHistory || [];
        hist.push({ date: Date.now(), score });
        await updateDoc(doc(db,'leaderboard',d.id), { quizHistory: hist, lastPlayed: Date.now() });
      } else {
        await addDoc(collection(db,'leaderboard'), { email, displayName: auth.currentUser.displayName||email, quizHistory:[{date:Date.now(),score}], lastPlayed: Date.now()});
      }
    }catch(e){ console.warn("saveQuizResult err", e); }
  }

  // --------------------
  // Metronome (bouncing ball)
  // --------------------
  let metInterval = null;
  const metBall = document.getElementById('met-ball');
  function startMetronome(){
    const bpm = Math.max(30, Math.min(240, parseInt(document.getElementById('met-bpm').value || 80)));
    const ms = 60000 / bpm;
    // animate ball: use CSS transform translateY
    let directionDown = true;
    clearInterval(metInterval);
    metInterval = setInterval(()=>{
      // bounce: quick translate up then down
      metBall.animate([
        { transform: 'translateY(0px)' },
        { transform: 'translateY(-24px)' },
        { transform: 'translateY(0px)' }
      ], { duration: ms, iterations: 1 });
      // optionally: play a click sound (not included)
    }, ms);
  }
  function stopMetronome(){
    clearInterval(metInterval);
    metInterval = null;
  }
  document.getElementById('start-met').addEventListener('click', ()=> startMetronome());
  document.getElementById('stop-met').addEventListener('click', ()=> stopMetronome());

  // --------------------
  // Admin panel: add/edit songs, bulk add
  // --------------------
  const adminSave = document.getElementById('admin-save-song');
  const adminBulkAddBtn = document.getElementById('admin-bulk-add');
  const adminSongListEl = document.getElementById('admin-song-list');

  adminSave.addEventListener('click', async ()=>{
    const name = document.getElementById('admin-song-name').value.trim();
    const author = document.getElementById('admin-song-author').value.trim();
    const capo = document.getElementById('admin-song-capo').value.trim();
    const chords = document.getElementById('admin-song-chords').value.trim();
    const pattern = document.getElementById('admin-song-pattern').value.trim();
    if(!name){ alert('Provide a song name.'); return; }
    // add to local songs array and Firestore
    const songObj = { name, author, capo, chords, pattern };
    songs.push(songObj);
    renderSongs();
    await addSongToFirestore(songObj);
    alert('Song saved.');
    clearAdminSongForm();
    await populateAdminSongList();
  });

  function clearAdminSongForm(){
    document.getElementById('admin-song-name').value='';
    document.getElementById('admin-song-author').value='';
    document.getElementById('admin-song-capo').value='';
    document.getElementById('admin-song-chords').value='';
    document.getElementById('admin-song-pattern').value='';
  }

  adminBulkAddBtn.addEventListener('click', async ()=>{
    const bulk = document.getElementById('admin-bulk').value.trim();
    if(!bulk) return;
    const lines = bulk.split('\n').map(l=>l.trim()).filter(Boolean);
    for(const line of lines){
      // Expect: Name|Author|Capo|Chords|Pattern
      const parts = line.split('|').map(p=>p.trim());
      if(parts.length >= 5){
        const s = { name: parts[0], author: parts[1], capo: parts[2], chords: parts[3], pattern: parts[4] };
        songs.push(s);
        await addSongToFirestore(s);
      }
    }
    renderSongs();
    document.getElementById('admin-bulk').value='';
    await populateAdminSongList();
    alert('Bulk add complete.');
  });

  async function addSongToFirestore(songObj){
    try{
      await addDoc(collection(db,'songs'), { ...songObj, createdAt: Date.now() });
    }catch(e){ console.warn('addSongToFirestore error', e); }
  }

  async function populateAdminSongList(){
    adminSongListEl.innerHTML = '';
    // fetch songs from Firestore to list (admin function)
    try{
      const snap = await getDocs(collection(db,'songs'));
      snap.forEach(docSnap=>{
        const data = docSnap.data();
        const id = docSnap.id;
        const div = document.createElement('div');
        div.style.borderBottom = '1px solid #222';
        div.style.padding = '6px 0';
        div.innerHTML = `<strong style="color:var(--white)">${data.name}</strong> <div style="font-size:0.9rem;color:#ccc">${data.author || ''} ‚Äî Chords: ${data.chords || ''} ‚Äî Pattern: ${data.pattern || ''}</div>
          <div style="margin-top:6px">
            <button class="admin-edit-song" data-id="${id}">Edit</button>
            <button class="admin-delete-song ghost" data-id="${id}">Delete</button>
          </div>`;
        adminSongListEl.appendChild(div);
      });
      // attach handlers
      document.querySelectorAll('.admin-delete-song').forEach(btn=>{
        btn.addEventListener('click', async (ev)=>{
          const id = ev.currentTarget.dataset.id;
          if(!confirm('Delete this song?')) return;
          await deleteDoc(doc(db,'songs',id));
          await populateAdminSongList();
          alert('Deleted.');
        });
      });
      document.querySelectorAll('.admin-edit-song').forEach(btn=>{
        btn.addEventListener('click', async (ev)=>{
          const id = ev.currentTarget.dataset.id;
          const docSnap = await getDoc(doc(db,'songs',id));
          if(!docSnap.exists()) return alert('Not found');
          const data = docSnap.data();
          // populate form for editing
          document.getElementById('admin-song-name').value = data.name || '';
          document.getElementById('admin-song-author').value = data.author || '';
          document.getElementById('admin-song-capo').value = data.capo || '';
          document.getElementById('admin-song-chords').value = data.chords || '';
          document.getElementById('admin-song-pattern').value = data.pattern || '';
          // replace save handler temporarily to update existing doc
          adminSave.onclick = async ()=>{
            const updated = {
              name: document.getElementById('admin-song-name').value.trim(),
              author: document.getElementById('admin-song-author').value.trim(),
              capo: document.getElementById('admin-song-capo').value.trim(),
              chords: document.getElementById('admin-song-chords').value.trim(),
              pattern: document.getElementById('admin-song-pattern').value.trim()
            };
            await updateDoc(doc(db,'songs',id), updated);
            alert('Updated.');
            adminSave.onclick = null;
            adminSave.addEventListener('click', ()=>{}); // reset
            clearAdminSongForm();
            await populateAdminSongList();
            renderSongs();
          };
          alert('Edit the fields and click Save Song (it will update the existing song).');
        });
      });
    }catch(e){ console.warn('populateAdminSongList err', e); }
  }

  // Manual user override apply
  document.getElementById('apply-override').addEventListener('click', async ()=>{
    const email = document.getElementById('override-user').value.trim();
    const streak = parseInt(document.getElementById('override-streak').value)||0;
    const level = document.getElementById('override-level').value || "Beginner";
    const highScore = parseInt(document.getElementById('override-highscore').value)||0;
    if(!email){ alert('Enter user email or username'); return; }
    // find by email
    try{
      const q = query(collection(db,'leaderboard'), where('email','==', email), limit(1));
      const snap = await getDocs(q);
      if(!snap.empty){
        const id = snap.docs[0].id;
        await updateDoc(doc(db,'leaderboard',id), { streak, level, highScore, lastPlayed: Date.now() });
        alert('User updated successfully!');
      } else {
        // create using email as id
        await addDoc(collection(db,'leaderboard'), { displayName: email, email, streak, level, highScore, lastPlayed: Date.now() });
        alert('New user created and updated!');
      }
    }catch(e){ console.warn(e); alert('Error applying override'); }
  });

  // --------------------
  // Firestore initial sync of songs (on load)
  // --------------------
  async function loadSongsFromFirestore(){
    try{
      const snap = await getDocs(collection(db,'songs'));
      const arr = [];
      snap.forEach(d=>{
        arr.push(d.data());
      });
      if(arr.length>0) {
        // append but avoid duplicates by name
        arr.forEach(s=>{
          if(!songs.find(x=>x.name === s.name)) songs.push(s);
        });
        renderSongs();
      }
    }catch(e){ console.warn('loadSongsFromFirestore err', e); }
  }
  loadSongsFromFirestore();

  // --------------------
  // Misc helpers
  // --------------------
  function escapeHtmlSimple(str){ return (str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  // --------------------
  // Initial UI
  // --------------------
  showPanel(loginScreen);

  // Ensure admin list ready
  populateAdminSongList();

</script>
</body>
</html>

