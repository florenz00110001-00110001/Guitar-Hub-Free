<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Guitar Hub Trainer - Ultimate Edition</title>
<style>
  :root{
    --bg:#111;
    --panel:#000;
    --accent:orange;
    --muted:#222;
    --text:#fff;
    --card:#1a1a1a;
    --white:#fff;
    --accent-dark:#e07b00;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:Arial, sans-serif;
    background:var(--bg);
    color:var(--text);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    text-align:center;
    transition:background 0.25s,color 0.25s;
  }
  /* make selected UI text non-copyable where asked */
  .no-select{user-select:none;-webkit-user-select:none;-ms-user-select:none;}

  header{
    width:100%;
    background:var(--panel);
    padding:10px 18px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    position:fixed;
    top:0; left:0;
    z-index:1000;
    box-shadow:0 2px 8px rgba(0,0,0,0.6);
  }
  .logo{display:flex;align-items:center;font-weight:700;font-size:1.25rem;color:var(--white)}
  .logo .guitar{color:var(--white)}
  .logo .hub{color:black;background:orange;padding:4px 8px;border-radius:6px;margin-left:8px}
  .controls{display:flex;gap:8px;align-items:center}
  main{padding:92px 14px 40px; max-width:980px;margin:0 auto;}
  button{padding:10px 16px;border-radius:8px;border:none;background:var(--accent);color:#000;font-weight:600;cursor:pointer;transition:all 0.2s}
  button:hover{opacity:0.95}
  .back-btn{background:#444;color:#fff}
  .ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:8px}
  .card{background:var(--muted);padding:14px;border-radius:10px;margin:12px 0;box-shadow:0 6px 16px rgba(0,0,0,0.6);transition:all 0.3s ease}
  .hidden{display:none;opacity:0;transition:opacity 0.25s ease}
  .visible{display:block;opacity:1;transition:opacity 0.25s ease}
  .chord-grid{display:flex;flex-wrap:wrap;gap:14px;justify-content:center;padding:8px}
  .chord-card{width:120px;background:#222;padding:10px;border-radius:10px;box-shadow:0 6px 14px rgba(0,0,0,0.6);text-align:center;transition:transform 0.2s}
  .chord-card:hover{transform:scale(1.05)}
  .chord-card img{width:100px;height:auto;display:block;margin:8px auto}
  .timer{font-weight:700;color:gold;font-size:1.2rem;margin:8px}
  #quiz-options button{display:block;width:100%;margin:8px 0;background:#333;color:#fff;padding:10px;border-radius:8px}
  input[type="text"],input[type="email"],input[type="password"],textarea,select{
    width:100%;padding:10px;border-radius:8px;border:none;background:#1b1b1b;color:#fff;margin-bottom:10px;font-size:1rem;
  }
  .row{display:flex;gap:8px;align-items:center}
  .row .small{width:48px;padding:8px}
  .song{padding:10px;border-radius:8px;background:#171717;margin:8px 0;text-align:left;color:var(--white)}
  .song .title{font-weight:700}
  .song .meta{font-size:0.9rem;color:#ddd;margin-top:6px}
  #burger{font-size:1.4rem;background:none;border:none;color:#fff;cursor:pointer;padding:6px 8px}
  #account-panel{position:fixed;top:58px;right:12px;width:320px;background:#141414;padding:12px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,0.6);display:none;z-index:1100;color:var(--white)}
  #account-panel h4{margin:0 0 8px 0}
  #strum-highlight{font-size:1.5rem;margin:12px 0;letter-spacing:6px;color:var(--white)}
  .metronome-line{height:8px;background:#333;border-radius:6px;position:relative;overflow:hidden;margin-top:10px}
  .metronome-ball{position:absolute;left:0;top:50%;transform:translateY(-50%);width:18px;height:18px;border-radius:50%;background:var(--accent);box-shadow:0 2px 8px rgba(0,0,0,0.4)}
  .metronome-bar{height:4px;background:#777;margin-top:8px;border-radius:2px;position:relative;overflow:hidden}
  .metronome-bouncing{animation:metronomeBounce 300ms ease;}
  @keyframes metronomeBounce{
    0%{transform:translateY(-50%) scale(1);}
    50%{transform:translateY(-35%) scale(0.95);}
    100%{transform:translateY(-50%) scale(1);}
  }
  .no-select{user-select:none;-webkit-user-select:none;-ms-user-select:none}

  @media (max-width:600px){
    .logo{font-size:1.05rem}
    main{padding:96px 12px}
    .chord-card{width:96px}
  }
  .light-mode{background:#fff;color:#000}
  /* keep UI headings white always where requested */
  .force-white, header .logo, #account-panel, .song, .card h1, .card h2, .card h3 { color:var(--white) !important; }
  .light-mode .logo .hub{background:orange;color:black}
  .light-mode button{color:#000}
  .muted-small{color:#bbb;font-size:0.9rem}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .admin-badge{display:inline-block;padding:4px 8px;border-radius:6px;background:#333;color:#fff;margin-left:8px;font-weight:700}
  .inline{display:inline-block}
  .tiny{font-size:0.85rem;padding:6px 8px}
  .danger{background:#521515;color:#fff}
</style>
</head>
<body>

<header>
  <div class="logo no-select">
    <span class="guitar">Guitar</span><span class="hub">Hub-Ultimate</span>
  </div>
  <div class="controls">
    <button id="dark-toggle" title="Toggle theme" class="no-select">üåó</button>
    <button id="burger" aria-label="Open account menu" class="no-select">‚ò∞</button>
  </div>
</header>

<div id="account-panel" aria-hidden="true">
  <h4>Account</h4>
  <p id="account-email" class="no-select">Not signed in</p>
  <p class="muted-small">Username: <span id="account-username">Guest</span></p>
  <div style="display:flex;gap:8px;margin-top:8px;">
    <button id="show-dashboard" class="ghost no-select">Dashboard</button>
    <button id="signout-btn" class="ghost no-select">Sign out</button>
  </div>
  <hr style="margin:10px 0;border-color:#222">
  <button id="change-username" class="ghost" style="width:100%;margin-bottom:8px">Change username</button>
  <button id="change-pass" class="ghost" style="width:100%;margin-bottom:8px">Change password</button>
  <button id="delete-account" class="ghost danger" style="width:100%">Delete account</button>
  <div style="margin-top:10px">
    <div id="badges-container"></div>
  </div>
</div>

<main>
  <div id="login-screen" class="card">
    <h1 style="margin:0 0 8px 0;color:var(--white)" class="no-select">Login</h1>
    <input id="email" type="email" placeholder="Email" autocomplete="username">
    <div class="row" style="align-items:center">
      <input id="password" type="password" placeholder="Password" autocomplete="current-password" style="flex:1">
      <button id="toggle-pass" class="ghost small" title="Show/Hide">üëÅÔ∏è</button>
    </div>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:8px">
      <button id="login-btn">Login</button>
      <button id="signup-btn" class="ghost">Sign up</button>
    </div>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:10px">
      <button id="continue-btn" class="ghost">Continue without account</button>
    </div>
    <p style="margin:12px 0 0 0"><a href="#" id="forgot-link" style="color:#ddd">Forgot password?</a></p>
    <p id="auth-msg" style="color:#f88;margin-top:8px"></p>
  </div>

  <div id="main-menu" class="card hidden">
    <h2 style="margin-top:0;color:var(--white)" class="no-select">Main Menu</h2>
    <div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center">
      <button id="btn-chords">View Chords</button>
      <button id="btn-practice">Practice Chords</button>
      <button id="btn-strum">Practice Strum</button>
      <button id="btn-quiz">Chord Recognition Quiz</button>
      <button id="btn-learn-songs" class="ghost">Learn Songs</button>
      <button id="btn-tune" class="ghost">Tune with GuitarTuna</button>
      <button id="btn-metronome" class="ghost">Metronome</button>
    </div>
  </div>

  <div id="chords" class="card hidden">
    <h2 style="margin-top:0;color:var(--white)" class="no-select">Basic Chords</h2>
    <div class="chord-grid" id="chord-grid"></div>
    <button class="back-btn" id="back-from-chords">‚¨Ö Back</button>
  </div>

  <div id="practice" class="card hidden">
    <h2 style="margin-top:0;color:var(--white)" class="no-select">Practice Chords (Random)</h2>
    <div id="practice-chord-display" style="font-size:2rem;margin:16px;color:var(--white)"></div>
    <div style="display:flex;gap:8px;justify-content:center">
      <button id="next-chord">Next Chord</button>
      <button id="play-chord" class="ghost">Play Chord</button>
    </div>
    <p id="practice-feedback" style="margin-top:10px;color:var(--white)"></p>
    <button class="back-btn" id="back-from-practice">‚¨Ö Back</button>
  </div>

  <div id="strum" class="card hidden">
    <h2 style="margin-top:0;color:var(--white)" class="no-select">Practice Strum</h2>
    <input id="song-search" type="text" placeholder="Search songs..." style="margin-bottom:12px;color:var(--white);background:#222"/>
    <div id="song-list" style="max-height:360px;overflow:auto;padding-right:6px"></div>
    <div style="margin-top:12px">
      <p id="song-pattern" style="font-weight:700;color:var(--white)">Pattern: ‚Äî</p>
      <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:8px">
        <button id="start-mic" class="ghost">Start Mic Test</button>
        <button id="start-strum-practice" class="ghost">Start Strum Practice</button>
        <button id="stop-mic" class="ghost">Stop Mic</button>
      </div>
      <p id="strum-feedback" style="margin-top:8px;color:var(--white)"></p>
      <div id="strum-highlight" class="no-select"></div>
    </div>
    <button class="back-btn" id="back-from-strum">‚¨Ö Back</button>
  </div>

  <div id="quiz" class="card hidden">
    <h2 style="margin-top:0;color:var(--white)" class="no-select">Chord Recognition Quiz</h2>
    <div style="margin-bottom:12px">
      <button id="start-quiz">Start Quiz</button>
      <button id="reset-quiz" class="ghost" style="display:none">Reset</button>
    </div>
    <div id="quiz-area" class="hidden" style="text-align:center">
      <div class="timer" id="timer">5</div>
      <div id="quiz-image" style="margin:8px"></div>
      <div id="quiz-options" style="max-width:420px;margin:0 auto;text-align:center"></div>
      <p id="quiz-progress" style="margin-top:8px;color:var(--white)"></p>
    </div>
    <div id="quiz-result" class="hidden" style="margin-top:12px;font-weight:700;color:var(--white)"></div>
    <button class="back-btn" id="back-from-quiz">‚¨Ö Back</button>
  </div>

  <div id="metronome" class="card hidden">
    <h2 style="margin-top:0;color:var(--white)" class="no-select">Metronome</h2>
    <div style="display:flex;gap:8px;align-items:center;justify-content:center">
      <label class="muted-small" style="margin-right:8px">BPM</label>
      <input id="metronome-bpm" type="number" value="80" min="30" max="300" style="width:90px">
      <select id="metronome-division">
        <option value="1">Quarter</option>
        <option value="2">Eighth</option>
        <option value="4">Sixteenth</option>
      </select>
      <button id="start-metronome" class="ghost">Start</button>
      <button id="stop-metronome" class="ghost">Stop</button>
    </div>
    <div class="metronome-line" id="met-line" style="height:10px;margin-top:18px">
      <div class="metronome-ball" id="met-ball"></div>
    </div>
    <div class="metronome-bar" id="met-bar" style="width:100%;height:6px;margin-top:12px"></div>
    <button class="back-btn" id="back-from-metronome">‚¨Ö Back</button>
  </div>

  <div id="dashboard" class="card hidden">
    <h2 style="margin-top:0;color:var(--white)" class="no-select">Dashboard</h2>
    <p>Strum Accuracy: <span id="dash-strum">0%</span></p>
    <p>Quiz Score History: <span id="dash-quiz">N/A</span></p>
    <p>Level: <span id="dash-level">Beginner</span></p>
    <p>Streak: <span id="dash-streak">0</span></p>
    <button class="back-btn" id="back-from-dashboard">‚¨Ö Back</button>
  </div>

  <!-- Admin panel (hidden unless admin) -->
  <div id="admin-panel" class="card hidden" style="margin-top:20px;">
    <h2 class="no-select">Admin Controls <span class="admin-badge">Admin</span></h2>

    <div style="margin-top:8px">
      <h3 class="no-select">Songs (Bulk Add)</h3>
      <p class="muted-small">Paste songs JSON/lines here (we left this empty for you)</p>
      <textarea id="bulk-add-area" rows="6" placeholder='Add songs here (JSON array or lines)'></textarea>
      <div style="display:flex;gap:8px">
        <button id="bulk-add-btn">Bulk Add</button>
        <button id="refresh-songs">Refresh Song List</button>
      </div>
    </div>

    <div style="margin-top:12px">
      <h3 class="no-select">Add/Edit Single Song</h3>
      <div class="grid-2">
        <input id="song-name" placeholder="Song name">
        <input id="song-author" placeholder="Author">
        <input id="song-capo" placeholder="Capo (e.g. 4) or leave blank">
        <input id="song-chords" placeholder="Chords (space separated)">
        <input id="song-pattern" placeholder='Pattern (e.g. "‚Üì ‚Üì ‚Üë ‚Üë ‚Üì ‚Üë")'>
        <button id="save-song">Save Song</button>
      </div>
    </div>

    <div style="margin-top:12px">
      <h3 class="no-select">Admin Song List</h3>
      <div id="admin-song-list" style="max-height:240px;overflow:auto"></div>
    </div>

    <div style="margin-top:12px">
      <h3 class="no-select">Manual User Override</h3>
      <input id="override-user" type="text" placeholder="Enter user email">
      <input id="override-streak" type="number" placeholder="Set streak">
      <input id="override-level" type="text" placeholder="Set level">
      <input id="override-highscore" type="number" placeholder="Set high score">
      <div style="display:flex;gap:8px">
        <button id="apply-override">Apply Changes</button>
        <button id="admin-logout" class="ghost">Logout Admin</button>
      </div>
    </div>
    <button class="back-btn" id="back-from-admin">‚¨Ö Back</button>
  </div>

  <!-- Leaderboard -->
  <div id="leaderboard" class="card hidden">
    <h2 style="margin-top:0;color:var(--white)" class="no-select">Leaderboard</h2>
    <div id="leaderboard-list" style="max-height:360px;overflow:auto"></div>
    <button class="back-btn" id="back-from-leaderboard">‚¨Ö Back</button>
  </div>
</main>

<!-- Firebase & App Logic -->
<script type="module">
  // CDN imports for Firebase (using versions you provided)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail, onAuthStateChanged, updatePassword } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, setDoc, getDocs, doc, updateDoc, query, where, orderBy, limit, getDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

  // Your Firebase config (kept as provided)
  const firebaseConfig = {
    apiKey: "AIzaSyDkMmF78dFu2dmuzka6xuwpLRD5NRCCJtY",
    authDomain: "guitar-hub-25dfa.firebaseapp.com",
    projectId: "guitar-hub-25dfa",
    storageBucket: "guitar-hub-25dfa.firebasestorage.app",
    messagingSenderId: "36479296604",
    appId: "1:36479296604:web:5dbcfb2aec3912f8ba7299",
    measurementId: "G-N4HZW695LF"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Panels
  const loginScreen = document.getElementById("login-screen");
  const mainMenu = document.getElementById("main-menu");
  const chordsPanel = document.getElementById("chords");
  const practicePanel = document.getElementById("practice");
  const strumPanel = document.getElementById("strum");
  const quizPanel = document.getElementById("quiz");
  const metronomePanel = document.getElementById("metronome");
  const dashboardPanel = document.getElementById("dashboard");
  const adminPanel = document.getElementById("admin-panel");
  const leaderboardPanel = document.getElementById("leaderboard");

  // Auth UI elements
  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");
  const authMsg = document.getElementById("auth-msg");
  const burgerBtn = document.getElementById("burger");
  const accountPanel = document.getElementById("account-panel");
  const accountEmail = document.getElementById("account-email");
  const accountUsername = document.getElementById("account-username");
  const badgesContainer = document.getElementById("badges-container");

  // Hardcoded admin email:
  const ADMIN_EMAIL = "florenzjed12@gmail.com";

  // Utility: show panel function (hides all then shows given)
  function showPanel(panel){
    // hide everything
    [loginScreen, mainMenu, chordsPanel, practicePanel, strumPanel, quizPanel, metronomePanel, dashboardPanel, adminPanel, leaderboardPanel].forEach(p=>{
      if(!p) return;
      p.classList.add("hidden");
      p.classList.remove("visible");
    });
    if(panel){
      panel.classList.remove("hidden");
      panel.classList.add("visible");
      window.scrollTo({top:0,behavior:"smooth"});
    }
  }

  // Toggle dark/light
  document.getElementById("dark-toggle").addEventListener("click", ()=> {
    document.body.classList.toggle("light-mode");
    // keep some headings white regardless
    document.querySelectorAll(".force-white").forEach(n => n.style.color = "var(--white)");
  });

  // Burger toggles account panel
  burgerBtn.addEventListener("click", ()=>{
    accountPanel.style.display = accountPanel.style.display === "block" ? "none" : "block";
  });

  // Toggle password visibility
  document.getElementById("toggle-pass").addEventListener("click", ()=>{
    passwordInput.type = passwordInput.type === "password" ? "text" : "password";
  });

  // Sign up
  document.getElementById("signup-btn").addEventListener("click", async ()=>{
    const email = emailInput.value.trim();
    const pw = passwordInput.value;
    if(!email || !pw){ authMsg.textContent = "Provide email & password to sign up."; return; }
    try{
      await createUserWithEmailAndPassword(auth, email, pw);
      authMsg.style.color = "#8f8"; authMsg.textContent = "Account created, signed in.";
    }catch(e){ authMsg.style.color="#f88"; authMsg.textContent = e.message; }
  });

  // Login
  document.getElementById("login-btn").addEventListener("click", async ()=>{
    const email = emailInput.value.trim();
    const pw = passwordInput.value;
    if(!email || !pw){ authMsg.textContent = "Enter email & password to sign in."; authMsg.style.color="#f88"; return; }
    try{
      await signInWithEmailAndPassword(auth, email, pw);
      authMsg.style.color = "#8f8"; authMsg.textContent = "Signed in.";
    }catch(e){ authMsg.style.color="#f88"; authMsg.textContent = e.message; }
  });

  // Continue as guest
  document.getElementById("continue-btn").addEventListener("click", ()=>{
    accountPanel.style.display = 'none';
    accountEmail.textContent = "Guest";
    accountUsername.textContent = "Guest";
    showPanel(mainMenu);
  });

  // Forgot
  document.getElementById("forgot-link").addEventListener("click", async (ev)=>{
    ev.preventDefault();
    const email = emailInput.value.trim();
    if(!email){ authMsg.style.color="#f88"; authMsg.textContent = "Enter your email then click Reset."; return; }
    try{
      await sendPasswordResetEmail(auth, email);
      authMsg.style.color="#8f8"; authMsg.textContent = "Reset email sent (check inbox).";
    }catch(e){ authMsg.style.color="#f88"; authMsg.textContent = e.message; }
  });

  // Sign out
  document.getElementById("signout-btn").addEventListener("click", async ()=>{
    try{
      await signOut(auth);
      showPanel(loginScreen);
      accountPanel.style.display='none';
      accountEmail.textContent='Not signed in';
      accountUsername.textContent='Guest';
      adminPanel.classList.add("hidden");
      badgesContainer.innerHTML = "";
    }catch(e){ console.error(e); }
  });

  // Change username
  document.getElementById("change-username").addEventListener("click", async ()=>{
    const newName = prompt("Enter your new username:");
    if(!newName) return;
    accountUsername.textContent = newName;
    // update leaderboard if exists
    try{
      // find current auth user doc (by email)
      const user = auth.currentUser;
      if(user){
        const lb = collection(db,"leaderboard");
        const q = query(lb, where("email","==",user.email));
        const snap = await getDocs(q);
        if(!snap.empty){
          const docId = snap.docs[0].id;
          await updateDoc(doc(db,"leaderboard",docId), { displayName: newName });
        } else {
          // create new leaderboard entry
          await addDoc(collection(db,"leaderboard"), { displayName:newName, email:user.email, streak:0, level:"Beginner", highScore:0, lastPlayed: Date.now() });
        }
      } else {
        alert("Change username works only for signed in users.");
      }
    }catch(e){ console.error(e); }
  });

  // Change password (only signed in)
  document.getElementById("change-pass").addEventListener("click", async ()=>{
    const newPass = prompt("Enter new password (min 6 chars):");
    if(!newPass) return;
    if(!auth.currentUser){ alert("Sign in required to change password."); return; }
    try{
      await updatePassword(auth.currentUser, newPass);
      alert("Password updated.");
    }catch(e){ alert(e.message); }
  });

  // Delete account
  document.getElementById("delete-account").addEventListener("click", async ()=>{
    if(!auth.currentUser){ alert("Not signed in."); return; }
    if(!confirm("Delete your account permanently?")) return;
    try{
      // delete from firestore leaderboard (optional)
      const uEmail = auth.currentUser.email;
      const snap = await getDocs(query(collection(db,"leaderboard"), where("email","==", uEmail)));
      snap.forEach(docSnap=>{
        const id = docSnap.id;
        updateDoc(doc(db,"leaderboard",id), { deleted:true }).catch(()=>{});
      });
      // signOut (can't delete user via client without reauth; skip actual delete here)
      await signOut(auth);
      alert("Signed out. To fully delete account, reauthenticate and delete from Firebase console.");
      showPanel(loginScreen);
    }catch(e){
      alert("Delete failed: "+e.message);
    }
  });

  // Auth state listener
  onAuthStateChanged(auth, async (user)=>{
    if(user){
      accountEmail.textContent = user.email || "User";
      // load username from leaderboard or use email prefix
      const uEmail = user.email || "User";
      let displayName = uEmail.split("@")[0];
      try{
        const snap = await getDocs(query(collection(db,"leaderboard"), where("email","==", uEmail)));
        if(!snap.empty){
          const data = snap.docs[0].data();
          displayName = data.displayName || displayName;
          // update dashboard fields
          if(data.streak !== undefined) document.getElementById("dash-streak").textContent = data.streak;
          if(data.level) document.getElementById("dash-level").textContent = data.level;
          if(data.highScore !== undefined) document.getElementById("dash-quiz").textContent = data.highScore;
        } else {
          // create leaderboard doc for the user
          await addDoc(collection(db,"leaderboard"), {
            displayName,
            email: uEmail,
            streak: 0,
            level: "Beginner",
            highScore: 0,
            lastPlayed: Date.now()
          });
        }
      }catch(e){ console.warn("Error reading leaderboard:", e); }
      accountUsername.textContent = displayName;
      // show main menu
      showPanel(mainMenu);

      // Show admin panel only for admin email
      if(user.email === ADMIN_EMAIL){
        adminPanel.classList.remove("hidden");
        adminPanel.classList.add("visible");
      } else {
        adminPanel.classList.add("hidden");
      }

      // show badges from leaderboard doc if present
      try{
        const snap = await getDocs(query(collection(db,"leaderboard"), where("email","==", uEmail)));
        badgesContainer.innerHTML = "";
        if(!snap.empty){
          const data = snap.docs[0].data();
          const badges = data.badges || [];
          badges.forEach(b=>{
            const el = document.createElement("span");
            el.className = "admin-badge";
            el.textContent = b;
            badgesContainer.appendChild(el);
          });
        }
      }catch(e){}
    } else {
      // not logged in
      accountEmail.textContent = "Not signed in";
      accountUsername.textContent = "Guest";
      adminPanel.classList.add("hidden");
      showPanel(loginScreen);
    }
  });

  // --- Main Menu Buttons ---
  document.getElementById("btn-chords").addEventListener("click", ()=>{
    showPanel(chordsPanel);
    populateChordGrid(); // ensure chords loaded
  });
  document.getElementById("btn-practice").addEventListener("click", ()=>{
    showPanel(practicePanel);
  });
  document.getElementById("btn-strum").addEventListener("click", ()=>{
    showPanel(strumPanel);
  });
  document.getElementById("btn-quiz").addEventListener("click", ()=>{
    showPanel(quizPanel);
  });
  document.getElementById("btn-metronome").addEventListener("click", ()=>{
    showPanel(metronomePanel);
  });

  document.getElementById("btn-tune").addEventListener("click", ()=>{
    window.open('https://www.guitartuna.com/', '_blank');
  });

  // Back buttons
  document.getElementById("back-from-chords").addEventListener("click", ()=> showPanel(mainMenu));
  document.getElementById("back-from-practice").addEventListener("click", ()=> showPanel(mainMenu));
  document.getElementById("back-from-strum").addEventListener("click", ()=> {
    stopMicIfActive();
    showPanel(mainMenu);
  });
  document.getElementById("back-from-quiz").addEventListener("click", ()=> showPanel(mainMenu));
  document.getElementById("back-from-metronome").addEventListener("click", ()=> { stopMetronome(); showPanel(mainMenu); });
  document.getElementById("back-from-dashboard").addEventListener("click", ()=> showPanel(mainMenu));
  document.getElementById("back-from-admin").addEventListener("click", ()=> showPanel(mainMenu));
  document.getElementById("back-from-leaderboard").addEventListener("click", ()=> showPanel(mainMenu));

  // Show dashboard button in account panel
  document.getElementById("show-dashboard").addEventListener("click", ()=> {
    accountPanel.style.display = 'none';
    showPanel(dashboardPanel);
  });

  // --- Chords grid ---
  const allChords = ["C","D","E","F","G","A","B","Am","Dm","Em","F#m","Bm","Cmaj7","C#m","G#m","F#","Bb","Bbm","Fsharpm","G#","G#m","A#","A#m"];
  function chordToFilename(chord){
    // map chord string to filename conventions:
    // C -> c.png, F# -> fsharp.png, F#m -> fsharpm.png, Am -> am.png
    let name = chord.replace(/\+/g,"plus").replace(/\s+/g,"");
    // convert # to "sharp"
    name = name.replace(/#/g,"sharp");
    // lowercase
    return name.toLowerCase() + ".png";
  }

  const chordGrid = document.getElementById("chord-grid");
  function populateChordGrid(){
    chordGrid.innerHTML = "";
    allChords.forEach(chord=>{
      const card = document.createElement("div");
      card.className = "chord-card no-select";
      const fname = chordToFilename(chord);
      card.innerHTML = `<div style="font-weight:700;color:var(--white)">${chord}</div>
        <img src="image/${fname}" alt="${chord} chord" onerror="this.onerror=null;this.src='image/placeholder.png'">`;
      chordGrid.appendChild(card);
      card.addEventListener("click", ()=>{
        // show a quick practice display
        showPanel(practicePanel);
        document.getElementById("practice-chord-display").textContent = chord;
      });
    });
  }

  // --- Practice chords logic ---
  let practiceChords = allChords.slice();
  let currentPracticeChord = null;
  document.getElementById("next-chord").addEventListener("click", ()=>{
    currentPracticeChord = practiceChords[Math.floor(Math.random()*practiceChords.length)];
    document.getElementById("practice-chord-display").textContent = currentPracticeChord;
    document.getElementById("practice-feedback").textContent = "";
  });

  // Play chord (simple oscillator demo per note root)
  document.getElementById("play-chord").addEventListener("click", ()=>{
    if(!currentPracticeChord) { document.getElementById("practice-feedback").textContent = "Pick a chord first (Next)."; return; }
    playSimpleChord(currentPracticeChord);
  });

  function playSimpleChord(chord){
    // simple placeholder: play root note sine for 800ms; not realistic but gives audio feedback
    try{
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = 'sine';
      const rootFreq = chordNameToFreq(chord.replace(/m$/i,"")); // remove minor marker for root note
      osc.frequency.value = rootFreq || 440;
      gain.gain.setValueAtTime(0.0001, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.02);
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start();
      gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.8);
      setTimeout(()=>{ osc.stop(); ctx.close(); }, 900);
    }catch(e){}
  }

  function chordNameToFreq(name){
    // map basic note names to frequencies (A4=440) (approx)
    const map = {C:261.63,D:293.66,E:329.63,F:349.23,G:392.00,A:440.00,B:493.88};
    const n = name.replace(/[^A-G]/gi,"").toUpperCase();
    return map[n];
  }

  // --- Song list & Strum practice ---
  const songs = [
    {name:"Wonderwall - Oasis", chords:"Em7 G Dsus4 A7sus4", pattern:["‚Üì","‚Üì","‚Üë","‚Üë","‚Üì","‚Üë"]},
    {name:"Knockin' on Heaven's Door - Bob Dylan", chords:"G D Am G D C", pattern:["‚Üì","‚Üì","‚Üë","‚Üì","‚Üë"]},
    {name:"Zombie - The Cranberries", chords:"Em C G D", pattern:["‚Üì","‚Üë","‚Üì","‚Üë"]},
    {name:"Let It Be - The Beatles", chords:"C G Am F", pattern:["‚Üì","‚Üì","‚Üë","‚Üì","‚Üì","‚Üë","‚Üì","‚Üì","‚Üë"]},
    {name:"All of Me - John Legend", chords:"Em C G D", pattern:["‚Üì","‚Üì","‚Üë","‚Üë","‚Üì","‚Üë"]},
    // You (and later) can bulk add songs into the DB
  ];

  const songList = document.getElementById("song-list");
  const songSearch = document.getElementById("song-search");
  function renderSongs(filter=""){
    songList.innerHTML = "";
    const q = (filter||"").trim().toLowerCase();
    songs.forEach(s=>{
      if(q && !s.name.toLowerCase().includes(q)) return;
      const div = document.createElement("div");
      div.className = "song no-select";
      div.innerHTML = `<div class="title">${s.name}</div>
        <div class="meta">Chords: ${s.chords}<br>Strum: ${s.pattern.join(" ")}</div>
        <div style="margin-top:8px">
          <button class="ghost select-song-btn">Select</button>
        </div>`;
      songList.appendChild(div);
      div.querySelector(".select-song-btn").addEventListener("click", ()=>{
        selectSong(s);
      });
    });
  }
  renderSongs();
  songSearch && songSearch.addEventListener("input", ()=> renderSongs(songSearch.value));

  function selectSong(song){
    document.getElementById("song-pattern").textContent = `Pattern: ${song.pattern.join(" ")} ‚Äî Chords: ${song.chords}`;
    currentPattern = song.pattern.slice();
    currentStrumIndex = 0;
    highlightStrum();
    document.getElementById("strum-feedback").textContent = "Selected song: " + song.name;
  }

  // --- Strum detection (microphone) ---
  let audioContext, analyser, dataArray, sourceStream;
  let currentPattern = ["‚Üì","‚Üì","‚Üë","‚Üì"]; // default pattern for strum practice
  let currentStrumIndex = 0;
  let hits = 0;
  let totalStrums = 0;
  let strumActive = false;
  const strumFeedback = document.getElementById("strum-feedback");
  const startMicBtn = document.getElementById("start-mic");
  const startStrumPracticeBtn = document.getElementById("start-strum-practice");
  const stopMicBtn = document.getElementById("stop-mic");

  startMicBtn.addEventListener("click", startMicTest);
  startStrumPracticeBtn.addEventListener("click", startStrumPractice);
  stopMicBtn.addEventListener("click", ()=> { stopMicIfActive(); strumFeedback.textContent = "Mic stopped."; });

  async function startMicTest(){
    try{
      await ensureMic();
      strumFeedback.textContent = "Mic active. Try strumming now (test).";
    }catch(e){
      strumFeedback.textContent = "Mic access denied or unavailable.";
    }
            }
    async function ensureMic(){
    if(!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
    if(!sourceStream){
      const stream = await navigator.mediaDevices.getUserMedia({audio:true});
      sourceStream = audioContext.createMediaStreamSource(stream);
      analyser = audioContext.createAnalyser();
      analyser.fftSize = 2048;
      sourceStream.connect(analyser);
      dataArray = new Uint8Array(analyser.fftSize);
    }
  }

  function stopMicIfActive(){
    try{
      if(sourceStream && sourceStream.mediaStream) {
        sourceStream.mediaStream.getTracks().forEach(t=>t.stop());
      } else {
        // try to stop any attached streams via analysing context
        if(analyser && analyser.context && analyser.context.state !== "closed"){
          // nothing to stop specifically
        }
      }
    }catch(e){}
    sourceStream = null;
    analyser = null;
    dataArray = null;
    if(audioContext && audioContext.state !== "closed"){
      // don't close to preserve permissions; but you can if needed:
      // audioContext.close(); audioContext = null;
    }
    strumActive = false;
  }

  async function startStrumPractice(){
    try{
      await ensureMic();
    }catch(e){
      strumFeedback.textContent = "Mic permission needed.";
      return;
    }
    currentStrumIndex = 0;
    hits = 0;
    totalStrums = 0;
    strumActive = true;
    highlightStrum();
    strumFeedback.textContent = "Strum practice started. Follow pattern.";
    requestAnimationFrame(checkStrum);
  }

  function checkStrum(){
    if(!strumActive || !analyser) return;
    analyser.getByteTimeDomainData(dataArray);
    // compute RMS-like energy
    let sum = 0;
    for(let i=0;i<dataArray.length;i++){
      const v = (dataArray[i]-128)/128;
      sum += v*v;
    }
    const rms = Math.sqrt(sum / dataArray.length);
    // determine transient
    const threshold = 0.04; // tweak if necessary
    let detected = null;
    if(rms > threshold){
      // crude direction detection: compare energy in first & second half of buffer
      const half = Math.floor(dataArray.length/2);
      let firstSum=0, secondSum=0;
      for(let i=0;i<half;i++){ firstSum += (dataArray[i]-128); }
      for(let i=half;i<dataArray.length;i++){ secondSum += (dataArray[i]-128); }
      // if first > second, assume downstroke (string hits earlier), else upstroke
      detected = (firstSum > secondSum) ? "‚Üì" : "‚Üë";
    }

    if(detected){
      totalStrums++;
      if(detected === currentPattern[currentStrumIndex]){
        hits++;
        highlightStep(currentStrumIndex, true);
        currentStrumIndex++;
        strumFeedback.textContent = "Good!";
      } else {
        highlightStep(currentStrumIndex, false);
        strumFeedback.textContent = `Wrong strum! Detected ${detected} expected ${currentPattern[currentStrumIndex]}`;
      }
      const accuracy = totalStrums > 0 ? Math.round((hits/totalStrums)*100) : 0;
      document.getElementById("dash-strum").textContent = accuracy + "%";
      // update leaderboard doc for current user if signed in
      updateUserStrumAccuracy(accuracy);
      if(currentStrumIndex >= currentPattern.length){
        strumFeedback.textContent = "Pattern completed!";
        strumActive = false;
        return;
      }
      // small debounce to avoid multiple detections from same hit
      setTimeout(()=>{ requestAnimationFrame(checkStrum); }, 350);
    } else {
      requestAnimationFrame(checkStrum);
    }
  }

  function highlightStrum(){
    const highlight = document.getElementById("strum-highlight");
    highlight.innerHTML = currentPattern.map((s,i)=> i===currentStrumIndex ? `<strong style="color:lime">[${s}]</strong>` : s).join(" ");
  }
  function highlightStep(index, correct){
    const highlight = document.getElementById("strum-highlight");
    const parts = currentPattern.map((s,i)=> i===index ? (correct ? `<strong style="color:lime">[${s}]</strong>` : `<strong style="color:#f66">[${s}]</strong>`) : s);
    highlight.innerHTML = parts.join(" ");
    // after a brief delay, refresh to current index
    setTimeout(()=> highlightStrum(), 400);
  }

  async function updateUserStrumAccuracy(accuracy){
    const user = auth.currentUser;
    if(!user) return;
    try{
      const snap = await getDocs(query(collection(db,"leaderboard"), where("email","==", user.email)));
      if(!snap.empty){
        const id = snap.docs[0].id;
        await updateDoc(doc(db,"leaderboard",id), { strumAccuracy: accuracy, lastPlayed: Date.now() });
      }
    }catch(e){}
  }

  // --- Quiz logic ---
  const quizChords = allChords.slice();
  let quizScore = 0;
  let quizCount = 0;
  const quizTotal = 8;
  const quizArea = document.getElementById("quiz-area");
  const quizResult = document.getElementById("quiz-result");
  const quizImage = document.getElementById("quiz-image");
  const quizOptions = document.getElementById("quiz-options");
  const timerEl = document.getElementById("timer");
  let quizTimer;
  let currentQuizChord;

  document.getElementById("start-quiz").addEventListener("click", ()=>{
    quizScore = 0;
    quizCount = 0;
    quizResult.classList.add("hidden");
    quizArea.classList.remove("hidden");
    nextQuizChord();
  });

  function nextQuizChord(){
    if(quizCount >= quizTotal){
      quizArea.classList.add("hidden");
      quizResult.classList.remove("hidden");
      quizResult.textContent = `Quiz Completed! Score: ${quizScore}/${quizTotal}`;
      // store to leaderboard highScore if better
      pushQuizScoreToLeaderboard(quizScore);
      return;
    }
    currentQuizChord = quizChords[Math.floor(Math.random()*quizChords.length)];
    // try to show image from local image folder
    const imgName = chordToFilename(currentQuizChord);
    quizImage.innerHTML = `<img src="image/${imgName}" alt="${currentQuizChord}" style="width:160px" onerror="this.onerror=null;this.style.display='none'"><div style="font-weight:700;color:var(--white)">${currentQuizChord}</div>`;
    quizOptions.innerHTML = "";
    const choices = shuffleArray(quizChords).slice(0,4);
    if(!choices.includes(currentQuizChord)) choices[Math.floor(Math.random()*4)] = currentQuizChord;
    choices.forEach(c=>{
      const btn = document.createElement("button");
      btn.textContent = c;
      btn.addEventListener("click", ()=>{
        if(c===currentQuizChord) quizScore++;
        quizCount++;
        clearInterval(quizTimer);
        nextQuizChord();
      });
      quizOptions.appendChild(btn);
    });
    startQuizTimer();
  }

  function startQuizTimer(){
    let time = 8; // configurable
    timerEl.textContent = time;
    clearInterval(quizTimer);
    quizTimer = setInterval(()=>{
      time--;
      timerEl.textContent = time;
      if(time<=0){
        clearInterval(quizTimer);
        quizCount++;
        nextQuizChord();
      }
    },1000);
  }

  function shuffleArray(array){
    return array.sort(()=>Math.random()-0.5);
  }

  async function pushQuizScoreToLeaderboard(score){
    const user = auth.currentUser;
    if(!user) return;
    try{
      const snap = await getDocs(query(collection(db,"leaderboard"), where("email","==", user.email)));
      if(!snap.empty){
        const id = snap.docs[0].id;
        const docData = snap.docs[0].data();
        const prevHigh = docData.highScore || 0;
        if(score > prevHigh){
          await updateDoc(doc(db,"leaderboard",id), { highScore: score, lastPlayed: Date.now() });
        } else {
          await updateDoc(doc(db,"leaderboard",id), { lastPlayed: Date.now() });
        }
      }
    }catch(e){}
  }

  // --- Metronome with bouncing ball and audio tick ---
  let metroInterval = null;
  let metAudioCtx = null;
  const metBall = document.getElementById("met-ball");
  const metLine = document.getElementById("met-line");

  function startMetronome(){
    const bpm = Math.max(30, Math.min(300, parseInt(document.getElementById("metronome-bpm").value || "80")));
    const division = parseInt(document.getElementById("metronome-division").value || "1");
    const intervalMs = (60000 / bpm) / division;
    let direction = 1;
    let start = null;

    if(metroInterval) clearInterval(metroInterval);
    if(!metAudioCtx) metAudioCtx = new (window.AudioContext || window.webkitAudioContext)();

    metroInterval = setInterval(()=> {
      // bounce animation
      metBall.classList.remove("metronome-bouncing");
      void metBall.offsetWidth;
      metBall.classList.add("metronome-bouncing");
      // play tick
      const o = metAudioCtx.createOscillator();
      const g = metAudioCtx.createGain();
      o.frequency.value = 1000;
      g.gain.value = 0.0001;
      o.connect(g);
      g.connect(metAudioCtx.destination);
      o.start();
      g.gain.exponentialRampToValueAtTime(0.2, metAudioCtx.currentTime + 0.005);
      g.gain.exponentialRampToValueAtTime(0.0001, metAudioCtx.currentTime + 0.12);
      setTimeout(()=>{ o.stop(); }, 150);
      // move ball across line
      animateBallAcross(intervalMs);
    }, intervalMs);
  }

  function animateBallAcross(duration){
    const lineWidth = metLine.clientWidth;
    metBall.style.transition = `left ${duration}ms linear`;
    metBall.style.left = 'calc(100% - 18px)';
    // reset after duration
    setTimeout(()=>{
      metBall.style.transition = 'none';
      metBall.style.left = '0px';
      // small timeout to re-enable transition next tick
      setTimeout(()=>{ metBall.style.transition = ''; }, 20);
    }, duration);
  }

  function stopMetronome(){
    if(metroInterval) clearInterval(metroInterval);
    metroInterval = null;
    if(metAudioCtx && metAudioCtx.state !== "closed"){ /* keep context open for reuse */ }
  }

  document.getElementById("start-metronome").addEventListener("click", startMetronome);
  document.getElementById("stop-metronome").addEventListener("click", stopMetronome);

  // --- Leaderboard functions ---
  async function refreshLeaderboard(){
    const list = document.getElementById("leaderboard-list");
    list.innerHTML = "";
    try{
      const lbCol = collection(db,"leaderboard");
      const q = query(lbCol, orderBy("highScore","desc"), limit(50));
      const snap = await getDocs(q);
      snap.forEach(docSnap=>{
        const d = docSnap.data();
        const el = document.createElement("div");
        el.className = "song";
        el.innerHTML = `<div style="font-weight:700">${d.displayName || d.email}</div>
          <div class="meta">Score: ${d.highScore||0} ‚Ä¢ Streak: ${d.streak||0} ‚Ä¢ Level: ${d.level||'Beginner'}</div>`;
        list.appendChild(el);
      });
    }catch(e){
      console.warn("Leaderboard fetch error", e);
    }
  }

  // --- Admin related actions (CRUD songs) ---
  async function refreshAdminSongs(){
    const list = document.getElementById("admin-song-list");
    list.innerHTML = "";
    try{
      // Here we show songs stored locally in memory first; optionally you can hook to Firestore songs collection.
      songs.forEach((s,i)=>{
        const el = document.createElement("div");
        el.className = "song";
        el.innerHTML = `<div style="font-weight:700">${s.name}</div>
          <div class="meta">Chords: ${s.chords} ‚Ä¢ Pattern: ${s.pattern.join(" ")}</div>
          <div style="margin-top:8px">
            <button class="ghost edit-song" data-i="${i}">Edit</button>
            <button class="ghost delete-song" data-i="${i}">Delete</button>
          </div>`;
        list.appendChild(el);
      });
      // attach handlers
      list.querySelectorAll(".edit-song").forEach(btn=>{
        btn.addEventListener("click", (ev)=>{
          const i = parseInt(ev.currentTarget.dataset.i);
          loadSongToEditor(i);
        });
      });
      list.querySelectorAll(".delete-song").forEach(btn=>{
        btn.addEventListener("click", (ev)=>{
          const i = parseInt(ev.currentTarget.dataset.i);
          if(confirm("Delete this song?")){ songs.splice(i,1); refreshAdminSongs(); renderSongs(); }
        });
      });
    }catch(e){ console.warn(e); }
  }

  function loadSongToEditor(index){
    const s = songs[index];
    document.getElementById("song-name").value = s.name;
    document.getElementById("song-author").value = s.author || "";
    document.getElementById("song-capo").value = s.capo || "";
    document.getElementById("song-chords").value = s.chords || "";
    document.getElementById("song-pattern").value = s.pattern ? s.pattern.join(" ") : "";
  }

  document.getElementById("save-song").addEventListener("click", ()=>{
    const name = document.getElementById("song-name").value.trim();
    const author = document.getElementById("song-author").value.trim();
    const capo = document.getElementById("song-capo").value.trim();
    const chordsVal = document.getElementById("song-chords").value.trim();
    const patternVal = document.getElementById("song-pattern").value.trim();
    if(!name){ alert("Provide a song name."); return; }
    const patternArr = patternVal.split(/\s+/).filter(Boolean);
    // push into songs array
    songs.push({ name, author, capo, chords: chordsVal, pattern: patternArr });
    refreshAdminSongs();
    renderSongs();
    alert("Song added.");
    // clear editor
    document.getElementById("song-name").value = "";
    document.getElementById("song-author").value = "";
    document.getElementById("song-chords").value = "";
    document.getElementById("song-pattern").value = "";
  });

  document.getElementById("bulk-add-btn").addEventListener("click", ()=>{
    const raw = document.getElementById("bulk-add-area").value.trim();
    if(!raw){ alert("Paste songs into the bulk add area first."); return; }
    // try JSON parse
    try{
      const parsed = JSON.parse(raw);
      if(Array.isArray(parsed)){
        parsed.forEach(p=>{
          if(p.name && p.chords){
            p.pattern = typeof p.pattern === "string" ? p.pattern.split(/\s+/).filter(Boolean) : p.pattern || [];
            songs.push(p);
          }
        });
        renderSongs();
        refreshAdminSongs();
        alert("Bulk add succeeded.");
        document.getElementById("bulk-add-area").value = "";
        return;
      }
    }catch(e){}
    // if not JSON, try line-by-line simplified: name | chords | pattern
    const lines = raw.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    lines.forEach(line=>{
      const parts = line.split("|").map(p=>p.trim());
      if(parts.length >= 2){
        const name = parts[0], chords = parts[1], pattern = parts[2] ? parts[2].split(/\s+/).filter(Boolean) : [];
        songs.push({ name, chords, pattern });
      }
    });
    renderSongs();
    refreshAdminSongs();
    alert("Bulk add parsed by lines.");
    document.getElementById("bulk-add-area").value = "";
  });

  document.getElementById("refresh-songs").addEventListener("click", ()=> { renderSongs(); refreshAdminSongs(); });

  document.getElementById("apply-override").addEventListener("click", async ()=>{
    const email = document.getElementById("override-user").value.trim();
    const streak = parseInt(document.getElementById("override-streak").value)||0;
    const level = document.getElementById("override-level").value || "Beginner";
    const highScore = parseInt(document.getElementById("override-highscore").value)||0;
    if(!email){ alert("Enter an email to override."); return; }
    try{
      const lbCol = collection(db,"leaderboard");
      const snap = await getDocs(query(lbCol, where("email","==", email)));
      if(!snap.empty){
        const id = snap.docs[0].id;
        await updateDoc(doc(db,"leaderboard",id), { streak, level, highScore, lastPlayed: Date.now() });
        alert("User updated successfully!");
      } else {
        await setDoc(doc(db,"leaderboard",email), {
          displayName: email.split("@")[0],
          email,
          streak,
          level,
          highScore,
          lastPlayed: Date.now(),
          badges: []
        });
        alert("New user created and updated!");
      }
    }catch(e){ alert("Error updating user: " + e.message); }
  });

  document.getElementById("admin-logout").addEventListener("click", async ()=>{
    await signOut(auth);
    adminPanel.classList.add("hidden");
    alert("Admin signed out.");
  });

  document.getElementById("refresh-songs").addEventListener("click", refreshAdminSongs);

  // initial populate
  populateChordGrid();
  refreshAdminSongs();

  // show the default login screen
  showPanel(loginScreen);

  // Leaderboard quick open via admin controls
  // Add a menu item to open leaderboard
  const lbButton = document.createElement("button");
  lbButton.textContent = "Leaderboard";
  lbButton.className = "ghost";
  lbButton.addEventListener("click", ()=>{
    refreshLeaderboard();
    showPanel(leaderboardPanel);
  });
  document.querySelector(".controls").appendChild(lbButton);

  // Small helper: keep some heading text white even in light mode
  document.querySelectorAll(".force-white").forEach(n=> n.style.color = "var(--white)");

  // expose some vars for debugging in console
  window.GH = {
    songs, populateChordGrid, refreshAdminSongs, refreshLeaderboard, showPanel
  };

  // small safety: stop mic on page unload
  window.addEventListener("beforeunload", ()=> { try{ if(sourceStream && sourceStream.mediaStream) sourceStream.mediaStream.getTracks().forEach(t=>t.stop()); }catch(e){} });

</script>
</body>
</html>
